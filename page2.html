<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èª AI ç™¾å¯¶ç®± - Chinese Learning AI Toolbox</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #aaa; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { 
            Menu, X, Home, FileText, Repeat, MessageCircle, 
            Settings, User, ChevronRight, Share, Download, 
            Zap, BookOpen, BarChart2, Headphones, Sparkles,
            Smile, Coffee, MapPin, ShoppingBag, Briefcase, 
            Activity, Music, Gift, Heart, Grid, Code, AlertCircle,
            Play, Pause, Mic, Image as ImageIcon, ArrowRight,
            CheckCircle, XCircle, HelpCircle, Lightbulb, 
            Send, Bot, Key, Save, Eye, EyeOff
        } from 'https://esm.sh/lucide-react@0.263.1';

        const { useState, useEffect, useRef } = React;

        // --- Configuration Data ---
        const THEMES = [
            { id: 1, name: "æ—¥å¸¸ç”Ÿæ´»", icon: <Smile size={18} />, scenarios: ["æ‰“æ‹›å‘¼", "æ™‚é–“", "å¤©æ°£", "è²·æ±è¥¿", "çœ‹é†«ç”Ÿ", "ç†é«®", "æ‰¾æœ‹å‹"] },
            { id: 2, name: "é£²é£Ÿæ–‡åŒ–", icon: <Coffee size={18} />, scenarios: ["é»é¤", "æ¨è–¦ç¾é£Ÿ", "åƒç«é‹", "åŒ…é¤ƒå­", "é£Ÿæä»‹ç´¹", "èœå–®è©¢å•", "ç”¨é¤ç¦®å„€"] },
            { id: 3, name: "äº¤é€šå‡ºè¡Œ", icon: <MapPin size={18} />, scenarios: ["å•è·¯", "æ­å…¬è»Š", "è²·ç¥¨", "è¨‚æˆ¿", "éæµ·é—œ", "ç§Ÿè»Š", "é²åˆ°é“æ­‰"] },
            { id: 4, name: "è³¼ç‰©æ¶ˆè²»", icon: <ShoppingBag size={18} />, scenarios: ["è©¢åƒ¹", "æŠ˜æ‰£", "é€€è²¨", "ç·šä¸Šè³¼ç‰©", "é›»å­æ”¯ä»˜", "è©¦ç©¿è¡£æœ", "è´ˆç¦®"] },
            { id: 5, name: "å·¥ä½œè·å ´", icon: <Briefcase size={18} />, scenarios: ["é¢è©¦", "è‡ªæˆ‘ä»‹ç´¹", "é–‹æœƒ", "ææ¡ˆ", "é›»è©±", "å ±å‘Š", "è«‹å‡"] },
            { id: 6, name: "é†«ç™‚ä¿å¥", icon: <Activity size={18} />, scenarios: ["æ›è™Ÿ", "å•è¨º", "æ‹¿è—¥", "èº«é«”ç‹€æ³", "é‹å‹•å»ºè­°", "é é˜²ä¿å¥", "å¿ƒç†è«®è©¢"] },
            { id: 7, name: "ä¼‘é–’å¨›æ¨‚", icon: <Music size={18} />, scenarios: ["çœ‹é›»å½±", "å”±æ­Œ", "æ—…éŠ", "æ‰“çƒ", "ç©éŠæˆ²", "èˆˆè¶£ä»‹ç´¹", "é€±æœ«è¨ˆç•«"] },
            { id: 8, name: "ç¯€æ…¶æ´»å‹•", icon: <Gift size={18} />, scenarios: ["æ˜¥ç¯€", "ä¸­ç§‹", "ç«¯åˆ", "è–èª•", "ç”Ÿæ—¥", "å©šç¦®", "è·¨å¹´"] },
            { id: 9, name: "ç¤¾äº¤äº’å‹•", icon: <Heart size={18} />, scenarios: ["èŠå¤©", "é‚€ç´„", "é€ç¦®", "è®šç¾", "æ‹’çµ•", "é“æ­‰", "æ„Ÿè¬"] },
            { id: 10, name: "å…¶ä»–è‡ªè¨‚", icon: <Grid size={18} />, scenarios: ["è‡ªè¨‚æƒ…å¢ƒ"] },
        ];

        const SCENARIO_IMAGES = [
            { id: 'night_market', emoji: 'ğŸœ', label: 'å¤œå¸‚æƒ…å¢ƒ (æ®ºåƒ¹)' },
            { id: 'mrt_station', emoji: 'ğŸš‡', label: 'æ·é‹ç«™ (å•è·¯)' },
            { id: 'hospital_counter', emoji: 'ğŸ¥', label: 'é†«é™¢æ«ƒæª¯ (æ›è™Ÿ)' },
            { id: 'office_meeting', emoji: 'ğŸ’¼', label: 'è¾¦å…¬å®¤æœƒè­° (ææ¡ˆ)' },
            { id: 'immigration', emoji: 'ğŸ›‚', label: 'ç§»æ°‘ç½²è¾¦ç†å±…ç•™è­‰' },
            { id: 'bank_counter', emoji: 'ğŸ¦', label: 'éŠ€è¡Œæ«ƒæª¯é–‹æˆ¶' },
            { id: 'convenience_store', emoji: 'ğŸ“¦', label: 'ä¾¿åˆ©å•†åº—å•åŒ…è£¹' },
            { id: 'school_admin', emoji: 'ğŸ«', label: 'æ ¡åœ’è¡Œæ”¿è™•è©¢å•å­¸è²»' },
        ];

        const LEVELS = ["A1", "A2", "B1", "B2", "C1", "C2", "C6 (ç²¾é€š)"];
        const MODES = [
            { id: "scenario", name: "æƒ…å¢ƒæ•˜è¿°å¥å‹", desc: "æè¿°ç•¶ä¸‹ç™¼ç”Ÿçš„æƒ…æ³" },
            { id: "experience", name: "ç¶“é©—åˆ†äº«å¥å‹", desc: "è¬›è¿°éå»çš„ç¶“é©—èˆ‡æ„Ÿå—" },
            { id: "advice", name: "å¯¦ç”¨å»ºè­°å¥å‹", desc: "æä¾›å»ºè­°æˆ–è§£æ±ºæ–¹æ¡ˆ" },
            { id: "analysis", name: "æ·±åº¦åˆ†æå¥å‹", desc: "é‡å°ç¾è±¡é€²è¡Œé‚è¼¯åˆ†æ" }
        ];

        const REWRITE_OPTIONS = [
            { id: "simplify", name: "é™ç´š (æ›´ç°¡å–®)", desc: "é©åˆåˆå­¸è€…ï¼Œä½¿ç”¨åŸºç¤è©å½™" },
            { id: "upgrade", name: "å‡ç´š (æ›´æ·±å¥§)", desc: "å¢åŠ æˆèªèˆ‡è¤‡é›œå¥æ§‹" },
            { id: "formal", name: "æ›´æ­£å¼ (å•†å‹™/å­¸è¡“)", desc: "é©åˆè·å ´èˆ‡æ›¸é¢å ±å‘Š" },
            { id: "casual", name: "æ›´å£èª (ç”Ÿæ´»åŒ–)", desc: "åƒæœ‹å‹èŠå¤©ä¸€æ¨£è‡ªç„¶" }
        ];

        const QA_TYPES = [
            { id: "reading", name: "é–±è®€æ¸¬é©— (äº’å‹•å¼)", icon: <BookOpen size={16}/> },
            { id: "discussion", name: "è¨è«–è­°é¡Œ (å«å¼•å°)", icon: <MessageCircle size={16}/> },
            { id: "vocab", name: "é‡é»å–®å­— (å¡ç‰‡)", icon: <Zap size={16}/> }
        ];

        // --- Utility Functions ---
        const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];

        // --- Prompt Generators (Unchanged) ---
        const generatePrompt = (theme, scenario, level, mode) => {
            return `
# Role
ä½ æ˜¯ä¸€ä½é ‚å°–çš„ã€Œè¯èªæ•™å­¸å°ˆå®¶ã€å…¼ã€Œå‰µæ„å¯«ä½œå°å¸«ã€ã€‚

# Task
è«‹æ ¹æ“šä»¥ä¸‹è®Šæ•¸ï¼Œå‰µä½œä¸€ç¯‡**æ¥µå…·ç”Ÿæ´»æ„Ÿ**ã€**å£èªè‡ªç„¶**ä¸”ç¬¦åˆèªè¨€ç­‰ç´šçš„è¯èªå­¸ç¿’æ–‡æœ¬ã€‚

# Input Variables
- ä¸»é¡Œ: ${theme}
- æƒ…å¢ƒ: ${scenario}
- èªè¨€ç­‰ç´š: ${level}
- å¥å‹æ¨¡å¼: ${mode}

# Style Guidelines
1. **æ‹’çµ•åƒµåŒ–**: åš´ç¦ä½¿ç”¨ã€Œæ©Ÿå™¨äººèˆ¬ã€çš„èªæ°£ã€‚æ–‡æœ¬å¿…é ˆæµæš¢ã€æœ‰å½ˆæ€§ã€‚
2. **ç”Ÿæ´»åŒ–ç´°ç¯€**: åŠ å…¥å…·é«”çš„æ„Ÿå®˜ç´°ç¯€ï¼Œè®“å ´æ™¯ã€Œæ´»ã€èµ·ä¾†ã€‚
3. **èªæ°£è©é‹ç”¨**: æ ¹æ“šç­‰ç´šé©ç•¶åŠ å…¥èªæ°£è©ï¼ˆå¦‚ï¼šå§ã€å‘¢ã€å–”ï¼‰ï¼Œå¢åŠ è‡ªç„¶åº¦ã€‚

# Output Format (JSON Only)
{
  "content": "ç”Ÿæˆçš„æ–‡æœ¬å…§å®¹...",
  "stats": {
    "words": æ•¸å­—,
    "sentences": æ•¸å­—,
    "vocabLevel": "è©•ä¼°ç­‰ç´š",
    "reasoning": "ç°¡çŸ­èªªæ˜"
  }
}
            `.trim();
        };

        const generateRewritePrompt = (originalText, rewriteType) => {
            return `
# Role
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è¯èªç·¨è¼¯èˆ‡èªè¨€å­¸å®¶ã€‚

# Task
è«‹å°‡ä»¥ä¸‹æ–‡æœ¬é€²è¡Œã€Œ${rewriteType}ã€æ”¹å¯«ï¼Œä¸¦æä¾›æ”¹å¯«åˆ†æã€‚

# Original Text
"${originalText}"

# Rewrite Rules (${rewriteType})
- è‹¥ç‚ºã€Œé™ç´šã€: ä½¿ç”¨æ›´ç°¡å–®çš„è©å½™ (A1/A2)ï¼Œç¸®çŸ­å¥å­ã€‚
- è‹¥ç‚ºã€Œå‡ç´šã€: åŠ å…¥æˆèªã€å„ªç¾ä¿®è¾­èˆ‡è¤‡é›œå¥å‹ã€‚
- è‹¥ç‚ºã€Œæ›´æ­£å¼ã€: ä½¿ç”¨æ›¸é¢èªï¼Œé¿å…å£èªè´…å­—ã€‚
- è‹¥ç‚ºã€Œæ›´å£èªã€: åŠ å…¥å°ç£ç”Ÿæ´»ç”¨èªã€èªæ°£è©ï¼Œä½¿å…¶åƒçœŸäººå°è©±ã€‚

# Output Format (JSON Only)
{
  "content": "æ”¹å¯«å¾Œçš„å®Œæ•´æ–‡æœ¬...",
  "analysis": {
    "summary": "ä¸€æ®µè©±ç¸½çµé€™æ¬¡æ”¹å¯«çš„ä¸»è¦ç­–ç•¥",
    "key_changes": [
      { "type": "è©å½™æ›¿æ›", "original": "èˆŠè©", "new": "æ–°è©", "reason": "æ›´ç¬¦åˆç›®æ¨™é›£åº¦" },
      { "type": "å¥å‹èª¿æ•´", "desc": "ç°¡çŸ­èªªæ˜å¥æ§‹è®ŠåŒ–" }
    ]
  }
}
            `.trim();
        };

        const generateQAPrompt = (text, type) => {
            return `
# Role
ä½ æ˜¯ä¸€ä½è³‡æ·±è¯èªæ•™å¸«ã€‚

# Task
è«‹æ ¹æ“šä»¥ä¸‹æ–‡æœ¬ï¼Œè¨­è¨ˆé«˜å“è³ªçš„ã€Œ${type}ã€æ•™å­¸å…§å®¹ã€‚

# Text Context
"${text}"

# Requirements
- è‹¥ç‚ºã€Œé–±è®€æ¸¬é©—ã€: å‡º 3 é¡Œé¸æ“‡é¡Œï¼Œæ¯é¡Œéœ€é™„æ­£ç¢ºç­”æ¡ˆèˆ‡**è©³ç´°è§£æ**ã€‚
- è‹¥ç‚ºã€Œè¨è«–è­°é¡Œã€: å‡º 2 é¡Œé–‹æ”¾å¼å•é¡Œï¼Œä¸¦æä¾›**åƒè€ƒå›ç­”æ–¹å‘**ï¼ˆçµ¦è€å¸«çœ‹çš„å¼•å°ï¼‰ã€‚
- è‹¥ç‚ºã€Œé‡é»å–®å­—ã€: åˆ—å‡º 5 å€‹é›£è©ï¼Œé™„æ‹¼éŸ³ã€è§£é‡‹ã€è©æ€§èˆ‡**ä¾‹å¥**ã€‚

# Output Format (JSON Only)
{
  "items": [
    { "question": "é¡Œç›®", "options": ["A", "B", "C"], "correctIndex": 0, "explanation": "ç‚ºä»€éº¼é¸é€™å€‹ç­”æ¡ˆ" },
    { "question": "è¨è«–é¡Œç›®", "guide": "è€å¸«å¯ä»¥å¼•å°å­¸ç”Ÿæ€è€ƒçš„æ–¹å‘..." },
    { "word": "å–®å­—", "pinyin": "pÄ«n yÄ«n", "partOfSpeech": "å‹•è©", "definition": "è§£é‡‹", "example": "ä¾‹å¥" }
  ]
}
            `.trim();
        };

        const generateTutorPrompt = (text, query) => {
            return `
# Role
ä½ æ˜¯ä¸€ä½è¦ªåˆ‡ã€æœ‰è€å¿ƒä¸”çŸ¥è­˜æ·µåšçš„ã€ŒAI è¯èªåŠ©æ•™ã€ã€‚ä½ çš„ç›®æ¨™æ˜¯å¹«åŠ©å­¸ç”Ÿç†è§£æ–‡æœ¬ã€å­¸ç¿’èªæ³•ï¼Œä¸¦æä¾›é¼“å‹µã€‚

# Context (Current Text)
"${text}"

# User Query
"${query}"

# Guidelines
1. **ç›´æ¥å›ç­”**: é‡å°ä½¿ç”¨è€…çš„å•é¡Œç›´æ¥å›ç­”ï¼Œä¸è¦ç¹åœˆå­ã€‚
2. **çµåˆæ–‡æœ¬**: ç›¡é‡å¼•ç”¨ä¸Šæ–¹çš„ Context æ–‡æœ¬ä¾†èˆ‰ä¾‹ã€‚
3. **æ•™å­¸èªæ°£**: ä½¿ç”¨é¼“å‹µæ€§çš„èªæ°£ (ä¾‹å¦‚ï¼šã€Œé€™å€‹å•é¡Œå¾ˆæ£’ï¼ã€ã€ã€Œä½ è§€å¯Ÿå¾—å¾ˆä»”ç´°ï¼ã€)ã€‚
4. **ç¹é«”ä¸­æ–‡**: è«‹ä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡å›ç­”ã€‚

# Output
è«‹ç›´æ¥è¼¸å‡ºå›ç­”å…§å®¹ (Plain Text)ï¼Œå¯ä»¥é©ç•¶ä½¿ç”¨ Markdown (å¦‚ç²—é«”) ä¾†å¼·èª¿é‡é»ã€‚
`.trim();
        };

        // --- API & Mock Functions (Unchanged) ---
        const callGeminiAPI = async (prompt, userKey) => {
            if (!userKey) return null;
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        }),
                    }
                );
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return null;
            }
        };

        const callGeminiChatAPI = async (prompt, userKey) => {
            if (!userKey) return null;
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        }),
                    }
                );
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (error) {
                console.error("Gemini Chat API failed:", error);
                return null;
            }
        };

        // --- Mock Data (Enhanced Multimodal) ---
        
        // Mock data mapping for Image-to-Text
        const MOCK_IMAGE_RESPONSES = {
            'å¤œå¸‚æƒ…å¢ƒ (æ®ºåƒ¹)': {
                title: 'å¤œå¸‚æ®ºåƒ¹èˆ‡äººéš›äº’å‹•',
                lesson: 'åœ¨å°ç£å¤œå¸‚ï¼Œæ®ºåƒ¹æ˜¯å¾ˆå¸¸è¦‹çš„ï¼ä¸éé€šå¸¸åªèƒ½å¾å°æ”¤è²©é–‹å§‹ï¼Œè€Œä¸”è¦è¨˜å¾—ä½¿ç”¨ã€Œè«‹å•å¯ä»¥ä¾¿å®œä¸€é»å—ï¼Ÿã€ã€ã€Œç®—æˆ‘å…©å€‹ï¼Œæ‹œè¨—å•¦ï¼ã€ç­‰å®¢æ°£èªæ°£ã€‚å¦‚æœå°æ–¹æ˜¯é€£é–åº—ï¼Œå°±ä¸è¦å˜—è©¦æ®ºåƒ¹å›‰ã€‚',
                keywords: ['æ®ºåƒ¹', 'å¤œå¸‚', 'å¤šå°‘éŒ¢', 'ä¾¿å®œ', 'æ”¤è²©'],
            },
            'æ·é‹ç«™ (å•è·¯)': {
                title: 'æ·é‹ç«™å•è·¯èˆ‡äº¤é€šæŒ‡å¼•',
                lesson: 'åœ¨æ·é‹ç«™è©¢å•è·¯ç·šæ™‚ï¼Œå¯ä»¥èªªã€Œè«‹å•ï¼Œæˆ‘è¦å»å°åŒ—è»Šç«™ï¼Œè«‹å•åœ¨å“ªè£¡è½‰è»Šæ¯”è¼ƒå¿«ï¼Ÿã€æˆ–ã€Œè«‹å•ï¼Œé€™ç­è»Šæ˜¯å¾€æ·¡æ°´çš„å—ï¼Ÿã€ã€‚è¨˜å¾—ä¿æŒç¦®è²Œï¼Œä¸¦ç¢ºèªç›®çš„åœ°ç«™åã€‚',
                keywords: ['æ·é‹', 'è½‰è»Š', 'è·¯ç·š', 'ç«™ç‰Œ', 'å•è·¯'],
            },
            'é†«é™¢æ«ƒæª¯ (æ›è™Ÿ)': {
                title: 'é†«é™¢æ›è™Ÿå’Œåˆæ¬¡å°±è¨ºæµç¨‹',
                lesson: 'ç¬¬ä¸€æ¬¡ä¾†é†«é™¢ï¼Œè«‹å…ˆåˆ°æ«ƒæª¯æ›è™Ÿã€‚æ‚¨å¯ä»¥èªªï¼šã€Œæˆ‘è¦æ›è™Ÿï¼Œè«‹å•è¦çœ‹çš®è†šç§‘ã€‚ã€æˆ–è€…ã€Œæˆ‘æ²’æœ‰å¥ä¿å¡ï¼Œè«‹å•å¯ä»¥è‡ªè²»çœ‹è¨ºå—ï¼Ÿã€é†«é™¢æœƒè«‹æ‚¨å¡«å¯«åŸºæœ¬è³‡æ–™ã€‚',
                keywords: ['æ›è™Ÿ', 'å°±è¨º', 'å¥ä¿å¡', 'è‡ªè²»', 'æ«ƒæª¯'],
            },
            'è¾¦å…¬å®¤æœƒè­° (ææ¡ˆ)': {
                title: 'è¾¦å…¬å®¤ææ¡ˆèˆ‡ç°¡å ±æŠ€å·§',
                lesson: 'åœ¨è¾¦å…¬å®¤æœƒè­°ä¸­æå‡ºæ–°æ–¹æ¡ˆæ™‚ï¼Œæ‡‰ä½¿ç”¨æ­£å¼èªæ°£ï¼šã€Œé‡å°é€™é …å°ˆæ¡ˆï¼Œæˆ‘å»ºè­°æ¡ç”¨æ–°ç­–ç•¥ã€‚ä»¥ä¸‹æ˜¯æˆ‘çš„ææ¡ˆç°¡å ±ï¼Œè«‹å„ä½æŒ‡æ•™ã€‚ã€èªæ°£è¦è‡ªä¿¡ä¸”å°ˆæ¥­ã€‚',
                keywords: ['ææ¡ˆ', 'å°ˆæ¡ˆ', 'ç°¡å ±', 'ç­–ç•¥', 'æŒ‡æ•™'],
            },
            'ç§»æ°‘ç½²è¾¦ç†å±…ç•™è­‰': {
                title: 'ç§»æ°‘ç½²å±…ç•™è­‰è¾¦ç†æµç¨‹',
                lesson: 'åœ¨ç§»æ°‘ç½²è¾¦ç†å±…ç•™è­‰éœ€è¦è€å¿ƒç­‰å€™ã€‚æ‚¨å¯ä»¥è©¢å•ï¼šã€Œè«‹å•è¾¦ç†å±…ç•™è­‰éœ€è¦å¸¶å“ªäº›æ–‡ä»¶ï¼Ÿæˆ‘ä»Šå¤©å¯ä»¥æ‹¿åˆ°è™Ÿç¢¼ç‰Œå—ï¼Ÿã€è¨˜å¾—æª¢æŸ¥æ‰€æœ‰æ–‡ä»¶çš„æœ‰æ•ˆæœŸé™ã€‚',
                keywords: ['å±…ç•™è­‰', 'è¾¦ç†', 'æ–‡ä»¶', 'è™Ÿç¢¼ç‰Œ', 'æœŸé™'],
            },
            'éŠ€è¡Œæ«ƒæª¯é–‹æˆ¶': {
                title: 'éŠ€è¡Œé–‹æˆ¶æµç¨‹èˆ‡å°è©±',
                lesson: 'åˆ°éŠ€è¡Œé–‹æˆ¶æ™‚ï¼Œå¯ä»¥ç›´æ¥å°æ«ƒæª¯äººå“¡èªªï¼šã€Œä½ å¥½ï¼Œæˆ‘æƒ³è¦é–‹ä¸€å€‹æ´»æœŸå„²è“„å¸³æˆ¶ã€‚ã€éŠ€è¡Œäººå“¡å¯èƒ½æœƒå•æ‚¨é–‹æˆ¶çš„ç”¨é€”å’Œæ˜¯å¦éœ€è¦ç”³è«‹ææ¬¾å¡ã€‚',
                keywords: ['é–‹æˆ¶', 'å¸³æˆ¶', 'æ«ƒæª¯', 'ææ¬¾å¡', 'ç”¨é€”'],
            },
            'ä¾¿åˆ©å•†åº—å•åŒ…è£¹': {
                title: 'ä¾¿åˆ©å•†åº—åŒ…è£¹é ˜å–èˆ‡è©¢å•',
                lesson: 'åœ¨ä¾¿åˆ©å•†åº—é ˜å–åŒ…è£¹æ™‚ï¼Œæ‚¨å¯ä»¥è©¢å•ï¼šã€Œè«‹å•æœ‰æˆ‘çš„åŒ…è£¹å—ï¼Ÿæˆ‘çš„åå­—æ˜¯ç‹å°æ˜ã€‚ã€åº—å“¡é€šå¸¸æœƒè¦æ±‚æ‚¨å‡ºç¤ºèº«ä»½è­‰ä»¶ï¼Œç„¶å¾Œå ±ä¸Šé›»è©±æœ«ä¸‰ç¢¼ã€‚',
                keywords: ['åŒ…è£¹', 'é ˜å–', 'èº«ä»½è­‰ä»¶', 'åº—å“¡', 'æœ«ä¸‰ç¢¼'],
            },
            'æ ¡åœ’è¡Œæ”¿è™•è©¢å•å­¸è²»': {
                title: 'æ ¡åœ’è¡Œæ”¿è™•è©¢å•å­¸è²»èˆ‡è¨»å†Š',
                lesson: 'å­¸ç”Ÿåˆ°è¡Œæ”¿è™•è©¢å•å­¸è²»æ™‚ï¼Œèªæ°£æ‡‰è©²ç¦®è²Œï¼šã€Œè€å¸«æ‚¨å¥½ï¼Œè«‹å•é€™å€‹å­¸æœŸçš„å­¸è²»ç¹³è²»æœŸé™æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿæˆ‘å¯ä»¥åœ¨ç·šä¸Šç¹³è²»å—ï¼Ÿã€ç¢ºä¿ç¹³è²»è³‡è¨Šçš„æ­£ç¢ºæ€§ã€‚',
                keywords: ['å­¸è²»', 'ç¹³è²»', 'è¡Œæ”¿è™•', 'æœŸé™', 'è¨»å†Š'],
            },
        };
        
        const generateMockContent = (theme, scenario, level, mode) => ({
            content: `(é«”é©—ç‰ˆæ¨¡å¼ - ${level}) é—œæ–¼ã€Œ${theme}-${scenario}ã€ï¼Œå¦‚æœæ˜¯ ${level} ç­‰ç´šï¼Œæˆ‘å€‘æœƒé€™æ¨£æè¿°ï¼šé€™æ˜¯ä¸€å€‹éå¸¸å…¸å‹çš„å ´æ™¯ã€‚åœ¨å°ç£ï¼Œäººå€‘é€šå¸¸æœƒéå¸¸æœ‰ç¦®è²Œåœ°é€²è¡Œäº’å‹•ã€‚ä¾‹å¦‚ï¼Œç•¶ä½ éœ€è¦å¹«åŠ©æ™‚ï¼Œå¯ä»¥å…ˆèªªã€Œä¸å¥½æ„æ€ã€ã€‚(ç›®å‰ç‚ºé«”é©—ç‰ˆï¼Œé»æ“Šå³ä¸Šæ–¹ã€Œè¨­å®šã€å¯åˆ‡æ›ç‚ºæ­£å¼ç‰ˆï¼Œé«”é©—çœŸå¯¦ AI åŠŸèƒ½ã€‚)`,
            stats: {
                words: Math.floor(Math.random() * 100) + 50,
                sentences: Math.floor(Math.random() * 5) + 3,
                time: (Math.random() * 2 + 0.5).toFixed(1),
                vocabLevel: level,
                reasoning: "æ­¤ç‚ºé«”é©—ç‰ˆæ¨¡æ“¬æ•¸æ“šï¼Œè‹¥è¦ä½¿ç”¨ç„¡é™ã€å³æ™‚ç”Ÿæˆçš„å…§å®¹ï¼Œè«‹å‡ç´šåˆ°æ­£å¼ç‰ˆã€‚"
            }
        });

        const generateMockRewrite = (original, type) => ({
            content: `(é«”é©—ç‰ˆæ”¹å¯« - ${type}) é€™æ˜¯é‡å°ã€Œ${type}ã€é¢¨æ ¼é€²è¡Œèª¿æ•´å¾Œçš„æ–‡å­—... (ç›®å‰ç‚ºé«”é©—ç‰ˆï¼Œé»æ“Šå³ä¸Šæ–¹ã€Œè¨­å®šã€å¯åˆ‡æ›ç‚ºæ­£å¼ç‰ˆï¼Œé«”é©—çœŸå¯¦ AI æ”¹å¯«åŠŸèƒ½ã€‚)`,
            analysis: {
                summary: `é‡å° ${type} éœ€æ±‚ï¼Œä¸»è¦èª¿æ•´äº†è©å½™é›£åº¦èˆ‡å¥å‹é•·åº¦ã€‚`,
                key_changes: [
                    { type: "ç‰ˆæœ¬é™åˆ¶", desc: "ç›®å‰ä½¿ç”¨é«”é©—ç‰ˆæ¨¡æ“¬æ•¸æ“šï¼Œè«‹åœ¨è¨­å®šé å¡«å…¥ Key å‡ç´šæ­£å¼ç‰ˆ" }
                ]
            }
        });

        const generateMockQA = (type) => ({
            items: type === "reading" ? [
                { question: "é€™æ˜¯ä¸€ä»½æ¨¡æ“¬è©¦é¡Œå—ï¼Ÿ", options: ["æ˜¯çš„", "ä¸æ˜¯", "ä¸ç¢ºå®š"], correctIndex: 0, explanation: "ç›®å‰ç‚ºé«”é©—ç‰ˆæ¨¡å¼ã€‚" },
                { question: "é€™ç¯‡æ–‡ç« é©åˆä»€éº¼æ¨£çš„è®€è€…ï¼Ÿ", options: ["è¯èªåˆå­¸è€…", "èªè¨€å­¸å®¶", "æ•¸å­¸å®¶"], correctIndex: 0, explanation: "æ–‡ç« å…§å®¹æ¶‰åŠåŸºç¤ç¤¾äº¤ç¦®å„€ï¼Œé©åˆåˆå­¸è€…é–±è®€ã€‚" }
            ] : type === "discussion" ? [
                { question: "è«‹ç¢ºèªæ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºè¨­å®šï¼Ÿ", guide: "è‹¥ç„¡ Keyï¼Œç³»çµ±åƒ…èƒ½æä¾›æ­¤æ¨¡æ“¬ç¯„æœ¬ã€‚" }
            ] : [
                { word: "æ¨¡æ“¬", pinyin: "mÃ³ nÇ", partOfSpeech: "å‹•è©", definition: "æ¨¡ä»¿å¯¦éš›æƒ…æ³", example: "é€™æ˜¯æ¨¡æ“¬çš„æ•¸æ“šã€‚" },
                { word: "å…¸å‹", pinyin: "diÇn xÃ­ng", partOfSpeech: "å½¢å®¹è©", definition: "å…·æœ‰ä»£è¡¨æ€§çš„", example: "é€™æ˜¯ä¸€å€‹å…¸å‹çš„å°ç£å¤œå¸‚å°åƒã€‚" }
            ]
        });

        const generateMockTutorResponse = (query) => {
            return `(é«”é©—ç‰ˆåŠ©æ•™å›æ‡‰) é‡å°ä½ å•çš„ã€Œ${query}ã€... (ç›®å‰ç‚ºé«”é©—ç‰ˆï¼Œå›ç­”å…§å®¹å—é™ã€‚è«‹å‡ç´šåˆ°æ­£å¼ç‰ˆä»¥ç²å¾—çœŸå¯¦ AI è¼”å°ã€‚)`;
        };
        
        const generateMockImageToText = (scenarioLabel) => {
            const level = getRandom(LEVELS.filter(l => l !== 'C6 (ç²¾é€š)'));
            const data = MOCK_IMAGE_RESPONSES[scenarioLabel] || MOCK_IMAGE_RESPONSES['æ·é‹ç«™ (å•è·¯)']; // Default fallback
            
            return {
                title: data.title,
                lesson: `${data.lesson} (æ­¤ç‚º ${level} ç´šç¯„æœ¬ã€‚è«‹æ³¨æ„ï¼šå…§å®¹è²¼è¿‘ç”Ÿæ´»ï¼Œå¥å‹çµæ§‹ç¬¦åˆè©²ç­‰ç´šè¦æ±‚ã€‚)`,
                keywords: data.keywords,
                vocabLevel: level,
                reasoning: `æ­¤ç‚ºé«”é©—ç‰ˆè¦–è¦ºå­¸ç¿’æ¨¡æ“¬ï¼Œé»æ“Šæ—é‚Šçš„èªéŸ³æ’­æ”¾å¯ä»¥è½è½çœ‹ï¼`
            };
        };


        // --- Components ---
        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey, currentMode }) => {
            const [inputKey, setInputKey] = useState(apiKey);
            const [showKey, setShowKey] = useState(false);
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => { setInputKey(apiKey); }, [apiKey]);
            
            const handleSave = () => { 
                setIsSaving(true);
                // æ¨¡æ“¬å„²å­˜æ™‚é–“
                setTimeout(() => {
                    setApiKey(inputKey); 
                    localStorage.setItem('gemini_api_key', inputKey); 
                    setIsSaving(false);
                    onClose(); 
                }, 500);
            };

            const handleClear = () => {
                setApiKey('');
                localStorage.removeItem('gemini_api_key');
                setInputKey('');
            }

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all scale-100">
                        <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                            <div className="flex items-center space-x-2 text-gray-800"><div className="p-2 bg-purple-100 rounded-lg text-purple-600"><Settings size={20}/></div><h2 className="text-xl font-bold">ç‰ˆæœ¬èˆ‡ API è¨­å®š</h2></div>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition"><X size={24}/></button>
                        </div>

                        {/* Current Mode Indicator in Modal */}
                         <div className={`p-3 rounded-lg text-sm font-semibold mb-4 flex items-center justify-between ${currentMode === 'Official' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-yellow-50 text-yellow-700 border border-yellow-200'}`}>
                            <span className="flex items-center">
                                {currentMode === 'Official' ? <CheckCircle size={18} className="mr-2"/> : <AlertCircle size={18} className="mr-2"/>}
                                ç›®å‰æ¨¡å¼ï¼š{currentMode === 'Official' ? 'æ­£å¼ç‰ˆ (å®Œæ•´åŠŸèƒ½)' : 'é«”é©—ç‰ˆ (æ¨¡æ“¬æ¨¡å¼)'}
                            </span>
                            {currentMode === 'Official' && <button onClick={handleClear} className="text-xs font-normal text-red-500 hover:underline">åˆ‡æ›ç‚ºé«”é©—ç‰ˆ</button>}
                         </div>

                        <div className="space-y-4 mb-6">
                            <div className="border-t pt-4">
                                <label className="block text-sm font-bold text-gray-700 mb-2">Google Gemini API Key (æ­£å¼ç‰ˆ)</label>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Key size={18} /></div>
                                    <input type={showKey ? "text" : "password"} value={inputKey} onChange={(e) => setInputKey(e.target.value)} placeholder="AIzaSy..." className="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-200 focus:border-purple-400 transition"/>
                                    <button onClick={() => setShowKey(!showKey)} className="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">{showKey ? <EyeOff size={18} /> : <Eye size={18} />}</button>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">
                                    å¡«å…¥æœ‰æ•ˆçš„ Key å³å¯è‡ªå‹•å‡ç´šç‚ºæ­£å¼ç‰ˆï¼Œé«”é©—çœŸå¯¦ AI ç”Ÿæˆå…§å®¹ã€‚
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noreferrer" className="text-blue-600 hover:underline ml-1">å–å¾— API Key</a>
                                </p>
                            </div>
                        </div>

                        <div className="flex justify-end space-x-3">
                            <button onClick={onClose} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition" disabled={isSaving}>å–æ¶ˆ</button>
                            <button onClick={handleSave} className="px-6 py-2 bg-[#006699] text-white font-bold rounded-lg hover:bg-blue-700 transition flex items-center shadow-md disabled:opacity-50" disabled={isSaving || !inputKey.trim()}>
                                {isSaving ? <Repeat size={18} className="mr-2 animate-spin"/> : <Save size={18} className="mr-2"/>} 
                                {isSaving ? 'å„²å­˜ä¸­...' : 'å„²å­˜ Key & å‡ç´šæ­£å¼ç‰ˆ'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Mode Indicator Banner Component
        const ModeIndicatorBanner = ({ currentMode, setActiveModule }) => {
            const isOfficial = currentMode === 'Official';
            const bgColor = isOfficial ? 'bg-green-600' : 'bg-yellow-600';
            const statusText = isOfficial ? 'æ­£å¼ç‰ˆ (AI å¯¦æ™‚ç”Ÿæˆ)' : 'é«”é©—ç‰ˆ (é«˜æ“¬çœŸæ¨¡æ“¬)';
            const statusIcon = isOfficial ? <CheckCircle size={18} className="mr-2"/> : <AlertCircle size={18} className="mr-2"/>;

            return (
                <div className={`w-full ${bgColor} text-white p-3 text-sm font-medium flex items-center justify-between shadow-lg`}>
                    <span className="flex items-center">
                        {statusIcon} {statusText}
                    </span>
                    {!isOfficial && (
                        <button onClick={() => setActiveModule('generate')} className="text-xs bg-white text-yellow-700 px-3 py-1 rounded-full hover:bg-gray-100 transition">
                            é»æ“Šé€™è£¡äº†è§£æ­£å¼ç‰ˆ
                        </button>
                    )}
                </div>
            );
        };
        // End of new Components

        // --- Module Components ---
        
        const GenerateModule = ({ levels, modes, selectedLevel, setSelectedLevel, selectedMode, setSelectedMode, handleGenerate, isGenerating, generatedText, setActiveModule, themes, selectedTheme, setSelectedTheme, selectedScenario, setSelectedScenario }) => (
            <div className="space-y-6 animate-fade-in">
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center space-x-3 mb-6 border-b border-gray-100 pb-4">
                        <div className="p-2 bg-orange-100 rounded-lg text-orange-500"><FileText size={24} /></div>
                        <div><h2 className="text-xl font-bold text-gray-800">æ™ºèƒ½æ–‡æœ¬ç”Ÿæˆ</h2><p className="text-xs text-gray-500">AI Powered Generation</p></div>
                    </div>

                    {/* === æ–°å¢ï¼šæ‰‹æ©Ÿç‰ˆå°ˆç”¨ä¸»é¡Œé¸æ“‡å™¨ (Mobile Only) === */}
                    <div className="md:hidden space-y-4 mb-6 p-4 bg-orange-50 rounded-xl border border-orange-100">
                        <div>
                            <label className="block text-xs font-bold text-orange-700 uppercase mb-1">1. é¸æ“‡ä¸»é¡Œ</label>
                            <select 
                                value={selectedTheme.id} 
                                onChange={(e) => {
                                    const theme = themes.find(t => t.id === Number(e.target.value));
                                    setSelectedTheme(theme);
                                    setSelectedScenario(theme.scenarios[0]); // åˆ‡æ›ä¸»é¡Œæ™‚é‡ç½®æƒ…å¢ƒ
                                }}
                                className="w-full p-2 rounded-lg border-orange-200 text-sm focus:ring-2 focus:ring-orange-300"
                            >
                                {themes.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-orange-700 uppercase mb-1">2. é¸æ“‡æƒ…å¢ƒ</label>
                            <div className="flex flex-wrap gap-2">
                                {selectedTheme.scenarios.map(s => (
                                    <button 
                                        key={s} 
                                        onClick={() => setSelectedScenario(s)}
                                        className={`px-3 py-1 rounded-full text-xs border transition ${selectedScenario === s ? 'bg-orange-500 text-white border-orange-500 shadow-md' : 'bg-white text-orange-600 border-orange-200'}`}
                                    >
                                        {s}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    {/* === æ‰‹æ©Ÿç‰ˆé¸æ“‡å™¨çµæŸ === */}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">èªè¨€ç­‰ç´š</label>
                            <div className="flex flex-wrap gap-2">
                                {levels.map(l => (
                                    <button key={l} onClick={() => setSelectedLevel(l)} className={`px-3 py-1.5 text-sm rounded-md border transition ${selectedLevel === l ? 'bg-[#006699] text-white' : 'hover:border-[#006699]'}`}>{l}</button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">ç”Ÿæˆæ¨¡å¼</label>
                            <div className="space-y-2">
                                {modes.map(m => (
                                    <button key={m.id} onClick={() => setSelectedMode(m)} className={`w-full text-left px-3 py-2 text-sm rounded-md border transition flex justify-between ${selectedMode.id === m.id ? 'bg-orange-50 border-orange-300 text-orange-700' : 'hover:border-orange-300'}`}>
                                        <span>{m.name}</span><span className="text-xs opacity-70">{m.desc}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="mt-8 flex justify-end space-x-3 border-t border-gray-100 pt-4">
                        <button onClick={handleGenerate} disabled={isGenerating} className="px-6 py-2 bg-[#FFB347] text-white font-bold rounded-lg shadow-md hover:bg-[#FF8C00] transition flex items-center space-x-2 disabled:opacity-50">
                            {isGenerating ? <Repeat className="animate-spin" size={18} /> : <Sparkles size={18} />}
                            <span>{isGenerating ? 'AI æ€è€ƒä¸­...' : 'é–‹å§‹ç”Ÿæˆ'}</span>
                        </button>
                    </div>
                </div>
                {generatedText && (
                    <div className="bg-white rounded-xl shadow-lg border-t-4 border-[#FFB347] overflow-hidden">
                        <div className="bg-gray-50 px-6 py-3 border-b flex justify-between items-center">
                            <span className="font-bold text-gray-600">ç”Ÿæˆçµæœ ({selectedTheme.name} - {selectedScenario})</span>
                            <div className="flex space-x-2">
                                <button className="text-xs flex items-center bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition" onClick={() => setActiveModule("rewrite")}><Repeat size={12} className="mr-1"/> å‰å¾€æ”¹å¯«</button>
                                <button className="text-xs flex items-center bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200 transition" onClick={() => setActiveModule("qa")}><MessageCircle size={12} className="mr-1"/> å»¶ä¼¸å•ç­”</button>
                                <button className="text-xs flex items-center bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 transition" onClick={() => setActiveModule("tutor")}><Zap size={12} className="mr-1"/> è©¢å•åŠ©æ•™</button>
                            </div>
                        </div>
                        <div className="p-6 text-lg text-gray-800 leading-loose font-serif">
                            {generatedText.content}
                            {generatedText.stats?.reasoning && <div className="mt-4 p-3 bg-blue-50 text-sm text-blue-800 rounded flex items-start"><AlertCircle size={16} className="mr-2 mt-0.5 flex-shrink-0" />{generatedText.stats.reasoning}</div>}
                        </div>
                    </div>
                )}
            </div>
        );

        const RewriteModule = ({ generatedText, isGenerating, handleRewrite, rewriteResult, rewriteOptions }) => (
            <div className="space-y-6 animate-fade-in">
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center space-x-3 mb-6 border-b border-gray-100 pb-4">
                        <div className="p-2 bg-blue-100 rounded-lg text-blue-500"><Repeat size={24} /></div>
                        <div><h2 className="text-xl font-bold text-gray-800">æ–‡æœ¬æ”¹å¯«å¯¦é©—å®¤</h2><p className="text-xs text-gray-500">Smart Text Transformation</p></div>
                    </div>
                    {!generatedText ? <div className="text-center py-10 text-gray-400">è«‹å…ˆåœ¨ã€Œæ–‡æœ¬ç”Ÿæˆã€å€ç”¢ç”Ÿå…§å®¹ã€‚</div> : (
                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                            <div className="lg:col-span-4 space-y-2">
                                <label className="text-sm font-bold text-gray-600">åŸå§‹æ–‡æœ¬</label>
                                <div className="p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-500 h-96 overflow-y-auto text-sm leading-relaxed">{generatedText.content}</div>
                            </div>
                            <div className="lg:col-span-2 flex flex-col space-y-3 justify-center">
                                <div className="text-xs font-bold text-center text-gray-400 mb-2">é¸æ“‡æ”¹å¯«ç­–ç•¥</div>
                                {rewriteOptions.map(opt => (
                                    <button key={opt.id} onClick={() => handleRewrite(opt)} disabled={isGenerating} className="p-3 text-center border rounded-xl hover:border-blue-400 hover:bg-blue-50 transition shadow-sm group">
                                        <div className="font-bold text-sm text-gray-800 group-hover:text-blue-600">{opt.name}</div>
                                        <div className="text-[10px] text-gray-400 mt-1">{opt.desc}</div>
                                    </button>
                                ))}
                            </div>
                            <div className="lg:col-span-6 space-y-2">
                                <label className="text-sm font-bold text-gray-600">æ”¹å¯«çµæœèˆ‡ AI åˆ†æ</label>
                                <div className="bg-white rounded-lg border border-blue-200 h-96 overflow-y-auto flex flex-col relative">
                                    {isGenerating && <div className="absolute inset-0 bg-white/90 z-10 flex flex-col items-center justify-center text-blue-600"><Repeat className="animate-spin mb-3" size={32}/><span className="font-bold">AI æ­£åœ¨åˆ†æ...</span></div>}
                                    {rewriteResult ? (
                                        <>
                                            <div className="p-5 text-gray-800 leading-loose text-base flex-1 font-serif bg-blue-50/30">{rewriteResult.content}</div>
                                            <div className="bg-blue-50 border-t border-blue-100 p-4 text-sm">
                                                <div className="flex items-center text-blue-800 font-bold mb-2"><Lightbulb size={16} className="mr-2"/> AI æ”¹å¯«åˆ†æ</div>
                                                <p className="text-gray-600 text-xs mb-3">{rewriteResult.analysis?.summary}</p>
                                                <div className="space-y-2">
                                                    {rewriteResult.analysis?.key_changes?.map((change, i) => (
                                                      <div key={i} className="flex items-start bg-white p-2 rounded border border-blue-100 shadow-sm">
                                                        <span className="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded font-bold mr-2 mt-0.5 whitespace-nowrap">{change.type || "ä¿®æ”¹"}</span>
                                                        <span className="text-xs text-gray-600">{change.original && change.new ? <span>å°‡ <span className="line-through text-gray-400">{change.original}</span> æ”¹ç‚º <span className="text-green-600 font-medium">{change.new}</span> ({change.reason})</span> : change.desc}</span>
                                                      </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </>
                                    ) : <div className="flex-1 flex items-center justify-center text-gray-400 text-sm">è«‹é¸æ“‡å·¦å´æ”¹å¯«ç­–ç•¥</div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );

        const QAModule = ({ generatedText, isGenerating, qaTypes, handleQA, qaResult, userAnswers, handleAnswerClick, showExplanation }) => (
            <div className="space-y-6 animate-fade-in">
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center space-x-3 mb-6 border-b border-gray-100 pb-4">
                        <div className="p-2 bg-green-100 rounded-lg text-green-500"><MessageCircle size={24} /></div>
                        <div><h2 className="text-xl font-bold text-gray-800">æ™ºæ…§å•ç­”å»¶ä¼¸</h2><p className="text-xs text-gray-500">Interactive Quiz</p></div>
                    </div>
                    {!generatedText ? <div className="text-center py-10 text-gray-400">è«‹å…ˆç”Ÿæˆæ–‡æœ¬ã€‚</div> : (
                        <div>
                            <div className="flex space-x-4 mb-8">
                                {qaTypes.map(type => (
                                    <button key={type.id} onClick={() => handleQA(type)} disabled={isGenerating} className={`flex-1 py-4 border rounded-xl transition flex flex-col items-center justify-center space-y-2 ${qaResult?.type === type.id ? 'bg-green-50 border-green-500' : 'border-gray-200 hover:bg-green-50'}`}>
                                        <div className="text-green-600">{type.icon}</div><span className="font-bold text-sm text-gray-600">{type.name}</span>
                                    </button>
                                ))}
                            </div>
                            {isGenerating && <div className="text-center py-12 bg-gray-50 rounded-xl"><Sparkles className="animate-spin mx-auto text-green-500 mb-3" size={32}/><div className="text-gray-500 font-medium">AI æ­£åœ¨å‡ºé¡Œä¸­...</div></div>}
                            {qaResult && !isGenerating && (
                                <div className="animate-fade-in space-y-6">
                                    {qaResult.type === 'reading' && qaResult.items?.map((item, qIdx) => (
                                        <div key={qIdx} className="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                                            <div className="flex items-start mb-4"><span className="bg-green-100 text-green-800 text-xs font-bold px-2.5 py-1 rounded-lg mr-3 mt-0.5">Q{qIdx+1}</span><h3 className="font-bold text-gray-800 text-lg">{item.question}</h3></div>
                                            <div className="space-y-2 ml-10">
                                                {item.options?.map((opt, oIdx) => {
                                                    const isSelected = userAnswers[qIdx] === oIdx;
                                                    const isCorrect = item.correctIndex === oIdx;
                                                    const showResult = showExplanation[qIdx];
                                                    let btnClass = "border-gray-200 hover:bg-gray-50";
                                                    if (showResult) { if (isCorrect) btnClass = "bg-green-50 border-green-500 text-green-800"; else if (isSelected) btnClass = "bg-red-50 border-red-300 text-red-800"; }
                                                    return <button key={oIdx} onClick={() => handleAnswerClick(qIdx, oIdx)} disabled={showResult} className={`w-full text-left p-3 rounded-lg border flex items-center justify-between transition ${btnClass}`}><span>{opt}</span>{showResult && isCorrect && <CheckCircle size={18} className="text-green-600"/>}{showResult && isSelected && !isCorrect && <XCircle size={18} className="text-red-500"/>}</button>;
                                                })}
                                            </div>
                                            {showExplanation[qIdx] && <div className="ml-10 mt-4 p-4 bg-gray-50 rounded-lg text-sm text-gray-600 border border-gray-100 flex items-start"><Lightbulb size={16} className="mr-2 text-yellow-500"/><div><span className="font-bold">è§£æï¼š</span> {item.explanation}</div></div>}
                                        </div>
                                    ))}
                                    {qaResult.type === 'discussion' && qaResult.items?.map((item, idx) => (
                                        <div key={idx} className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                                            <div className="p-5 border-b border-gray-100 bg-gradient-to-r from-green-50/50 to-white">
                                                <h3 className="font-bold text-gray-800 flex items-start"><MessageCircle size={18} className="mr-2 text-green-500 mt-1"/> {item.question}</h3>
                                            </div>
                                            <div className="p-5 bg-white">
                                                <div className="text-sm text-gray-500 font-bold mb-2 uppercase tracking-wide text-xs">AI Teacher's Guide</div>
                                                <div className="text-gray-700 leading-relaxed bg-gray-50 p-4 rounded-lg text-sm border-l-4 border-green-400">{item.guide}</div>
                                            </div>
                                        </div>
                                    ))}
                                    {qaResult.type === 'vocab' && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {qaResult.items?.map((item, idx) => (
                                                <div key={idx} className="bg-white border border-gray-200 rounded-xl p-5 hover:shadow-md transition group">
                                                    <div className="flex justify-between items-start mb-2"><h3 className="text-xl font-bold text-gray-800">{item.word}</h3><span className="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded-full">{item.partOfSpeech}</span></div>
                                                    <div className="text-green-600 font-mono text-sm mb-3">{item.pinyin}</div>
                                                    <p className="text-gray-600 text-sm mb-4 line-clamp-2">{item.definition}</p>
                                                    <div className="pt-3 border-t border-gray-100"><p className="text-xs text-gray-400 mb-1">ä¾‹å¥ï¼š</p><p className="text-sm text-gray-700 italic">"{item.example}"</p></div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );

        const TutorModule = ({ chatHistory, tutorInput, setTutorInput, handleTutorSend, isGenerating, chatEndRef, generatedText, setActiveModule, handleQuickQuestion }) => (
            <div className="space-y-6 animate-fade-in h-full flex flex-col">
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col flex-1">
                    <div className="flex items-center space-x-3 mb-4 border-b border-gray-100 pb-4">
                        <div className="p-2 bg-purple-100 rounded-lg text-purple-500"><Zap size={24} /></div>
                        <div><h2 className="text-xl font-bold text-gray-800">AI æ™ºèƒ½åŠ©æ•™</h2></div>
                    </div>
                    {generatedText && (
                        <div className="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4 text-xs text-gray-600 flex justify-between items-center group">
                            <div className="truncate flex-1 mr-4"><span className="font-bold text-gray-700 mr-2">ç•¶å‰æ–‡æœ¬:</span> "{generatedText.content.substring(0, 50)}..."</div>
                            <button className="text-[#006699] hover:underline whitespace-nowrap" onClick={() => setActiveModule('generate')}>æŸ¥çœ‹å…¨æ–‡</button>
                        </div>
                    )}
                    <div className="flex-1 overflow-y-auto mb-4 space-y-4 pr-2 custom-scrollbar">
                        {chatHistory.map((msg, idx) => (
                            <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                {msg.role === 'ai' && <div className="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mr-2 text-purple-600 flex-shrink-0"><Bot size={18}/></div>}
                                <div className={`max-w-[80%] p-4 rounded-2xl shadow-sm text-sm leading-relaxed ${msg.role === 'user' ? 'bg-[#006699] text-white rounded-tr-none' : 'bg-gray-50 border border-gray-200 text-gray-800 rounded-tl-none'}`}>{msg.content}</div>
                            </div>
                        ))}
                        <div ref={chatEndRef} />
                    </div>
                    {generatedText && (
                        <div className="flex space-x-2 overflow-x-auto pb-2 mb-2">
                            {["é€™æ®µæ–‡å­—çš„é‡é»æ˜¯ä»€éº¼ï¼Ÿ", "è«‹è§£é‡‹æ–‡ä¸­çš„é›£è©", "çµ¦æˆ‘ä¸€äº›ç›¸é—œçš„ä¾‹å¥", "é€™æ®µè©±é©åˆä»€éº¼å ´åˆèªªï¼Ÿ"].map((q, i) => (
                            <button key={i} onClick={() => handleQuickQuestion(q)} className="text-xs bg-purple-50 text-purple-700 px-3 py-1.5 rounded-full hover:bg-purple-100 border border-purple-100 whitespace-nowrap transition">{q}</button>
                            ))}
                        </div>
                    )}
                    <div className="flex items-center space-x-2 border-t border-gray-100 pt-3">
                        <input type="text" value={tutorInput} onChange={(e) => setTutorInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleTutorSend()} placeholder="è¼¸å…¥ä½ çš„å•é¡Œ..." className="flex-1 bg-gray-50 border border-gray-200 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-purple-200"/>
                        <button onClick={handleTutorSend} disabled={!tutorInput.trim() || isGenerating} className="w-10 h-10 bg-[#006699] text-white rounded-full flex items-center justify-center hover:bg-blue-700 transition disabled:opacity-50"><Send size={18}/></button>
                    </div>
                </div>
            </div>
        );

        const MultimodalModule = ({ generatedText, isGenerating, isPlaying, setIsPlaying, handleImageToText, imageToTextResult, scenarioImages }) => (
            <div className="space-y-6 animate-fade-in">
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div className="flex items-center space-x-3 mb-6 border-b border-gray-100 pb-4">
                        <div className="p-2 bg-purple-100 rounded-lg text-purple-500"><Headphones size={24} /></div>
                        <div><h2 className="text-xl font-bold text-gray-800">å¤šæ¨¡æ…‹å­¸ç¿’ä¸­å¿ƒ</h2><p className="text-xs text-gray-500">Visual, Audio & Image-to-Text</p></div>
                    </div>

                    <h3 className="font-bold text-gray-700 mb-3 flex items-center"><ImageIcon size={18} className="mr-2"/> æƒ…å¢ƒåœ–ç‰‡å­¸ç¿’ (Image-to-Text)</h3>
                    
                    {/* Scenario Grid */}
                    <div className="grid grid-cols-4 sm:grid-cols-8 gap-3 mb-6">
                        {scenarioImages.map((scenario) => (
                            <button 
                                key={scenario.id} 
                                onClick={() => handleImageToText(scenario)} 
                                disabled={isGenerating}
                                title={scenario.label}
                                className="flex flex-col items-center justify-center p-3 border border-gray-200 rounded-xl hover:bg-gray-50 transition h-24 disabled:opacity-50 disabled:cursor-wait"
                            >
                                <span className="text-2xl mb-1">{scenario.emoji}</span>
                                <span className="text-[10px] text-center text-gray-600 leading-tight">{scenario.label}</span>
                            </button>
                        ))}
                    </div>

                    {isGenerating && <div className="text-center py-6 text-purple-600 flex justify-center items-center"><Repeat className="animate-spin mr-2"/> AI è¦–è¦ºåˆ†æèˆ‡ç”Ÿæˆä¸­...</div>}

                    {/* Image-to-Text Result Area */}
                    {imageToTextResult && (
                        <div className="bg-purple-50 border border-purple-200 rounded-xl p-5 mb-8 animate-fade-in">
                            <h4 className="text-lg font-bold text-purple-800 mb-2">{imageToTextResult.title}</h4>
                            <p className="text-gray-700 text-sm leading-relaxed mb-3">{imageToTextResult.lesson}</p>
                            <div className="text-xs text-gray-600">
                                **é—œéµè©å½™:** {imageToTextResult.keywords?.join('ã€')}
                                <span className="ml-4 text-purple-600">({imageToTextResult.vocabLevel} ç´š)</span>
                            </div>
                        </div>
                    )}
                   

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 border-t border-gray-100 pt-6">
                        {/* Audio Part */}
                        <div className="flex flex-col justify-between">
                            <div>
                                <h3 className="font-bold text-gray-700 mb-3 flex items-center"><Headphones size={18} className="mr-2"/> AI èªéŸ³å°è®€</h3>
                                <div className="bg-gray-800 rounded-xl p-6 text-white shadow-lg relative overflow-hidden">
                                    <div className="flex items-center justify-between mb-4">
                                        <div>
                                            <div className="text-lg font-bold">{(imageToTextResult?.title || generatedText?.stats?.vocabLevel) ? (imageToTextResult?.title || 'æ–‡æœ¬èªéŸ³') : 'è«‹å…ˆç”Ÿæˆå…§å®¹'}</div>
                                            <div className="text-xs text-gray-400">AI Teacher Voice â€¢ {imageToTextResult?.vocabLevel || generatedText?.stats?.vocabLevel || 'B1'}</div>
                                        </div>
                                        <Activity className="text-green-400 animate-pulse"/>
                                    </div>
                                    
                                    <div className="flex justify-center space-x-6 items-center">
                                        <button onClick={() => setIsPlaying(!isPlaying)} className="w-12 h-12 bg-white text-gray-900 rounded-full flex items-center justify-center hover:scale-105 transition">
                                            {isPlaying ? <Pause size={24} fill="currentColor"/> : <Play size={24} fill="currentColor" className="ml-1"/>}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div className="mt-6">
                                <h3 className="font-bold text-gray-700 mb-3 flex items-center"><Mic size={18} className="mr-2"/> å£èªªè·Ÿè®€ç·´ç¿’</h3>
                                <button className="w-full py-3 border-2 border-dashed border-purple-300 rounded-xl text-purple-600 font-bold hover:bg-purple-50 transition flex items-center justify-center">
                                    <Mic size={20} className="mr-2"/> é»æ“Šé–‹å§‹éŒ„éŸ³
                                </button>
                            </div>
                        </div>
                        {/* Visual Part */}
                        <div>
                            <h3 className="font-bold text-gray-700 mb-3 flex items-center"><ImageIcon size={18} className="mr-2"/> æƒ…å¢ƒåœ–åƒé è¦½</h3>
                            <div className="aspect-video bg-gray-100 rounded-xl flex items-center justify-center border-2 border-dashed border-gray-300 relative overflow-hidden group cursor-pointer">
                                <div className="absolute inset-0 bg-gradient-to-br from-orange-100 to-blue-100 opacity-50"></div>
                                <div className="text-center z-10 p-4">
                                    <ImageIcon size={48} className="mx-auto text-gray-400 mb-2 group-hover:scale-110 transition"/>
                                    <p className="text-sm text-gray-500 font-medium">åœ–åƒç”Ÿæˆéœ€æ­£å¼ç‰ˆæ¬Šé‡ï¼Œæ­¤ç‚ºåœ–åƒé è¦½å€ã€‚</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );


        const App = () => {
            const [apiKey, setApiKey] = useState('');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [currentPage, setCurrentPage] = useState("home"); 
            const [activeModule, setActiveModule] = useState("generate"); 
            const [selectedTheme, setSelectedTheme] = useState(THEMES[0]);
            const [selectedScenario, setSelectedScenario] = useState(THEMES[0].scenarios[0]);
            const [selectedLevel, setSelectedLevel] = useState("B1");
            const [selectedMode, setSelectedMode] = useState(MODES[0]);
            const [generatedText, setGeneratedText] = useState(null); 
            const [rewriteResult, setRewriteResult] = useState(null);
            const [qaResult, setQaResult] = useState(null);
            const [userAnswers, setUserAnswers] = useState({}); 
            const [showExplanation, setShowExplanation] = useState({});
            const [chatHistory, setChatHistory] = useState([{ role: 'ai', content: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI åŠ©æ•™ã€‚ç”Ÿæˆæ–‡æœ¬å¾Œï¼Œæœ‰ä»»ä½•å•é¡Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼' }]);
            const [tutorInput, setTutorInput] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false); 
            const [imageToTextResult, setImageToTextResult] = useState(null); // New state for multimodal results
            const chatEndRef = useRef(null);

            const currentMode = apiKey ? 'Official' : 'Trial';


            useEffect(() => {
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) setApiKey(storedKey);
            }, []);

            const handleGenerate = async () => {
                setIsGenerating(true);
                setGeneratedText(null);
                setRewriteResult(null); 
                setQaResult(null);
                setImageToTextResult(null); // Clear multimodal state
                setChatHistory([{ role: 'ai', content: `æˆ‘å·²ç¶“é–±è®€äº†é—œæ–¼ã€Œ${selectedScenario}ã€çš„æ–°æ–‡æœ¬ã€‚ä½ å¯ä»¥å•æˆ‘é—œæ–¼é€™æ®µæ–‡å­—çš„å–®å­—ã€èªæ³•æˆ–æ–‡åŒ–å•é¡Œï¼` }]);
                
                if (currentMode === 'Trial') {
                    await new Promise(r => setTimeout(r, 1000));
                    setGeneratedText(generateMockContent(selectedTheme.name, selectedScenario, selectedLevel, selectedMode.name));
                } else {
                    const prompt = generatePrompt(selectedTheme.name, selectedScenario, selectedLevel, selectedMode.name);
                    try {
                        const result = await callGeminiAPI(prompt, apiKey);
                        if (result) {
                            setGeneratedText({ ...result, stats: { ...result.stats, time: "2.1" } });
                        } else {
                            throw new Error("Fallback");
                        }
                    } catch (e) {
                        setGeneratedText(generateMockContent(selectedTheme.name, selectedScenario, selectedLevel, selectedMode.name));
                    }
                }
                setIsGenerating(false);
            };

            const handleRewrite = async (type) => {
                if (!generatedText) return;
                setIsGenerating(true);
                
                if (currentMode === 'Trial') {
                    await new Promise(r => setTimeout(r, 1500));
                    setRewriteResult(generateMockRewrite(generatedText.content, type.id));
                } else {
                    const prompt = generateRewritePrompt(generatedText.content, type.name);
                    try {
                        const result = await callGeminiAPI(prompt, apiKey);
                        if (result) setRewriteResult(result);
                        else throw new Error("Fallback");
                    } catch (e) {
                        setRewriteResult(generateMockRewrite(generatedText.content, type.id));
                    }
                }
                setIsGenerating(false);
            };

            const handleQA = async (type) => {
                if (!generatedText) return;
                setIsGenerating(true);
                setQaResult(null);
                setUserAnswers({});
                setShowExplanation({});
                
                if (currentMode === 'Trial') {
                    await new Promise(r => setTimeout(r, 1200));
                    setQaResult({ type: type.id, ...generateMockQA(type.id) });
                } else {
                    const prompt = generateQAPrompt(generatedText.content, type.name);
                    try {
                        const result = await callGeminiAPI(prompt, apiKey);
                        if (result) setQaResult({ type: type.id, ...result });
                        else throw new Error("Fallback");
                    } catch (e) {
                        setQaResult({ type: type.id, ...generateMockQA(type.id) });
                    }
                }
                setIsGenerating(false);
            };

            const handleTutorSend = async () => {
                if (!tutorInput.trim()) return;
                const userMsg = { role: 'user', content: tutorInput };
                setChatHistory(prev => [...prev, userMsg]);
                setTutorInput("");
                setIsGenerating(true);
                const context = generatedText ? generatedText.content : "ç›®å‰æ²’æœ‰ç”Ÿæˆç‰¹å®šçš„æ–‡æœ¬ï¼Œè«‹å›ç­”ä¸€èˆ¬æ€§çš„è¯èªå­¸ç¿’å•é¡Œã€‚";
                const prompt = generateTutorPrompt(context, userMsg.content);
                
                if (currentMode === 'Trial') {
                    await new Promise(r => setTimeout(r, 800));
                    setChatHistory(prev => [...prev, { role: 'ai', content: generateMockTutorResponse(userMsg.content) }]);
                } else {
                    try {
                        const result = await callGeminiChatAPI(prompt, apiKey);
                        if (result) {
                            setChatHistory(prev => [...prev, { role: 'ai', content: result }]);
                        } else {
                            throw new Error("Fallback");
                        }
                    } catch (e) {
                        setChatHistory(prev => [...prev, { role: 'ai', content: generateMockTutorResponse(userMsg.content) }]);
                    }
                }
                setIsGenerating(false);
            };
            
            const handleImageToText = async (scenario) => {
                setIsGenerating(true);
                setGeneratedText(null);
                setRewriteResult(null); 
                setQaResult(null);
                setImageToTextResult(null);
                
                // Clear the main text, but keep chat for context
                setChatHistory([{ role: 'ai', content: `æ‚¨å·²é¸æ“‡åœ–ç‰‡æƒ…å¢ƒã€Œ${scenario.label}ã€ï¼Œæˆ‘å¯ä»¥æ ¹æ“šé€™å€‹æƒ…å¢ƒç‚ºæ‚¨åˆ†æå’Œè¼”å°ï¼` }]);

                if (currentMode === 'Trial') {
                    await new Promise(r => setTimeout(r, 1500));
                    const mockResult = generateMockImageToText(scenario.label);
                    // Update main content state with this new content for other modules to use (Rewrite/QA/Tutor)
                    setGeneratedText({ content: mockResult.lesson, stats: { vocabLevel: mockResult.vocabLevel, reasoning: mockResult.reasoning } });
                    setImageToTextResult(mockResult);
                } else {
                    // In a real app, this would involve sending the image BASE64/URL and the prompt to Gemini
                    const prompt = `åˆ†æé€™å¼µåœ–ç‰‡ (æƒ…å¢ƒ: ${scenario.label})ï¼Œä¸¦é‡å°è¯èªå­¸ç¿’è€…ç”Ÿæˆä¸€æ®µå¯¦ç”¨å°è©±å’Œäº”å€‹é—œéµè©å½™ã€‚è¼¸å‡ºJSONæ ¼å¼: {title: "${scenario.label}åˆ†æ", lesson: "...", keywords: ["..."], vocabLevel: "..."}`;
                    try {
                        const result = await callGeminiChatAPI(prompt, apiKey); // Use chat API for text output
                        // Note: Real API would return string JSON, need robust parsing
                        const parsedResult = JSON.parse(result); 
                        setGeneratedText({ content: parsedResult.lesson, stats: { vocabLevel: parsedResult.vocabLevel, reasoning: 'æ ¹æ“šè¦–è¦ºè¼¸å…¥ç”Ÿæˆ' } });
                        setImageToTextResult(parsedResult);
                    } catch (e) {
                         const mockResult = generateMockImageToText(scenario.label);
                         setGeneratedText({ content: mockResult.lesson, stats: { vocabLevel: mockResult.vocabLevel, reasoning: mockResult.reasoning } });
                         setImageToTextResult(mockResult);
                    }
                }
                setIsGenerating(false);
            };


            const handleQuickQuestion = (question) => setTutorInput(question);
            const handleAnswerClick = (qIndex, optIndex) => {
                setUserAnswers(prev => ({...prev, [qIndex]: optIndex}));
                setShowExplanation(prev => ({...prev, [qIndex]: true}));
            };

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [chatHistory]);

            return (
                <div className="min-h-screen bg-gray-100 flex flex-col font-sans text-slate-800">
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} apiKey={apiKey} setApiKey={setApiKey} currentMode={currentMode}/>
                    
                    <nav className="bg-white shadow-md sticky top-0 z-50 h-16 flex items-center justify-between px-4 md:px-8">
                        <div className="flex items-center font-bold text-xl text-[#006699] cursor-pointer" onClick={() => setCurrentPage("home")}>
                            <div className="w-8 h-8 bg-[#FFB347] rounded mr-2 flex items-center justify-center text-white">AI</div>è¯èªAIç™¾å¯¶ç®±
{/* å›é¦–é æŒ‰éˆ• (Reactå¯«æ³•) */}
<a href="index.html" className="flex items-center gap-2 mr-4 text-slate-600 hover:text-orange-500 font-bold no-underline">
    <span className="text-xl">ğŸ </span>
    <span className="hidden md:inline">å›é¦–é </span>
</a>

                        </div>
                        <div className="hidden md:flex space-x-1">
                            {[{id:'generate',icon:<FileText size={18}/>,t:'æ–‡æœ¬ç”Ÿæˆ'},{id:'rewrite',icon:<Repeat size={18}/>,t:'æ–‡æœ¬æ”¹å¯«'},{id:'qa',icon:<MessageCircle size={18}/>,t:'å•ç­”å»¶ä¼¸'},{id:'tutor',icon:<Zap size={18}/>,t:'AI åŠ©æ•™'},{id:'multimodal',icon:<Headphones size={18}/>,t:'å¤šæ¨¡æ…‹'}].map(item => (
                                <button key={item.id} onClick={() => {setCurrentPage("workspace"); setActiveModule(item.id)}} className={`flex items-center px-4 py-2 rounded-lg transition ${activeModule === item.id && currentPage === 'workspace' ? 'bg-orange-50 text-orange-600 font-bold' : 'text-gray-600 hover:bg-gray-50'}`}>{item.icon} <span className="ml-2">{item.t}</span></button>
                            ))}
                        </div>
                        <div className="flex items-center space-x-3">
                            <button onClick={() => setIsSettingsOpen(true)} className="flex items-center text-gray-600 hover:text-[#006699] transition" title="è¨­å®š API Key">
                                <Settings size={20} className={currentMode === 'Trial' ? "text-yellow-500" : "text-green-500"}/>
                                <span className={`text-xs font-bold ml-2 hidden md:inline ${currentMode === 'Trial' ? 'text-yellow-600' : 'text-green-600'}`}>
                                    {currentMode === 'Trial' ? 'é«”é©—ç‰ˆ' : 'æ­£å¼ç‰ˆ'}
                                </span>
                            </button>
                            <div className="md:hidden"><Menu onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}/></div>
                        </div>
                    </nav>

                    {/* Mode Banner Display */}
                    {currentPage !== 'home' && <ModeIndicatorBanner currentMode={currentMode} setActiveModule={setActiveModule} />}
                    
                    {currentPage === 'home' ? (
                        <div className="flex-1 flex flex-col items-center justify-center bg-gradient-to-br from-orange-50 to-blue-50 p-8 text-center">
                            <h1 className="text-4xl md:text-5xl font-extrabold text-gray-800 mb-6">è®“è¯èªæ•™å­¸æ›´<span className="text-[#006699]">æ™ºæ…§</span></h1>
                            <button onClick={() => setCurrentPage("workspace")} className="px-8 py-4 bg-[#FFB347] text-white font-bold rounded-full shadow-xl hover:scale-105 transition flex items-center"><Sparkles className="mr-2"/> é–‹å§‹é«”é©—</button>
                        </div>
                    ) : (
                        <div className="flex flex-col md:flex-row flex-1 min-h-[calc(100vh-64px)]">
                            <div className="w-full md:w-64 bg-white border-b md:border-r md:border-b-0 hidden md:block">
                                <div className="p-4 bg-gray-50 border-b font-bold text-gray-700 flex items-center"><BookOpen size={18} className="mr-2"/> ä¸»é¡Œæƒ…å¢ƒ</div>
                                <div className="p-2">{THEMES.map(theme => (
                                    <div key={theme.id} className="mb-1"><button onClick={() => setSelectedTheme(theme)} className={`w-full text-left px-3 py-2 rounded flex items-center ${selectedTheme.id === theme.id ? 'bg-blue-50 text-[#006699]' : 'hover:bg-gray-100'}`}><span className="mr-2">{theme.icon}</span> {theme.name}</button>
                                    {selectedTheme.id === theme.id && <div className="ml-8 mt-1 border-l-2 pl-2 space-y-1">{theme.scenarios.map(s => <button key={s} onClick={() => setSelectedScenario(s)} className={`w-full text-left text-sm px-2 py-1 rounded ${selectedScenario === s ? 'text-orange-600 font-medium bg-orange-50' : 'text-gray-500 hover:text-gray-800'}`}>{s}</button>)}</div>}</div>
                                ))}</div>
                            </div>
                            <div className="flex-1 bg-slate-50 p-4 md:p-8 pb-24">
                                <div className="max-w-4xl mx-auto h-full flex flex-col">
                                    {activeModule === 'generate' && <GenerateModule 
    levels={LEVELS} 
    modes={MODES} 
    selectedLevel={selectedLevel} 
    setSelectedLevel={setSelectedLevel} 
    selectedMode={selectedMode} 
    setSelectedMode={setSelectedMode} 
    handleGenerate={handleGenerate} 
    isGenerating={isGenerating} 
    generatedText={generatedText} 
    setActiveModule={setActiveModule}
    // æ–°å¢ä»¥ä¸‹é€™å››è¡Œè³‡æ–™å‚³éï¼š
    themes={THEMES}
    selectedTheme={selectedTheme}
    setSelectedTheme={setSelectedTheme}
    selectedScenario={selectedScenario}
    setSelectedScenario={setSelectedScenario}
/>}
                                    {activeModule === 'rewrite' && <RewriteModule generatedText={generatedText} isGenerating={isGenerating} handleRewrite={handleRewrite} rewriteResult={rewriteResult} rewriteOptions={REWRITE_OPTIONS} />}
                                    {activeModule === 'qa' && <QAModule generatedText={generatedText} isGenerating={isGenerating} qaTypes={QA_TYPES} handleQA={handleQA} qaResult={qaResult} userAnswers={userAnswers} handleAnswerClick={handleAnswerClick} showExplanation={showExplanation} />}
                                    {activeModule === 'tutor' && <TutorModule chatHistory={chatHistory} tutorInput={tutorInput} setTutorInput={setTutorInput} handleTutorSend={handleTutorSend} isGenerating={isGenerating} chatEndRef={chatEndRef} generatedText={generatedText} setActiveModule={setActiveModule} handleQuickQuestion={handleQuickQuestion} />}
                                    {activeModule === 'multimodal' && <MultimodalModule generatedText={generatedText} isGenerating={isGenerating} isPlaying={isPlaying} setIsPlaying={setIsPlaying} handleImageToText={handleImageToText} imageToTextResult={imageToTextResult} scenarioImages={SCENARIO_IMAGES} />}
                                </div>
                            </div>
                        </div>
                    )}

{/* === æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°è¦½åˆ— (Page 2) === */}
<div className="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around items-center p-2 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
    {[
        {id:'generate', icon:<FileText size={20}/>, t:'ç”Ÿæˆ'},
        {id:'rewrite', icon:<Repeat size={20}/>, t:'æ”¹å¯«'},
        {id:'qa', icon:<MessageCircle size={20}/>, t:'å•ç­”'},
        {id:'tutor', icon:<Zap size={20}/>, t:'åŠ©æ•™'},
        {id:'multimodal', icon:<Headphones size={20}/>, t:'å¤šæ¨¡æ…‹'}
    ].map(item => (
        <button 
            key={item.id} 
            onClick={() => {setCurrentPage("workspace"); setActiveModule(item.id)}} 
            className={`flex flex-col items-center justify-center w-full py-1 ${activeModule === item.id ? 'text-orange-600' : 'text-gray-400'}`}
        >
            {item.icon}
            <span className="text-[10px] mt-1 font-medium">{item.t}</span>
        </button>
    ))}
</div>


                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>