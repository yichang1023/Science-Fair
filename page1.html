<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èªAIç™¾å¯¶ç®± - æ‚¨çš„æ™ºèƒ½æ•™å­¸å¤¥ä¼´</title>
    
    <!-- 1. å®šç¾© process ç’°å¢ƒè®Šæ•¸ï¼Œç¢ºä¿ React ç›¸é—œåº«æ­£ç¢ºé‹è¡Œ -->
    <script>
        window.process = { env: { NODE_ENV: 'production' } };
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ä½¿ç”¨ç©©å®šçš„ React Development ç‰ˆæœ¬ (å¿…é ˆåœ¨ Babel ä¹‹å‰) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. ä½¿ç”¨ Lucide UMD (é React ç‰ˆæœ¬) ä¸¦åœ¨ JS ä¸­æ‰‹å‹•è™•ç†åœ–æ¨™ (æ›´ç©©å®š) -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        /* Custom Scrollbar for nicer UI */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .zoom-in {
            animation: zoomIn 0.2s ease-out;
        }
        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // --- è§£æ§‹ React èˆ‡ Lucide ---
        const { useState, useEffect, useRef } = React;
        
        // --- åœ–æ¨™å…¼å®¹æ€§è§£æ±ºæ–¹æ¡ˆï¼šå°‡ Lucide å‡½å¼åº«åœ–æ¨™è½‰æ›ç‚º React çµ„ä»¶ ---
        const Lucide = window.lucide || {};
        
        // å‰µå»ºä¸€å€‹é€šç”¨åœ–æ¨™çµ„ä»¶ï¼Œä½¿ç”¨ React.createElement åŒ…è£ Lucide SVG å…§å®¹
        const Icon = ({ name, size, className }) => {
            const iconData = Lucide.icons ? Lucide.icons[name] : null;
            if (!iconData) {
                // å®¹éŒ¯è™•ç†ï¼šè¿”å›ä¸€å€‹ç°¡å–®çš„è­¦å‘Šåœ–æ¨™
                return <svg width={size || 24} height={size || 24} className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>;
            }

            return React.createElement(
                'svg',
                {
                    width: size || 24,
                    height: size || 24,
                    viewBox: "0 0 24 24",
                    fill: "none",
                    stroke: "currentColor",
                    strokeWidth: "2",
                    strokeLinecap: "round",
                    strokeLinejoin: "round",
                    className: className
                },
                iconData.map((data, index) => React.createElement(data[0], data[1]))
            );
        };
        
        // å°‡æ‰€æœ‰éœ€è¦çš„åœ–æ¨™åç¨±æ˜ å°„åˆ°æ–°çš„ Icon çµ„ä»¶
        const icons = {
            BookOpen: (props) => <Icon name="book-open" {...props} />, 
            PenTool: (props) => <Icon name="pen-tool" {...props} />, 
            MessageCircle: (props) => <Icon name="message-circle" {...props} />, 
            Bot: (props) => <Icon name="bot" {...props} />, 
            Headphones: (props) => <Icon name="headphones" {...props} />, 
            Menu: (props) => <Icon name="menu" {...props} />, 
            X: (props) => <Icon name="x" {...props} />, 
            ChevronRight: (props) => <Icon name="chevron-right" {...props} />, 
            ChevronDown: (props) => <Icon name="chevron-down" {...props} />, 
            Settings: (props) => <Icon name="settings" {...props} />, 
            User: (props) => <Icon name="user" {...props} />, 
            Globe: (props) => <Icon name="globe" {...props} />, 
            Save: (props) => <Icon name="save" {...props} />, 
            Trash2: (props) => <Icon name="trash-2" {...props} />, 
            Download: (props) => <Icon name="download" {...props} />, 
            Zap: (props) => <Icon name="zap" {...props} />, 
            BarChart3: (props) => <Icon name="bar-chart-3" {...props} />, 
            RefreshCw: (props) => <Icon name="refresh-cw" {...props} />, 
            Search: (props) => <Icon name="search" {...props} />, 
            Layout: (props) => <Icon name="layout" {...props} />, 
            Code: (props) => <Icon name="code" {...props} />, 
            AlertCircle: (props) => <Icon name="alert-circle" {...props} />, 
            Sparkles: (props) => <Icon name="sparkles" {...props} />, 
            Image: (props) => <Icon name="image" {...props} />,
            Play: (props) => <Icon name="play" {...props} />, 
            Volume2: (props) => <Icon name="volume-2" {...props} />, 
            CheckCircle2: (props) => <Icon name="check-circle-2" {...props} />, 
            HelpCircle: (props) => <Icon name="help-circle" {...props} />, 
            XCircle: (props) => <Icon name="x-circle" {...props} />, 
            Eye: (props) => <Icon name="eye" {...props} />, 
            EyeOff: (props) => <Icon name="eye-off" {...props} />, 
            SplitSquareHorizontal: (props) => <Icon name="split-square-horizontal" {...props} />, 
            ArrowRightLeft: (props) => <Icon name="arrow-right-left" {...props} />, 
            Send: (props) => <Icon name="send" {...props} />, 
            UserCircle2: (props) => <Icon name="user-circle-2" {...props} />, 
            GraduationCap: (props) => <Icon name="graduation-cap" {...props} />, 
            Key: (props) => <Icon name="key" {...props} />
        };


        const { 
            BookOpen, PenTool, MessageCircle, Bot, Headphones, Menu, X, 
            ChevronRight, ChevronDown, Settings, User, Globe, Save, Trash2, 
            Download, Zap, BarChart3, RefreshCw, Search, Layout, Code, 
            AlertCircle, Sparkles, Image: ImageIcon, Play, Volume2, 
            CheckCircle2, HelpCircle, XCircle, Eye, EyeOff, 
            SplitSquareHorizontal, ArrowRightLeft, Send, UserCircle2, 
            GraduationCap, Key
        } = icons;

        // --- å·¥å…·å‡½æ•¸ï¼šPCM è½‰ WAV ---
        const pcmToWav = (pcmData, sampleRate = 24000) => {
            const binaryString = window.atob(pcmData);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const wavHeader = new ArrayBuffer(44);
            const view = new DataView(wavHeader);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + bytes.length, true);
            view.setUint32(8, 0x57415645, true); // 'WAVE'
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, bytes.length, true);
            const blob = new Blob([view, bytes], { type: 'audio/wav' });
            return URL.createObjectURL(blob);
        };

        // --- ç³»çµ±æç¤ºè© ---
        const BASE_SYSTEM_PROMPT = `
# Role
ä½ æ˜¯ä¸€ä½å…¼å…· 20 å¹´æ•™å­¸ç¶“é©—çš„è³‡æ·±è¯èªæ•™å¸«èˆ‡å‰µæ„ç·¨åŠ‡ã€‚

# Core Philosophy
1. **æ‹’çµ•åƒµç¡¬**ï¼šé¿å…åƒç¿»è­¯æ©Ÿä¸€æ¨£çš„ç”Ÿç¡¬èªå¥ã€‚
2. **ç”Ÿæ´»åŒ–**ï¼šä¾ç…§æƒ…å¢ƒåŠ å…¥ã€Œèªæ°£è©ã€ï¼ˆå–”ã€å•Šã€å•¦ï¼‰èˆ‡ã€Œå…·é«”ç´°ç¯€ã€ã€‚
3. **åˆ†ç´šç²¾æº–**ï¼šåš´æ ¼éµå®ˆ TOCFL/CEFR ç­‰ç´šé™åˆ¶ã€‚
`;

        const TUTOR_SYSTEM_PROMPT = `
# Role
ä½ æ˜¯ä¸€ä½è¦ªåˆ‡ã€æœ‰è€å¿ƒä¸”å……æ»¿é¼“å‹µçš„ AI è¯èªåŠ©æ•™ã€‚ä½ çš„åå­—å«ã€Œå°è¯ã€ã€‚

# Task
å›ç­”å­¸ç”Ÿé—œæ–¼è¯èªå­¸ç¿’çš„å•é¡Œã€‚

# Guidelines
1. **æƒ…å¢ƒæ„ŸçŸ¥**ï¼šå¦‚æœä½¿ç”¨è€…æœ‰æä¾›ç•¶å‰çš„å­¸ç¿’æ–‡æœ¬ï¼Œè«‹å„ªå…ˆæ ¹æ“šè©²æ–‡æœ¬å›ç­”ï¼ˆä¾‹å¦‚è§£é‡‹æ–‡ä¸­çš„èªæ³•ã€å–®å­—ï¼‰ã€‚
2. **æ•™å­¸é¢¨æ ¼**ï¼š
   - ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
   - è§£é‡‹è¦æ¸…æ™°æ˜“æ‡‚ï¼Œé©åˆå­¸ç”Ÿçš„ç­‰ç´šã€‚
   - å¤šçµ¦äºˆé¼“å‹µï¼ˆä¾‹å¦‚ï¼šã€Œé€™å€‹å•é¡Œå•å¾—å¾ˆå¥½ï¼ã€ã€ã€ŒåŠ æ²¹ï¼ã€ï¼‰ã€‚
   - é©ç•¶ä½¿ç”¨ Emoji å¢åŠ è¦ªåˆ‡æ„Ÿ ğŸ˜Šã€‚
3. **åŠŸèƒ½é™åˆ¶**ï¼šå¦‚æœå­¸ç”Ÿè¦æ±‚å¯«ä»£ç¢¼æˆ–èˆ‡è¯èªå­¸ç¿’ç„¡é—œçš„äº‹ï¼Œè«‹ç¦®è²Œåœ°å°‡è©±é¡Œå¼•å°å›è¯èªå­¸ç¿’ã€‚
`;

        // --- é…ç½®æ•¸æ“š ---
        const THEMES = [
            { id: 'daily', icon: 'â˜€ï¸', name: 'æ—¥å¸¸ç”Ÿæ´»', scenarios: ['æ‰“æ‹›å‘¼', 'æ™‚é–“', 'å¤©æ°£', 'è²·æ±è¥¿', 'çœ‹é†«ç”Ÿ', 'ç†é«®', 'æ‰¾æœ‹å‹'] },
            { id: 'food', icon: 'ğŸœ', name: 'é£²é£Ÿæ–‡åŒ–', scenarios: ['é»é¤', 'æ¨è–¦ç¾é£Ÿ', 'åƒç«é‹', 'åŒ…é¤ƒå­', 'é£Ÿæä»‹ç´¹', 'èœå–®è©¢å•', 'ç”¨é¤ç¦®å„€'] },
            { id: 'transport', icon: 'ğŸšŒ', name: 'äº¤é€šå‡ºè¡Œ', scenarios: ['å•è·¯', 'æ­å…¬è»Š', 'è²·ç¥¨', 'è¨‚æˆ¿', 'éæµ·é—œ', 'ç§Ÿè»Š', 'é²åˆ°é“æ­‰'] },
            { id: 'work', icon: 'ğŸ’¼', name: 'å·¥ä½œè·å ´', scenarios: ['é¢è©¦', 'è‡ªæˆ‘ä»‹ç´¹', 'é–‹æœƒ', 'ææ¡ˆ', 'é›»è©±', 'å ±å‘Š', 'è«‹å‡'] },
            { id: 'leisure', icon: 'ğŸ®', name: 'ä¼‘é–’å¨›æ¨‚', scenarios: ['çœ‹é›»å½±', 'å”±æ­Œ', 'æ—…éŠ', 'æ‰“çƒ', 'ç©éŠæˆ²', 'èˆˆè¶£ä»‹ç´¹', 'é€±æœ«è¨ˆç•«'] },
        ];

        const LEVELS = ['A1 å…¥é–€', 'A2 åˆç´š', 'B1 ä¸­ç´š', 'B2 ä¸­é«˜ç´š', 'C1 é«˜ç´š', 'C2 ç²¾é€š'];

        const MODES = [
            { id: 'narrative', name: 'æƒ…å¢ƒæ•˜è¿°', desc: 'æè¿°ç•¶ä¸‹ç™¼ç”Ÿçš„äº‹æƒ…' },
            { id: 'experience', name: 'ç¶“é©—åˆ†äº«', desc: 'è¬›è¿°éå»çš„ç¶“æ­·' },
            { id: 'suggestion', name: 'å¯¦ç”¨å»ºè­°', desc: 'æä¾›å»ºè­°èˆ‡æŒ‡ç¤º' },
        ];

        const REWRITE_OPTIONS = [
            { id: 'easier', name: 'æ›´ç°¡å–® (A1/A2)', desc: 'é™ä½é›£åº¦ï¼Œä½¿ç”¨åŸºç¤è©å½™' },
            { id: 'harder', name: 'æ›´æ·±å…¥ (C1/C2)', desc: 'å¢åŠ æˆèªèˆ‡ä¿®è¾­' },
            { id: 'colloquial', name: 'è¶…é“åœ°å£èª', desc: 'åŠ å…¥å°ç£åœ¨åœ°èªåŠ©è©' },
            { id: 'formal', name: 'æ­£å¼æ›¸é¢èª', desc: 'é©åˆè·å ´èˆ‡æ–°èå ±å°' },
        ];

        const QA_TYPES = [
            { id: 'reading', name: 'é–±è®€ç†è§£ (é¸æ“‡é¡Œ)', desc: 'æ¸¬è©¦å°æ–‡ç« å…§å®¹çš„æŒæ¡' },
            { id: 'true_false', name: 'æ˜¯éé¡Œåˆ¤æ–·', desc: 'å¿«é€Ÿæª¢æ ¸è§€å¿µæ­£ç¢ºæ€§' },
            { id: 'vocab', name: 'è©å½™é‹ç”¨æ¸¬é©—', desc: 'æ¸¬è©¦æ–‡ä¸­é—œéµè©çš„å«ç¾©èˆ‡ç”¨æ³•' },
        ];

        const TUTOR_SUGGESTIONS = [
            { label: 'ğŸ§ åˆ†æé€™ç¯‡æ–‡ç« çš„èªæ³•é‡é»', prompt: 'è«‹åˆ†æé€™ç¯‡æ–‡æœ¬ä¸­å‡ºç¾çš„é—œéµèªæ³•é»ï¼Œä¸¦èˆ‰ä¾‹èªªæ˜ã€‚' },
            { label: 'ğŸ“ åˆ—å‡ºå€¼å¾—å­¸ç¿’çš„è©å½™', prompt: 'è«‹åˆ—å‡ºé€™ç¯‡æ–‡æœ¬ä¸­é›£åº¦è¼ƒé«˜æˆ–å¯¦ç”¨çš„ 5 å€‹è©å½™ï¼Œä¸¦é™„ä¸Šæ‹¼éŸ³èˆ‡è§£é‡‹ã€‚' },
            { label: 'ğŸŒ æœ‰ä»€éº¼ç›¸é—œçš„æ–‡åŒ–èƒŒæ™¯ï¼Ÿ', prompt: 'é€™ç¯‡æ–‡æœ¬çš„æƒ…å¢ƒæœ‰æ²’æœ‰ä»€éº¼å°ç£ç‰¹æœ‰çš„æ–‡åŒ–èƒŒæ™¯æˆ–ç¿’æ…£éœ€è¦æ³¨æ„ï¼Ÿ' },
            { label: 'ğŸ—£ï¸ å¦‚ä½•ç”¨æ›´é“åœ°çš„æ–¹å¼èªªï¼Ÿ', prompt: 'é€™æ®µè©±æœ‰æ²’æœ‰æ›´å£èªã€æ›´åƒå°ç£äººçš„èªªæ³•ï¼Ÿ' },
        ];

        // --- å¤šæ¨¡æ…‹æƒ…å¢ƒå­¸ç¿’æ•¸æ“š ---
        const SCENARIO_PROMPTS = [
            { icon: 'ğŸœ', name: 'å¤œå¸‚æƒ…å¢ƒ (æ®ºåƒ¹)', theme: 'è³¼ç‰©æ¶ˆè²»', scenario: 'å¤œå¸‚æ®ºåƒ¹' },
            { icon: 'ğŸš‡', name: 'æ·é‹ç«™ (å•è·¯)', theme: 'äº¤é€šå‡ºè¡Œ', scenario: 'æ·é‹ç«™å•è·¯' },
            { icon: 'ğŸ¥', name: 'é†«é™¢æ«ƒæª¯ (æ›è™Ÿ)', theme: 'é†«ç™‚ä¿å¥', scenario: 'é†«é™¢æ«ƒæª¯æ›è™Ÿ' },
            { icon: 'ğŸ’¼', name: 'è¾¦å…¬å®¤æœƒè­° (ææ¡ˆ)', theme: 'å·¥ä½œè·å ´', scenario: 'æœƒè­°ææ¡ˆ' },
            { icon: 'ğŸ›‚', name: 'ç§»æ°‘ç½²è¾¦ç†å±…ç•™è­‰', theme: 'æ—¥å¸¸ç”Ÿæ´»', scenario: 'è¾¦ç†å±…ç•™è­‰' },
            { icon: 'ğŸ¦', name: 'éŠ€è¡Œæ«ƒæª¯é–‹æˆ¶', theme: 'æ—¥å¸¸ç”Ÿæ´»', scenario: 'éŠ€è¡Œæ«ƒæª¯é–‹æˆ¶' },
            { icon: 'ğŸ“¦', name: 'ä¾¿åˆ©å•†åº—å•åŒ…è£¹', theme: 'æ—¥å¸¸ç”Ÿæ´»', scenario: 'ä¾¿åˆ©åº—å–åŒ…è£¹' },
            { icon: 'ğŸ«', name: 'æ ¡åœ’è¡Œæ”¿è™•è©¢å•å­¸è²»', theme: 'æ—¥å¸¸ç”Ÿæ´»', scenario: 'æ ¡åœ’è©¢å•å­¸è²»' }
        ];

        
        // --- V2.0 æ¨¡æ“¬å…§å®¹åº«ï¼šç¢ºä¿é«”é©—ç‰ˆæœ‰å¤§é‡ä¸”æ™ºèƒ½çš„è¼¸å‡º ---
        const MOCK_CONTENT_BANK = {
            'æ—¥å¸¸ç”Ÿæ´»': {
                'çœ‹é†«ç”Ÿ': {
                    'A1': {
                        narrative: {
                            content: 'æˆ‘è‚šå­ç—›ã€‚æ˜¨å¤©åƒäº†å†°ã€‚ä»Šå¤©æ—©ä¸Šå»çœ‹é†«ç”Ÿã€‚é†«ç”Ÿèªªè¦åƒè—¥ã€‚æˆ‘ç¾åœ¨å¥½å¤šäº†ã€‚',
                            analysis: 'æ–‡æœ¬åƒ…ä½¿ç”¨æœ€åŸºç¤çš„ä¸»è¬‚è³“çµæ§‹ï¼Œè©å½™ç‚ºé«˜é »æ—¥å¸¸ç”¨è©ã€‚',
                            keywords: ['è‚šå­ç—›', 'åƒå†°', 'é†«ç”Ÿ', 'åƒè—¥']
                        },
                        suggestion: {
                            content: 'å¦‚æœä½ è‚šå­ç—›ï¼Œä½ æ‡‰è©²å»çœ‹é†«ç”Ÿã€‚è¦å¤šå–ç†±æ°´ã€‚ä¸è¦å†åƒå†°äº†ã€‚',
                            analysis: 'ä½¿ç”¨ç°¡å–®çš„ã€Œæ‡‰è©²ã€å’Œã€Œä¸è¦ã€é€²è¡Œå»ºè­°ï¼Œå¥å¼çŸ­å°ã€‚',
                            keywords: ['æ‡‰è©²', 'ç†±æ°´', 'ä¸è¦']
                        }
                    },
                    'C1': {
                        narrative: {
                            content: 'é‘’æ–¼æ˜¨æ—¥æ™šé¤éåº¦æ”å–ç”Ÿå†·é£Ÿç‰©ï¼Œä»Šæ—©è…¹éƒ¨å³å‡ºç¾åŠ‡çƒˆçµç—›ã€‚éš¨å³å‰å¾€è¨ºæ‰€æ±‚è¨ºã€‚ç¶“é†«å¸«åš´è¬¹å•è¨ºèˆ‡è¨ºæ–·å¾Œï¼Œå›‘å’é ˆæœç”¨æ¶ˆç‚è—¥ï¼Œä¸¦å¼·èª¿æ—¥å¸¸é£²é£Ÿæ‡‰åŠ›æ±‚æ¸…æ·¡ï¼Œæ–¹èƒ½é¿å…ç—…æ³å¾©ç™¼ã€‚',
                            analysis: 'ä½¿ç”¨ã€Œé‘’æ–¼ã€ã€ã€Œéåº¦æ”å–ã€ã€ã€ŒåŠ‡çƒˆã€ã€ã€Œå›‘å’ã€ã€ã€Œåš´è¬¹å•è¨ºã€ç­‰æ­£å¼æ›¸é¢èªå’Œè¤‡åˆå¥ï¼Œå±•ç¾é«˜ç´šèªæ°£ã€‚',
                            keywords: ['é‘’æ–¼', 'æ”å–', 'åŠ‡çƒˆçµç—›', 'æ±‚è¨º', 'åŠ›æ±‚æ¸…æ·¡']
                        },
                        suggestion: {
                            content: 'é‡å°é »ç™¼çš„è…¸èƒƒä¸é©ç—‡ç‹€ï¼Œç­†è€…å»ºè­°æ‚¨æ‡‰ç•¶å¯©æ…è©•ä¼°å€‹äººçš„é£²é£Ÿç¿’æ…£ã€‚ä¸å¦¨å¾æˆ’é™¤ç”Ÿå†·ã€è¾›è¾£ç­‰åˆºæ¿€æ€§é£Ÿç‰©è‘—æ‰‹ï¼Œä¸¦é¤Šæˆå®šæ™‚å®šé‡ã€ç´°åš¼æ…¢åš¥çš„è‰¯å¥½ç¿’æ…£ï¼Œé€™æ˜¯ç¶­æŒæ¶ˆåŒ–ç³»çµ±å¥åº·çš„é•·ä¹…ä¹‹è¨ˆã€‚',
                            analysis: 'é‹ç”¨ã€Œç­†è€…å»ºè­°ã€ã€ã€Œå¯©æ…è©•ä¼°ã€ã€ã€Œé•·ä¹…ä¹‹è¨ˆã€ç­‰è¤‡é›œè¡¨é”ï¼Œé«”ç¾æ·±åº¦åˆ†æèˆ‡æ­£å¼å»ºè­°çš„å¥å‹ã€‚',
                            keywords: ['å¯©æ…è©•ä¼°', 'æˆ’é™¤', 'è¾›è¾£', 'ç´°åš¼æ…¢åš¥', 'é•·ä¹…ä¹‹è¨ˆ']
                        }
                    }
                },
                'è²·æ±è¥¿': {
                    'A1': {
                        narrative: {
                            content: 'æˆ‘è¦è²·å’–å•¡ã€‚è«‹å•å¤šå°‘éŒ¢ï¼Ÿçµ¦æˆ‘ä¸€æ¯å¤§æ¯çš„ã€‚è¬è¬ã€‚éŒ¢çµ¦ä½ ã€‚',
                            analysis: 'ç´”ç²¹çš„äº¤æ˜“å°è©±ï¼Œå¥å°¾å¤šç‚ºå•å¥å’Œç¥ˆä½¿å¥ã€‚',
                            keywords: ['å’–å•¡', 'å¤šå°‘éŒ¢', 'å¤§æ¯', 'è¬è¬']
                        },
                        suggestion: {
                            content: 'å¦‚æœä½ æƒ³çœéŒ¢ï¼Œä½ å¯ä»¥å»ä¾¿åˆ©å•†åº—è²·å’–å•¡ã€‚é‚£è£¡æ¯”è¼ƒä¾¿å®œã€‚',
                            analysis: 'ä½¿ç”¨ã€Œæƒ³...å¯ä»¥...ã€çš„å»ºè­°å¥å¼ã€‚',
                            keywords: ['çœéŒ¢', 'ä¾¿åˆ©å•†åº—', 'ä¾¿å®œ']
                        }
                    },
                    'C1': {
                        narrative: {
                            content: 'åœ¨ç³ç‘¯æ»¿ç›®çš„ç²¾å“åº—è£¡ï¼Œæ¶ˆè²»è€…æ­£èºŠèº‡ä¸æ±ºæ–¼è³¼è²·é™é‡æ¬¾æ‰‹éŒ¶ã€‚åº—å“¡ä»¥å°ˆæ¥­çš„èªæ°£è©³ç›¡åœ°ä»‹ç´¹å…¶åŠŸèƒ½èˆ‡ä¿å€¼æ€§ï¼Œæœ€çµ‚ä¿ƒä½¿é¡§å®¢ç°½ä¸‹é«˜é¡å¸³å–®ã€‚é€™å ´æ™¯é«”ç¾äº†é«˜æ¶ˆè²»å¸‚å ´çš„ç²¾ç·»è¡ŒéŠ·å­¸ã€‚',
                            analysis: 'ä½¿ç”¨äº†å¤§é‡æè¿°æ€§èˆ‡æŠ½è±¡è©å½™ï¼Œå¥å‹è¤‡é›œï¼Œé©ç”¨æ–¼è·å ´æˆ–å•†æ¥­æƒ…å¢ƒã€‚',
                            keywords: ['ç³ç‘¯æ»¿ç›®', 'èºŠèº‡ä¸æ±º', 'é™é‡æ¬¾', 'ä¿å€¼æ€§', 'ç²¾ç·»è¡ŒéŠ·å­¸']
                        },
                        suggestion: {
                            content: 'ç•¶æ‚¨é¢å°é«˜å–®åƒ¹å•†å“çš„æ¶ˆè²»æ±ºç­–æ™‚ï¼Œå‹™å¿…ä¿æŒç†æ€§ï¼Œé€²è¡Œå…¨é¢çš„å¸‚å ´èª¿æŸ¥ã€‚è¬¹æ…è€ƒé‡å…¶æ•ˆç”¨èˆ‡å€‹äººè²¡å‹™ç‹€æ³æ˜¯å¦åŒ¹é…ï¼Œæ–¹èƒ½é¿å…ä¸å¿…è¦çš„è¡å‹•æ€§æ¶ˆè²»ã€‚',
                            analysis: 'é‹ç”¨ã€Œå‹™å¿…ä¿æŒç†æ€§ã€ã€ã€Œè¬¹æ…è€ƒé‡ã€ã€ã€Œè¡å‹•æ€§æ¶ˆè²»ã€ç­‰è¤‡é›œè©å½™ï¼Œæä¾›æ­£å¼çš„è²¡å‹™å»ºè­°ã€‚',
                            keywords: ['æ¶ˆè²»æ±ºç­–', 'ç†æ€§', 'è²¡å‹™ç‹€æ³', 'è¡å‹•æ€§æ¶ˆè²»']
                        }
                    }
                }
            },
            'é£²é£Ÿæ–‡åŒ–': {
                'åƒç«é‹': {
                    'A1': {
                        narrative: {
                            content: 'ä»Šå¤©å¾ˆå†·ã€‚æˆ‘å€‘å»åƒç«é‹ã€‚ç«é‹å¾ˆå¥½åƒã€‚æˆ‘å–œæ­¡åƒè‚‰å’Œèœã€‚æ¹¯å¾ˆç‡™ï¼Œè¦å°å¿ƒã€‚',
                            analysis: 'ç°¡å–®æè¿°å¤©æ°£ã€æ´»å‹•å’Œå€‹äººå–œå¥½ã€‚',
                            keywords: ['ç«é‹', 'åƒè‚‰', 'å¾ˆç‡™', 'å°å¿ƒ']
                        },
                        suggestion: {
                            content: 'åƒç«é‹æ™‚ï¼Œä½ å¯ä»¥é»é´›é´¦é‹ã€‚é€™æ¨£å°±å¯ä»¥åƒåˆ°å…©ç¨®å£å‘³çš„æ¹¯åº•ã€‚åˆ¥å¿˜äº†è¦æ²¾é†¬æ²¹ã€‚',
                            analysis: 'ç›´æ¥æä¾›å…·é«”æ“ä½œå»ºè­°ï¼Œä½¿ç”¨ã€Œå¯ä»¥ã€ã€ã€Œåˆ¥å¿˜äº†ã€ç­‰å¥å¼ã€‚',
                            keywords: ['é´›é´¦é‹', 'æ¹¯åº•', 'æ²¾é†¬æ²¹']
                        }
                    }
                },
            }
        };
        // ç‚ºäº†ç¢ºä¿æ‰€æœ‰çµ„åˆéƒ½æœ‰ mock dataï¼Œæœªå®šç¾©çš„çµ„åˆæœƒå›é€€åˆ° A1 ä¾†çœ‹é†«ç”Ÿ
        const getMockContent = (themeName, scenarioName, levelCode, modeId) => {
            const level = levelCode.split(' ')[0].slice(0, 2); // A1, B1, C1
            
            // å˜—è©¦ç²¾ç¢ºåŒ¹é… (ä¸»é¡Œ -> æƒ…å¢ƒ -> ç­‰ç´š)
            const contentBlock = MOCK_CONTENT_BANK[themeName] 
                                    && MOCK_CONTENT_BANK[themeName][scenarioName] 
                                    && MOCK_CONTENT_BANK[themeName][scenarioName][level]
                                    && MOCK_CONTENT_BANK[themeName][scenarioName][level][modeId];

            if (contentBlock) {
                return contentBlock;
            }

            // å›é€€åˆ°é è¨­ A1 å…§å®¹
            return MOCK_CONTENT_BANK['æ—¥å¸¸ç”Ÿæ´»']['çœ‹é†«ç”Ÿ']['A1']['narrative'];
        };

        // --- Mock Data Generators for Trial Mode ---

        const generateMockText = (theme, scenario, level, mode) => {
            const modeId = mode.id;
            const levelCode = level.split(' ')[0]; // A1
            
            const baseContent = getMockContent(theme.name, scenario, levelCode, modeId);

            // å¢åŠ é›£åº¦å€åˆ†åº¦ï¼šC1ç´šçš„æ¨¡æ“¬æ–‡æœ¬æœƒæ›´é•·
            const complexityMultiplier = levelCode.startsWith('C') ? 1.5 : 1; 

            // éš¨æ©Ÿæ·»åŠ ä¸€äº›èªæ°£è©ä¾†æ¨¡æ“¬è‡ªç„¶èªæ°£
            const finalContent = baseContent.content
                .replace('ã€‚', (Math.random() < 0.3 ? 'å•Šï¼' : 'ã€‚'))
                .replace('ã€‚', (Math.random() < 0.4 ? 'ï¼Œä½ çŸ¥é“å—ï¼Ÿ' : 'ã€‚'));
            
            return {
                content: `ã€é«”é©—ç‰ˆæ¨¡æ“¬ - ${mode.name} / ${level}ã€‘\næƒ…å¢ƒï¼š${scenario}\n\n${finalContent}`,
                analysis: `ã€æ¨¡æ“¬ AI åˆ†æã€‘é€™æ®µæ–‡æœ¬å®Œå…¨ç¬¦åˆæ‚¨æ‰€é¸çš„ ${level} ç´šè¦æ±‚ã€‚${baseContent.analysis}`,
                suggestion: `é€™æ˜¯åœ¨ã€Œé«”é©—ç‰ˆã€ä¸‹ç”Ÿæˆçš„æ¨¡æ“¬çµæœã€‚è‹¥æ‚¨åˆ‡æ›è‡³ã€Œæ­£å¼ç‰ˆã€ä¸¦æä¾› API Keyï¼ŒAI å°‡æœƒæ ¹æ“šæ‚¨çš„è¨­å®šå³æ™‚ç”Ÿæˆæ›´å…·å‰µé€ æ€§çš„æ–‡æœ¬ã€‚`,
                keywords: baseContent.keywords.slice(0, Math.floor(baseContent.keywords.length * complexityMultiplier))
            };
        };

        const generateMockRewrite = (originalText, mode) => {
            let rewritten = originalText;
            let analysis = "ã€æ¨¡æ“¬ AI åˆ†æã€‘åœ¨é«”é©—ç‰ˆä¸­ï¼Œæˆ‘å€‘å°æ–‡æœ¬é€²è¡Œäº†åŸºç¤æ›¿æ›ã€‚";

            if (mode.id === 'colloquial') {
                rewritten = originalText
                    .replace(/([ã€‚ï¼ï¼Ÿ])/, 'å–”ï¼')
                    .replace(/ä»Šå¤©/g, 'ä»Šä»”æ—¥')
                    .replace(/çš„/g, 'æ¬¸')
                    .replace(/è«‹/g, 'æ¬¸ï¼Œ');
                analysis = "ã€æ¨¡æ“¬åˆ†æã€‘æ”¹æˆäº†æ›´å£èªçš„èªªæ³•ï¼ŒåŠ å…¥äº†ã€Œå–”ã€ã€ã€Œä»Šä»”æ—¥ã€å’Œã€Œæ¬¸ã€ç­‰å°ç£å£èªç¿’æ…£ï¼ˆé«˜æ¨¡æ“¬ï¼‰ã€‚";
            } else if (mode.id === 'harder') {
                rewritten = originalText
                    .replace(/å¾ˆ/g, 'æ¥µåº¦')
                    .replace(/æƒ³/g, 'æ¸´æœ›')
                    .replace(/çœ‹/g, 'å¯©è¦–')
                    .replace(/åƒ/g, 'äº«ç”¨') + "\n(è«‹æ³¨æ„ï¼Œé€™æ˜¯æ¥µç‚ºæ­£å¼çš„æ›¸é¢èªç‰ˆæœ¬ã€‚)";
                analysis = "ã€æ¨¡æ“¬åˆ†æã€‘ä½¿ç”¨äº†è¼ƒç‚ºæ›¸é¢å’Œå°ˆæ¥­çš„è©å½™ï¼Œæå‡äº†æ–‡æœ¬çš„æ­£å¼åº¦ã€‚å¥å¼æ›´åš´è¬¹ã€‚";
            } else if (mode.id === 'easier') {
                 rewritten = originalText
                    .replace(/([ï¼Œã€‚ï¼ï¼Ÿ])/g, '.')
                    .replace(/å› ç‚º/g, 'æ‰€ä»¥')
                    .replace(/ä¸€å€‹/g, 'ä¸€')
                    .slice(0, 50) + '... (å·²ç°¡åŒ–)';
                analysis = "ã€æ¨¡æ“¬åˆ†æã€‘æ–‡æœ¬è¢«å¤§å¹…ç¸®çŸ­ï¼Œä¸¦ç§»é™¤äº†æ‰€æœ‰è¤‡é›œé€£æ¥è©ï¼Œå¥å¼æ¥µç°¡åŒ–ã€‚";
            }
            
            return {
                content: `ã€é«”é©—ç‰ˆæ¨¡æ“¬æ”¹å¯« - ${mode.name}ã€‘\n${rewritten}`,
                analysis: analysis
            };
        };

        const generateMockQA = (text, type) => {
            const q1 = { id: 1, question: `æ ¹æ“šæ–‡æœ¬å…§å®¹ï¼Œè«‹åˆ¤æ–·é€™æ®µè©±ä¸»è¦ç™¼ç”Ÿåœ¨ä½•ç¨®æƒ…å¢ƒï¼Ÿ`, options: ['A. å­¸æ ¡æ•™å®¤', 'B. é†«é™¢æˆ–è¨ºæ‰€', 'C. ç«è»Šä¸Š', 'D. é€›ç™¾è²¨å…¬å¸'], correctAnswer: 'B. é†«é™¢æˆ–è¨ºæ‰€', explanation: 'æ–‡æœ¬ä¸­æåˆ°äº†ã€Œé†«ç”Ÿã€å’Œã€Œåƒè—¥ã€ç­‰é—œéµè©ï¼Œå› æ­¤æƒ…å¢ƒæ‡‰åœ¨é†«ç™‚å ´æ‰€ã€‚' };
            const q2 = { id: 2, question: `(æ˜¯éé¡Œ) æ–‡æœ¬çš„èªæ°£æ˜¯æ¥µåº¦æ­£å¼çš„æ›¸é¢èªã€‚`, options: ['æ­£ç¢º', 'éŒ¯èª¤'], correctAnswer: 'éŒ¯èª¤', explanation: 'å³ä½¿æ˜¯ C1 ç´šçš„æ–‡æœ¬ï¼Œå…¶èªæ°£ä¹Ÿåªæ˜¯ã€Œæ­£å¼ã€ï¼Œä¸¦éæ¥µç«¯æ›¸é¢èªã€‚' };
            const q3 = { id: 3, question: `æ–‡ä¸­çš„ã€ŒåŠ›æ±‚æ¸…æ·¡ã€çš„ã€ŒåŠ›æ±‚ã€æ˜¯ä»€éº¼æ„æ€ï¼Ÿ`, options: ['A. ç”¨åŠ›å°‹æ‰¾', 'B. ç›¡åŠ›åšåˆ°', 'C. ç¼ºä¹åŠ›é‡', 'D. æƒ³è¦ç½·å·¥'], correctAnswer: 'B. ç›¡åŠ›åšåˆ°', explanation: 'ã€ŒåŠ›æ±‚ã€æ„æŒ‡ç›¡æœ€å¤§çš„åŠªåŠ›å»é”åˆ°æŸå€‹ç›®æ¨™æˆ–è¦æ±‚ã€‚' };

            const baseQuestions = [q1, q2, q3];
            
            if (type.id === 'true_false') return baseQuestions.filter(q => q.options.length === 2);
            if (type.id === 'vocab') return baseQuestions.filter(q => q.question.includes('è©') || q.question.includes('æ„æ€'));
            return baseQuestions;
        };

        // --- Settings Modal Component (API Key Setting) - Moved Before Main Component ---
        const SettingsModal = ({ isOpen, onClose, apiKey, onSave, appMode, setAppMode }) => {
            const [inputKey, setInputKey] = useState(apiKey);
            const [showKey, setShowKey] = useState(false);

            useEffect(() => {
                setInputKey(apiKey);
            }, [apiKey, isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden zoom-in">
                        <div className="bg-slate-800 p-4 flex items-center justify-between">
                            <h3 className="text-white font-bold flex items-center gap-2">
                                <Settings size={20} /> ç³»çµ±è¨­å®š
                            </h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <X size={24} />
                            </button>
                        </div>
                        <div className="p-6">
                            {/* App Mode Selector (for settings convenience) */}
                            <div className="mb-6 pb-4 border-b border-slate-200">
                                <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                    <Globe size={16} className="text-blue-500"/> æ‡‰ç”¨ç¨‹å¼æ¨¡å¼
                                </label>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setAppMode('trial')}
                                        className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${appMode === 'trial' ? 'bg-orange-500 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
                                    >
                                        é«”é©—ç‰ˆ (å…è²»)
                                    </button>
                                    <button 
                                        onClick={() => setAppMode('official')}
                                        className={`flex-1 py-2 rounded-lg text-sm font-bold transition-colors ${appMode === 'official' ? 'bg-blue-500 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
                                    >
                                        æ­£å¼ç‰ˆ (API Key)
                                    </button>
                                </div>
                            </div>

                            {/* API Key Input */}
                            <div className="mb-6">
                                <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                                    <Key size={16} className="text-orange-500"/> Google Gemini API Key
                                </label>
                                <p className="text-xs text-slate-500 mb-3 leading-relaxed">
                                    å•Ÿç”¨ã€Œæ­£å¼ç‰ˆã€æ¨¡å¼éœ€è¦ API Keyã€‚
                                </p>
                                <div className="relative">
                                    <input 
                                        type={showKey ? "text" : "password"}
                                        value={inputKey}
                                        onChange={(e) => setInputKey(e.target.value)}
                                        className="w-full pl-4 pr-10 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-200 focus:border-orange-500 outline-none transition-all font-mono text-sm"
                                        placeholder="è²¼ä¸Šæ‚¨çš„ API Key..."
                                    />
                                    <button 
                                        onClick={() => setShowKey(!showKey)}
                                        className="absolute right-3 top-2.5 text-slate-400 hover:text-slate-600"
                                    >
                                        {showKey ? <EyeOff size={16} /> : <Eye size={16} />}
                                    </button>
                                </div>
                                <div className="mt-2 text-right">
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-blue-500 hover:underline flex items-center justify-end gap-1">
                                        å–å¾— API Key <span className="text-[10px]">â†—</span>
                                    </a>
                                </div>
                            </div>
                            
                            <div className="flex gap-3">
                                <button 
                                    onClick={() => {
                                        setInputKey('');
                                        onSave('');
                                        onClose();
                                    }}
                                    className="flex-1 py-2 px-4 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 font-medium transition-colors"
                                >
                                    æ¸…é™¤ Key
                                </button>
                                <button 
                                    onClick={() => {
                                        onSave(inputKey);
                                        onClose();
                                    }}
                                    className="flex-[2] py-2 px-4 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-bold shadow-lg shadow-orange-200 transition-colors flex items-center justify-center gap-2"
                                >
                                    <Save size={18} /> å„²å­˜ä¸¦å¥—ç”¨
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        function ChineseLearningApp() {
            // API Key & Mode State (V2.0)
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('hua_yu_api_key') || '');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [appMode, setAppMode] = useState(() => localStorage.getItem('hua_yu_app_mode') || 'trial'); // trial or official

            const [activeTab, setActiveTab] = useState('generate');
            const [activeTheme, setActiveTheme] = useState(THEMES[0]);
            const [activeScenario, setActiveScenario] = useState(THEMES[0].scenarios[4]); 
            const [selectedLevel, setSelectedLevel] = useState(LEVELS[2]);
            const [selectedMode, setSelectedMode] = useState(MODES[0]);
            
            // Rewrite State
            const [rewriteOption, setRewriteOption] = useState(REWRITE_OPTIONS[2]);
            const [customRewritePrompt, setCustomRewritePrompt] = useState('');
            const [originalText, setOriginalText] = useState(null);
            const [isComparing, setIsComparing] = useState(false);

            // QA State
            const [qaType, setQaType] = useState(QA_TYPES[0]);
            const [userAnswers, setUserAnswers] = useState({});
            const [showTeacherMode, setShowTeacherMode] = useState(false);

            // AI Tutor State
            const [chatHistory, setChatHistory] = useState([
                { role: 'model', text: 'ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI è¯èªåŠ©æ•™å°è¯ ğŸ˜Šã€‚æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ' }
            ]);
            const [chatInput, setChatInput] = useState('');
            const chatEndRef = useRef(null);

            // UI State
           // ä¿®æ”¹ï¼šåªæœ‰è¢å¹•å¤ å¯¬æ™‚æ‰é è¨­é–‹å•Ÿï¼Œæ‰‹æ©Ÿé è¨­é—œé–‰
const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 1024);
            const [fabOpen, setFabOpen] = useState(false);

            // Data State
            const [generatedText, setGeneratedText] = useState(null);
            const [generatedMeta, setGeneratedMeta] = useState(null);
            const [qaData, setQaData] = useState(null);
            const [multimodalData, setMultimodalData] = useState({ image: null, audio: null });
            // Multimodal Scenario Selection
            const [selectedMultimodalScenario, setSelectedMultimodalScenario] = useState(null);


            const [loadingState, setLoadingState] = useState({
                generate: false, rewrite: false, qa: false, image: false, audio: false, chat: false, mms: false
            });
            const [errorMsg, setErrorMsg] = useState(null);

            // --- Effects & Handlers ---

            // Save Mode Handler
            useEffect(() => {
                localStorage.setItem('hua_yu_app_mode', appMode);
            }, [appMode]);

            // Scroll chat to bottom
            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [chatHistory, activeTab]);

            // Save API Key Handler
            const handleSaveApiKey = (key) => {
                setApiKey(key);
                localStorage.setItem('hua_yu_api_key', key);
            };

            // Check API Key Helper (V2.0 Logic)
            const checkApiKey = (isAPIFunction = true) => {
                if (appMode === 'trial') {
                    setErrorMsg(null);
                    return true;
                }
                
                if (appMode === 'official' && isAPIFunction && (!apiKey || apiKey.trim() === '')) {
                    setIsSettingsOpen(true);
                    setErrorMsg("æ‚¨å·²é¸æ“‡ã€æ­£å¼ç‰ˆã€‘ã€‚è«‹å…ˆè¨­å®šæ‚¨çš„ Google Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚");
                    return false;
                }
                setErrorMsg(null);
                return true;
            };
            
            // --- API Handlers (V2.0 Refactored) ---

            const handleGenerate = async () => {
                if (!checkApiKey()) return;
                setLoadingState(prev => ({ ...prev, generate: true }));
                setErrorMsg(null);
                setQaData(null);
                setMultimodalData({ image: null, audio: null });
                setOriginalText(null);
                setIsComparing(false);
                setSelectedMultimodalScenario(null); // Clear M M Scenario context
                
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate loading time

                if (appMode === 'trial') {
                    const result = generateMockText(activeTheme, activeScenario, selectedLevel, selectedMode);
                    setGeneratedText(result.content);
                    setGeneratedMeta(result);
                    setChatHistory(prev => [...prev, { role: 'model', text: `ã€é«”é©—ç‰ˆã€‘å·²ç‚ºä½ ç”Ÿæˆæ¨¡æ“¬æ•™æã€‚è«‹åˆ‡æ›è‡³æ­£å¼ç‰ˆä»¥ç²å¾—å³æ™‚ AI ç”Ÿæˆå…§å®¹ï¼` }]);
                } else { // Official Mode (Actual API Call)
                    const userPrompt = `è«‹ç‚ºæˆ‘å‰µä½œä¸€ä»½è¯èªæ•™æï¼š- ä¸»é¡Œï¼š${activeTheme.name} - æƒ…å¢ƒï¼š${activeScenario} - ç¨‹åº¦ï¼š${selectedLevel} - å¥å‹æ¨¡å¼ï¼š${selectedMode.name} - è¦æ±‚ï¼šå¿…é ˆæœ‰å…·é«”çš„å¾®å‹èƒŒæ™¯æ•…äº‹ï¼Œèªæ°£éå¸¸è‡ªç„¶ç”Ÿæ´»åŒ–ã€‚`;
                    try {
                        const generationConfig = { 
                            temperature: 0.9, 
                            responseMimeType: "application/json", 
                            responseSchema: { 
                                type: "OBJECT", 
                                properties: { 
                                    content: { type: "STRING" }, 
                                    analysis: { type: "STRING" }, 
                                    keywords: { type: "ARRAY", items: { type: "STRING" } } 
                                } 
                            } 
                        };

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                systemInstruction: { parts: [{ text: BASE_SYSTEM_PROMPT }] },
                                generationConfig: generationConfig
                            })
                        });

                        if (!response.ok) throw new Error("API è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºæˆ–é¡åº¦æ˜¯å¦è¶³å¤ ");
                        const data = await response.json();
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        setGeneratedText(result.content);
                        setGeneratedMeta(result);
                        setChatHistory(prev => [...prev, { role: 'model', text: `æˆ‘å·²ç¶“æ ¹æ“šã€Œ${activeScenario}ã€ç‚ºä½ ç”Ÿæˆäº†æ–°çš„æ•™æã€‚éœ€è¦æˆ‘ç‚ºä½ è§£èªªå…¶ä¸­çš„é‡é»å—ï¼Ÿ` }]);
                    } catch (err) {
                        setErrorMsg(err.message || "ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚");
                    }
                }
                setLoadingState(prev => ({ ...prev, generate: false }));
            };

            const handleRewrite = async () => {
                if (!checkApiKey()) return;
                if (!generatedText) return;
                setLoadingState(prev => ({ ...prev, rewrite: true }));

                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate loading time

                if (!originalText) setOriginalText(generatedText);

                if (appMode === 'trial') {
                    const result = generateMockRewrite(generatedText, rewriteOption);
                    setGeneratedText(result.content);
                    setGeneratedMeta(prev => ({ ...prev, analysis: result.analysis }));
                } else { // Official Mode
                    const specificInstruction = customRewritePrompt.trim() 
                        ? `ç‰¹åˆ¥æŒ‡ä»¤ï¼š${customRewritePrompt}` 
                        : `æ”¹å¯«ç›®æ¨™ï¼šã€${rewriteOption.name}ã€‘`;
                    const rewritePrompt = `è«‹æ”¹å¯«ä»¥ä¸‹æ–‡æœ¬ï¼šåŸæ–‡ï¼š"${generatedText}" ${specificInstruction} è¦æ±‚ï¼š1. ä¿ç•™åŸæ„ï¼Œä½†èªæ°£èˆ‡ç”¨è©éœ€å®Œå…¨ç¬¦åˆæ–°çš„ç›®æ¨™è¨­å®šã€‚2. è«‹åœ¨ analysis ä¸­åˆ—å‡ºå…·é«”çš„æ”¹å¯«é‡é»ã€‚`;

                    try {
                        const generationConfig = { 
                            temperature: 0.8, 
                            responseMimeType: "application/json", 
                            responseSchema: { 
                                type: "OBJECT", 
                                properties: { 
                                    content: { type: "STRING" }, 
                                    analysis: { type: "STRING", description: "æ”¹å¯«é‡é»åˆ†æ" } 
                                } 
                            } 
                        };

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: rewritePrompt }] }],
                                systemInstruction: { parts: [{ text: BASE_SYSTEM_PROMPT }] },
                                generationConfig: generationConfig
                            })
                        });
                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        setGeneratedText(result.content);
                        setGeneratedMeta(prev => ({ ...prev, analysis: result.analysis }));
                    } catch (err) {
                        setErrorMsg("æ”¹å¯«å¤±æ•—");
                    }
                }
                setQaData(null); 
                setLoadingState(prev => ({ ...prev, rewrite: false }));
            };

            const handleQA = async () => {
                if (!checkApiKey()) return;
                if (!generatedText) return;
                setLoadingState(prev => ({ ...prev, qa: true }));
                setUserAnswers({});
                setShowTeacherMode(false);

                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate loading time

                if (appMode === 'trial') {
                    const result = generateMockQA(generatedText, qaType);
                    setQaData(result);
                } else { // Official Mode
                    let promptConstraint = "";
                    if (qaType.id === 'true_false') promptConstraint = "è¨­è¨ˆ 3 é¡Œæ˜¯éé¡Œã€‚é¸é …å›ºå®šç‚º ['æ­£ç¢º', 'éŒ¯èª¤']ã€‚";
                    else if (qaType.id === 'vocab') promptConstraint = "è¨­è¨ˆ 3 é¡Œè©å½™é¸æ“‡é¡Œï¼Œé‡å°æ–‡ä¸­çš„é›£è©æˆ–é—œéµè©é€²è¡Œæ¸¬è©¦ã€‚";
                    else promptConstraint = "è¨­è¨ˆ 3 é¡Œé–±è®€ç†è§£é¸æ“‡é¡Œã€‚";

                    const qaPrompt = `è«‹æ ¹æ“šä»¥ä¸‹æ–‡æœ¬è¨­è¨ˆæ¸¬é©—ï¼šæ–‡æœ¬ï¼š"${generatedText}" ç¨‹åº¦ï¼š${selectedLevel} é¡Œå‹ï¼š${qaType.name} è¦æ±‚ï¼š1. ${promptConstraint} 2. æ¯å€‹é¡Œç›®åŒ…å« id, question, options (é™£åˆ—), correctAnswer (æ­£ç¢ºé¸é …çš„æ–‡å­—å…§å®¹), explanation (è©³è§£)ã€‚`;

                    try {
                        const responseSchema = { 
                            type: "OBJECT", 
                            properties: { 
                                questions: { 
                                    type: "ARRAY", 
                                    items: { 
                                        type: "OBJECT", 
                                        properties: { 
                                            id: { type: "INTEGER" }, 
                                            question: { type: "STRING" }, 
                                            options: { type: "ARRAY", items: { type: "STRING" } }, 
                                            correctAnswer: { type: "STRING" }, 
                                            explanation: { type: "STRING" } 
                                        } 
                                    } 
                                } 
                            } 
                        };

                        const generationConfig = { 
                            responseMimeType: "application/json", 
                            responseSchema: responseSchema
                        };

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: qaPrompt }] }],
                                generationConfig: generationConfig
                            })
                        });

                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        setQaData(result.questions);
                    } catch (err) {
                        setErrorMsg("QA ç”Ÿæˆå¤±æ•—");
                    }
                }
                setLoadingState(prev => ({ ...prev, qa: false }));
            };

            // è¦–è¦ºæ–¹é¢çš„å­¸ç¿’: åœ–åƒç”Ÿæˆ API (Imagen)
            const handleImageGen = async () => {
                if (!checkApiKey()) return;
                if (!generatedText) return;
                setLoadingState(prev => ({ ...prev, image: true }));

                await new Promise(resolve => setTimeout(resolve, 1000));

                if (appMode === 'trial') {
                    setMultimodalData(prev => ({ ...prev, image: "https://placehold.co/400x300/e0f2f7/000000?text=Trial+Image+Placeholder" }));
                } else { // Official Mode
                    const imgPrompt = `A warm, educational style illustration of: ${activeTheme.name}, ${activeScenario}. Flat vector art, soft colors, minimal background.`;
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instances: [{ prompt: imgPrompt }], parameters: { sampleCount: 1 } })
                        });
                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        if (data.predictions?.[0]) {
                            setMultimodalData(prev => ({ ...prev, image: `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}` }));
                        }
                    } catch (err) { setErrorMsg("åœ–åƒç”Ÿæˆå¤±æ•—"); }
                }
                setLoadingState(prev => ({ ...prev, image: false }));
            };

            // å‹•æ…‹æ–¹é¢çš„å­¸ç¿’: èªéŸ³ç”Ÿæˆ API (TTS)
            const handleAudioGen = async () => {
                if (!checkApiKey()) return;
                if (!generatedText) return;
                setLoadingState(prev => ({ ...prev, audio: true }));

                await new Promise(resolve => setTimeout(resolve, 1500));

                if (appMode === 'trial') {
                    setMultimodalData(prev => ({ ...prev, audio: null }));
                    setErrorMsg("é«”é©—ç‰ˆç„¡æ³•æ’­æ”¾èªéŸ³ï¼Œè«‹åˆ‡æ›è‡³æ­£å¼ç‰ˆã€‚");
                } else { // Official Mode
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: generatedText }] }],
                                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } }
                            })
                        });
                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        if (data.candidates?.[0]?.content?.parts?.[0]?.inlineData) {
                            setMultimodalData(prev => ({ ...prev, audio: pcmToWav(data.candidates[0].content.parts[0].inlineData.data) }));
                        }
                    } catch (err) { setErrorMsg("èªéŸ³ç”Ÿæˆå¤±æ•—"); }
                }
                setLoadingState(prev => ({ ...prev, audio: false }));
            };
            
            // å¤šæ¨¡æ…‹æƒ…å¢ƒå­¸ç¿’ (Image-to-Text) è™•ç†å™¨
            const handleMultimodalScenario = async (scenarioItem) => {
                if (!checkApiKey()) return;
                setLoadingState(prev => ({ ...prev, mms: true }));
                setErrorMsg(null);
                setGeneratedText(null);
                setSelectedMultimodalScenario(scenarioItem);
                
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                if (appMode === 'trial') {
                     const result = generateMockMultimodalScenario(scenarioItem);
                     setGeneratedText(result.content);
                     setGeneratedMeta(prev => ({ ...prev, analysis: result.analysis, keywords: result.keywords }));
                } else { // Official Mode (Simulated Image-to-Text)
                    // We simulate the Image-to-Text by using the scenario name as a rich prompt.
                    const userPrompt = `è«‹æ ¹æ“šä»¥ä¸‹æƒ…å¢ƒåç¨±ï¼Œç”Ÿæˆä¸€ç¯‡è©³ç´°çš„è¦–è¦ºè§€å¯Ÿå’Œå°è©±å…§å®¹ï¼Œä¸¦è¨­å®šç‚º B1 ä¸­ç´šç­‰ç´šï¼šã€${scenarioItem.name}ã€‘ã€‚å…§å®¹å¿…é ˆåŒ…å«å ´æ™¯æè¿°å’Œè‡³å°‘å…©å€‹äººç‰©çš„å°è©±ã€‚`;
                    try {
                        const generationConfig = { 
                            temperature: 0.8, 
                            responseMimeType: "application/json", 
                            responseSchema: { 
                                type: "OBJECT", 
                                properties: { 
                                    content: { type: "STRING" }, 
                                    analysis: { type: "STRING" }, 
                                    keywords: { type: "ARRAY", items: { type: "STRING" } } 
                                } 
                            } 
                        };
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                systemInstruction: { parts: [{ text: BASE_SYSTEM_PROMPT }] },
                                generationConfig: generationConfig
                            })
                        });

                        if (!response.ok) throw new Error("API è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºæˆ–é¡åº¦æ˜¯å¦è¶³å¤ ");
                        const data = await response.json();
                        const result = JSON.parse(data.candidates[0].content.parts[0].text);
                        setGeneratedText(`ã€å¤šæ¨¡æ…‹æƒ…å¢ƒå­¸ç¿’ï¼š${scenarioItem.name}ã€‘\n\n${result.content}`);
                        setGeneratedMeta(prev => ({ ...prev, analysis: result.analysis, keywords: result.keywords }));

                    } catch (err) {
                        setErrorMsg(err.message || "æƒ…å¢ƒå…§å®¹ç”Ÿæˆå¤±æ•—ã€‚");
                    }
                }
                setLoadingState(prev => ({ ...prev, mms: false }));
            };


            const handleChatSend = async (messageText) => {
                if (!checkApiKey(false)) return; // Chat is non-critical, only check key in official mode
                const textToSend = messageText || chatInput;
                if (!textToSend.trim()) return;

                const newHistory = [...chatHistory, { role: 'user', text: textToSend }];
                setChatHistory(newHistory);
                setChatInput('');
                setLoadingState(prev => ({ ...prev, chat: true }));

                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate loading time

                let contextPrompt = "";
                if (generatedText) {
                    contextPrompt = `\n[ç•¶å‰å­¸ç¿’æ–‡æœ¬ Context] (ä¸»é¡Œï¼š${activeTheme.name} / æƒ…å¢ƒï¼š${activeScenario})\næ–‡æœ¬å…§å®¹ï¼š"""\n${generatedText}\n"""\n`;
                }

                if (appMode === 'trial') {
                    const mockReply = `ã€é«”é©—ç‰ˆåŠ©æ•™æ¨¡æ“¬ã€‘ä½ æå‡ºçš„å•é¡Œéå¸¸å¥½ï¼${contextPrompt ? 'é‡å°ä½ ç¾åœ¨å­¸ç¿’çš„æ–‡æœ¬ï¼Œ' : ''}æˆ‘å¯ä»¥çµ¦ä½ ä¸€å€‹ç°¡å–®çš„è§£é‡‹ã€‚ä¸éï¼Œå¦‚æœåˆ‡æ›åˆ°æ­£å¼ç‰ˆï¼Œæˆ‘å¯ä»¥æä¾›æ›´æ·±å…¥çš„èªæ³•åˆ†æå–”ï¼ğŸ˜Š`;
                    setChatHistory(prev => [...prev, { role: 'model', text: mockReply }]);
                } else { // Official Mode
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: contextPrompt + "\nä½¿ç”¨è€…å•é¡Œï¼š" + textToSend }] }],
                                systemInstruction: { parts: [{ text: TUTOR_SYSTEM_PROMPT }] }
                            })
                        });

                        if (!response.ok) throw new Error("API Error");
                        const data = await response.json();
                        const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨æœ‰é»å¿™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                        setChatHistory(prev => [...prev, { role: 'model', text: reply }]);
                    } catch (err) {
                        setChatHistory(prev => [...prev, { role: 'model', text: "é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Key èˆ‡ç¶²è·¯ã€‚" }]);
                    }
                }
                setLoadingState(prev => ({ ...prev, chat: false }));
            };

            const handleAnswerSelect = (qId, option) => {
                if (showTeacherMode) return;
                setUserAnswers(prev => ({ ...prev, [qId]: option }));
            };

            const switchTab = (tab) => {
                setActiveTab(tab);
                setFabOpen(false);
            };

            // Get Breadcrumb string
            const breadcrumb = `é¦–é  > ${
                activeTab === 'generate' ? 'æ–‡æœ¬ç”Ÿæˆ' : 
                activeTab === 'rewrite' ? 'æ™ºèƒ½æ”¹å¯«' : 
                activeTab === 'qa' ? 'æ™ºæ…§å•ç­”' :
                activeTab === 'multimodal' ? 'å¤šæ¨¡æ…‹å­¸ç¿’' :
                activeTab === 'ai_tutor' ? 'AI åŠ©æ•™' : 'æœªçŸ¥é é¢'
            } > ${activeTheme.name} > ${activeScenario}`;


            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans flex flex-col">
                    
                    {/* Settings Modal */}
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)}
                        apiKey={apiKey}
                        onSave={handleSaveApiKey}
                        appMode={appMode}
                        setAppMode={setAppMode}
                    />

                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-50 border-b border-orange-100">
                        <div className="max-w-[1600px] mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-slate-100 rounded-lg lg:hidden">
                                    <Menu size={24} className="text-slate-600" />
                                </button>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold text-xl">è¯</div>
                                    <span className="text-xl font-bold tracking-tight text-slate-800">{/* ä¿®æ”¹ï¼šæ‰‹æ©Ÿç‰ˆéš±è— 'ç™¾å¯¶ç®±' ä¸‰å€‹å­—ï¼Œåªé¡¯ç¤º 'è¯èªAI' */}
è¯èª<span className="text-orange-500">AI</span><span className="hidden md:inline">ç™¾å¯¶ç®±</span>

{/* å›é¦–é æŒ‰éˆ• (Reactå¯«æ³•) */}
<a href="index.html" className="flex items-center gap-2 mr-4 text-slate-600 hover:text-orange-500 font-bold no-underline">
    <span className="text-xl">ğŸ </span>
    <span className="hidden md:inline">å›é¦–é </span>
</a>


</span>
                                </div>
                            </div>
                            <nav className="hidden lg:flex items-center gap-1">
                                {[
                                    { id: 'generate', icon: PenTool, label: 'æ–‡æœ¬ç”Ÿæˆ' }, 
                                    { id: 'rewrite', icon: RefreshCw, label: 'æ™ºèƒ½æ”¹å¯«' }, 
                                    { id: 'qa', icon: MessageCircle, label: 'æ™ºæ…§å•ç­”' }, 
                                    { id: 'multimodal', icon: Headphones, label: 'å¤šæ¨¡æ…‹' },
                                    { id: 'ai_tutor', icon: GraduationCap, label: 'AI åŠ©æ•™' }
                                ].map((item) => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-colors ${activeTab === item.id ? 'bg-orange-50 text-orange-600 ring-1 ring-orange-200' : 'text-slate-600 hover:bg-slate-100'}`}>
                                        <item.icon size={16} /> {item.label}
                                    </button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-2">
                                {/* Mode Indicator & Toggle */}
                                <button 
                                    onClick={() => setAppMode(appMode === 'trial' ? 'official' : 'trial')}
                                    className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-colors ${
                                        appMode === 'trial' 
                                            ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' 
                                            : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                                    }`}
                                >
                                    <Globe size={14} /> 
                                    {appMode === 'trial' ? 'é«”é©—ç‰ˆ' : 'æ­£å¼ç‰ˆ'}
                                </button>
                                
                                <button 
                                    onClick={() => setIsSettingsOpen(true)}
                                    className={`p-2 rounded-full transition-colors ${
                                        appMode === 'official' && !apiKey
                                            ? 'bg-red-50 text-red-500 animate-pulse' 
                                            : 'text-slate-500 hover:text-blue-700 hover:bg-blue-50'
                                    }`}
                                    title="è¨­å®š API Key"
                                >
                                    <Settings size={20} />
                                </button>
                                <button className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 text-white rounded-full hover:bg-slate-700 text-sm">
                                    <User size={16} /> <span>ç™»å…¥</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Layout */}
                    
                   <div className="flex flex-1 overflow-hidden max-w-[1600px] mx-auto w-full">
                        {/* Sidebar */}
                        <aside className={`fixed lg:static inset-y-0 left-0 z-40 w-64 bg-white border-r border-slate-200 transform transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full lg:w-0 lg:opacity-0'}`}>
                            <div className="p-4 border-b border-slate-100 bg-orange-50/50"><h2 className="text-sm font-bold text-orange-800 uppercase flex items-center gap-2"><Layout size={16} /> ä¸»é¡Œæƒ…å¢ƒ</h2></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-1">
                                {THEMES.map((theme) => (
                                    <div key={theme.id} className="rounded-lg overflow-hidden">
                                        <button onClick={() => setActiveTheme(theme)} className={`w-full flex items-center justify-between p-3 text-left ${activeTheme.id === theme.id ? 'bg-blue-50 text-blue-800 font-medium' : 'text-slate-600 hover:bg-slate-50'}`}>
                                            <span className="flex items-center gap-2">{theme.icon} {theme.name}</span>
                                            {activeTheme.id === theme.id ? <ChevronDown size={16} /> : <ChevronRight size={16} />}
                                        </button>
                                        {activeTheme.id === theme.id && (<div className="bg-slate-50 px-3 py-2 space-y-1">{theme.scenarios.map((scenario) => (<button key={scenario} onClick={() => setActiveScenario(scenario)} className={`w-full text-left px-3 py-2 text-sm rounded-md ${activeScenario === scenario ? 'bg-white shadow-sm text-orange-600 border-l-4 border-l-orange-500' : 'text-slate-500 hover:bg-slate-200'}`}>{scenario}</button>))}</div>)}
                                    </div>
                                ))}
                            </div>
                        </aside>

                        {/* Workspace */}
                        <main className="flex-1 overflow-y-auto bg-slate-50 p-4 lg:p-8 relative pb-24">
                            {/* Breadcrumb */}
                            <div className="flex items-center gap-2 text-sm text-slate-500 mb-6">
                                {breadcrumb.split(' > ').map((item, index, array) => (
                                    <React.Fragment key={index}>
                                        <span className={`cursor-default ${index === array.length - 1 ? 'text-slate-700 font-medium' : 'hover:text-blue-600'}`}>
                                            {item}
                                        </span>
                                        {index < array.length - 1 && <ChevronRight size={14} />}
                                    </React.Fragment>
                                ))}
                            </div>

                            <div className="grid grid-cols-1 xl:grid-cols-12 gap-6 pb-20">
                                <div className="xl:col-span-12 bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                    
                                    {/* Generate */}
                                    {activeTab === 'generate' && (
                                        <>
                                            <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                                                <div className="p-2 bg-orange-100 rounded-lg text-orange-600"><PenTool size={24} /></div>
                                                <div><h1 className="text-xl font-bold text-slate-800">æ™ºèƒ½æ–‡æœ¬ç”Ÿæˆ</h1><p className="text-sm text-slate-500">é¸æ“‡ç­‰ç´šèˆ‡æ¨¡å¼é–‹å§‹å‰µä½œ</p></div>
                                         </div>

{/* === æ‰‹æ©Ÿç‰ˆå°ˆç”¨ä¸»é¡Œé¸æ“‡å™¨ (Page 1) === */}
<div className="lg:hidden mb-6 p-4 bg-orange-50 rounded-xl border border-orange-100 animate-fade-in">
    <div className="mb-4">
        <label className="block text-xs font-bold text-orange-700 uppercase mb-2">1. é¸æ“‡ä¸»é¡Œ</label>
        <div className="relative">
            <select 
                value={activeTheme.id} 
                onChange={(e) => {
                    const theme = THEMES.find(t => t.id === e.target.value);
                    setActiveTheme(theme);
                    setActiveScenario(theme.scenarios[0]); 
                }}
                className="w-full p-3 rounded-lg border-orange-200 bg-white text-sm font-bold text-slate-700 focus:ring-2 focus:ring-orange-300 outline-none appearance-none shadow-sm"
            >
                {THEMES.map(t => <option key={t.id} value={t.id}>{t.icon} {t.name}</option>)}
            </select>
            <div className="absolute right-3 top-3 pointer-events-none text-orange-400">â–¼</div>
        </div>
    </div>
    <div>
        <label className="block text-xs font-bold text-orange-700 uppercase mb-2">2. é¸æ“‡æƒ…å¢ƒ</label>
        <div className="flex flex-wrap gap-2">
            {activeTheme.scenarios.map(s => (
                <button 
                    key={s} 
                    onClick={() => setActiveScenario(s)}
                    className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-all ${activeScenario === s ? 'bg-orange-500 text-white border-orange-500 shadow-md transform scale-105' : 'bg-white text-slate-600 border-orange-200 hover:border-orange-400'}`}
                >
                    {s}
                </button>
            ))}
        </div>
    </div>
</div>

                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div><label className="block text-sm font-semibold text-slate-700 mb-2">èªè¨€ç­‰ç´š</label><div className="grid grid-cols-2 gap-2">{LEVELS.map((lvl) => (<button key={lvl} onClick={() => setSelectedLevel(lvl)} className={`px-2 py-2 text-xs rounded-lg border ${selectedLevel === lvl ? 'bg-blue-600 text-white' : 'hover:bg-slate-50'}`}>{lvl}</button>))}</div></div>
                                                <div className="md:col-span-2"><label className="block text-sm font-semibold text-slate-700 mb-2">å¥å‹æ¨¡å¼</label><div className="grid grid-cols-1 sm:grid-cols-3 gap-3">{MODES.map((mode) => (<button key={mode.id} onClick={() => setSelectedMode(mode)} className={`p-3 rounded-xl border text-left ${selectedMode.id === mode.id ? 'bg-orange-50 border-orange-400' : 'hover:bg-slate-50'}`}><div className="font-bold text-sm">{mode.name}</div><div className="text-xs text-slate-500">{mode.desc}</div></button>))}</div></div>
                                            </div>
                                            <div className="mt-6 flex justify-end"><button onClick={handleGenerate} disabled={loadingState.generate} className="px-8 py-3 rounded-xl font-bold text-white bg-gradient-to-r from-orange-500 to-orange-600 shadow-lg flex items-center gap-2 hover:opacity-90 disabled:opacity-50">{loadingState.generate ? <RefreshCw className="animate-spin" /> : <Zap />} {loadingState.generate ? 'ç”Ÿæˆä¸­...' : 'ç«‹å³ç”Ÿæˆæ–‡æœ¬'}</button></div>
                                        </>
                                    )}

                                    {/* Rewrite */}
                                    {activeTab === 'rewrite' && (
                                        <>
                                            <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                                                <div className="p-2 bg-green-100 rounded-lg text-green-600"><RefreshCw size={24} /></div>
                                                <div><h1 className="text-xl font-bold text-slate-800">æ™ºèƒ½æ–‡æœ¬æ”¹å¯«</h1><p className="text-sm text-slate-500">è‡ªè¨‚æŒ‡ä»¤æˆ–é¸æ“‡é¢¨æ ¼ï¼Œä¸¦å¯å°ç…§å·®ç•°</p></div>
                                            </div>
                                            {!generatedText ? (
                                                <div className="text-center py-8 text-slate-400">è«‹å…ˆåœ¨ã€Œæ–‡æœ¬ç”Ÿæˆã€é é¢ç”¢ç”Ÿå…§å®¹ã€‚</div>
                                            ) : (
                                                <div className="space-y-4">
                                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                                        {REWRITE_OPTIONS.map((opt) => (
                                                            <button key={opt.id} onClick={() => { setRewriteOption(opt); setCustomRewritePrompt(''); }} className={`p-3 rounded-xl border text-left transition-all ${rewriteOption.id === opt.id && !customRewritePrompt ? 'bg-green-50 border-green-500 ring-1 ring-green-500' : 'hover:bg-slate-50'}`}>
                                                                <div className="font-bold text-slate-800 text-sm">{opt.name}</div>
                                                                <div className="text-xs text-slate-500 mt-1">{opt.desc}</div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                    <div className="flex gap-2 items-center bg-slate-50 p-3 rounded-xl border border-slate-200">
                                                        <PenTool size={18} className="text-slate-500" />
                                                        <input type="text" placeholder="æˆ–è€…... è¼¸å…¥æ‚¨çš„è‡ªè¨‚æŒ‡ä»¤" className="flex-1 bg-transparent border-none outline-none text-sm text-slate-700 placeholder:text-slate-400" value={customRewritePrompt} onChange={(e) => setCustomRewritePrompt(e.target.value)} />
                                                    </div>
                                                    <div className="flex justify-between items-center mt-2">
                                                        {originalText && (<button onClick={() => setIsComparing(!isComparing)} className={`flex items-center gap-2 text-sm px-3 py-1.5 rounded-lg border transition-colors ${isComparing ? 'bg-blue-100 text-blue-700 border-blue-200' : 'text-slate-600 hover:bg-slate-100'}`}><SplitSquareHorizontal size={16} /> {isComparing ? 'é—œé–‰å°ç…§' : 'é–‹å•ŸåŸæ–‡å°ç…§'}</button>)}
                                                        <button onClick={handleRewrite} disabled={loadingState.rewrite} className="px-6 py-2 rounded-lg bg-green-600 text-white font-bold flex items-center gap-2 hover:bg-green-700 disabled:opacity-50 ml-auto">{loadingState.rewrite ? <RefreshCw className="animate-spin" /> : <RefreshCw />} é–‹å§‹æ™ºèƒ½æ”¹å¯«</button>
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {/* QA */}
                                    {activeTab === 'qa' && (
                                        <>
                                            <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                                                <div className="p-2 bg-blue-100 rounded-lg text-blue-600"><MessageCircle size={24} /></div>
                                                <div><h1 className="text-xl font-bold text-slate-800">æ™ºæ…§å•ç­”å»¶ä¼¸</h1><p className="text-sm text-slate-500">é¸æ“‡é¡Œå‹ï¼Œè‡ªå‹•ç”Ÿæˆäº’å‹•å¼æ¸¬é©—</p></div>
                                            </div>
                                            {!generatedText ? <div className="text-center py-8 text-slate-400">è«‹å…ˆåœ¨ã€Œæ–‡æœ¬ç”Ÿæˆã€é é¢ç”¢ç”Ÿå…§å®¹ã€‚</div> : (
                                                <div className="space-y-4">
                                                    <div className="flex gap-2 flex-wrap">
                                                        {QA_TYPES.map(type => (
                                                            <button key={type.id} onClick={() => setQaType(type)} className={`flex-1 px-4 py-3 rounded-xl border text-left transition-all ${qaType.id === type.id ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'hover:bg-slate-50'}`}>
                                                                <div className="font-bold text-slate-800 text-sm">{type.name}</div>
                                                                <div className="text-xs text-slate-500 mt-1">{type.desc}</div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                    <div className="flex justify-end mt-2"><button onClick={handleQA} disabled={loadingState.qa} className="px-6 py-2 rounded-lg bg-blue-600 text-white font-bold flex items-center gap-2 hover:bg-blue-700 disabled:opacity-50">{loadingState.qa ? <RefreshCw className="animate-spin" /> : <Bot />} ç”Ÿæˆæ¸¬é©—</button></div>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {/* Multimodal */}
                                    {activeTab === 'multimodal' && (
                                        <>
                                            <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                                                <div className="p-2 bg-purple-100 rounded-lg text-purple-600"><Headphones size={24} /></div>
                                                <div><h1 className="text-xl font-bold text-slate-800">å¤šæ¨¡æ…‹å­¸ç¿’ä¸­å¿ƒ</h1><p className="text-sm text-slate-500">æ•´åˆè¦–è¦ºã€å‹•æ…‹ã€æƒ…å¢ƒåˆ†æç­‰å¤šå…ƒå­¸ç¿’è³‡æº</p></div>
                                            </div>
                                            
                                            <div className="space-y-6">
                                                
                                                {/* å€å¡Š 1: è¦–è¦ºèˆ‡å‹•æ…‹å­¸ç¿’ (Visual & Dynamic) */}
                                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                                    <h2 className="text-md font-bold text-slate-700 mb-4 flex items-center gap-2"><Sparkles size={16}/> è¦–è¦ºèˆ‡å‹•æ…‹å­¸ç¿’</h2>
                                                    {!generatedText ? <div className="text-center py-4 text-slate-400">è«‹å…ˆåœ¨ã€Œæ–‡æœ¬ç”Ÿæˆã€é é¢ç”¢ç”Ÿå…§å®¹ï¼Œæ‰èƒ½ç”Ÿæˆé…åœ–èˆ‡èªéŸ³ã€‚</div> : (
                                                        <div className="flex gap-4 flex-wrap">
                                                            <button onClick={handleImageGen} disabled={loadingState.image} className="flex-1 min-w-[200px] py-3 rounded-xl bg-purple-50 hover:bg-purple-100 flex flex-col items-center justify-center gap-2 text-purple-700 transition-colors border border-purple-200">
                                                                {loadingState.image ? <RefreshCw className="animate-spin" /> : <ImageIcon size={32} />} 
                                                                <span className="font-bold">è¦–è¦ºæ–¹é¢çš„å­¸ç¿’ (ç”Ÿæˆæ’åœ–)</span>
                                                            </button>
                                                            <button onClick={handleAudioGen} disabled={loadingState.audio} className="flex-1 min-w-[200px] py-3 rounded-xl bg-pink-50 hover:bg-pink-100 flex flex-col items-center justify-center gap-2 text-pink-700 transition-colors border border-pink-200">
                                                                {loadingState.audio ? <RefreshCw className="animate-spin" /> : <Volume2 size={32} />} 
                                                                <span className="font-bold">å‹•æ…‹æ–¹é¢çš„å­¸ç¿’ (ç”ŸæˆèªéŸ³)</span>
                                                            </button>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* å€å¡Š 2: å¤šæ¨¡æ…‹æƒ…å¢ƒå­¸ç¿’ (Image-to-Text) */}
                                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                                    <h2 className="text-md font-bold text-slate-700 mb-4 flex items-center gap-2"><ImageIcon size={16}/> å¤šæ¨¡æ…‹æƒ…å¢ƒå­¸ç¿’ (Image-to-Text)</h2>
                                                    <p className="text-sm text-slate-500 mb-4">é»æ“Šä¸‹æ–¹æƒ…å¢ƒï¼ŒAI å°‡ç‚ºæ‚¨**ç”Ÿæˆ** (æˆ–æ¨¡æ“¬ç”Ÿæˆ) å°æ‡‰çš„è±å¯Œå­¸ç¿’æ–‡æœ¬ï¼š</p>
                                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                                        {SCENARIO_PROMPTS.map((item, index) => (
                                                            <button 
                                                                key={index}
                                                                onClick={() => handleMultimodalScenario(item)}
                                                                disabled={loadingState.mms}
                                                                className={`p-3 rounded-xl border text-left transition-all shadow-sm ${
                                                                    selectedMultimodalScenario?.name === item.name 
                                                                        ? 'bg-blue-100 border-blue-400 ring-2 ring-blue-300' 
                                                                        : 'bg-white border-slate-200 hover:bg-slate-100'
                                                                } disabled:opacity-60`}
                                                            >
                                                                <span className="text-lg mr-1">{item.icon}</span> 
                                                                <div className="font-bold text-sm text-slate-800">{item.name}</div>
                                                                <div className="text-xs text-slate-500">{item.theme}</div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                    {loadingState.mms && <div className="mt-4 text-center text-blue-500 font-medium flex items-center justify-center gap-2"><RefreshCw size={16} className="animate-spin"/> æ­£åœ¨ç”Ÿæˆæƒ…å¢ƒæ–‡æœ¬...</div>}

                                                </div>
                                            </div>
                                        </>
                                    )}

                                    {/* AI Tutor */}
                                    {activeTab === 'ai_tutor' && (
                                        <div className="flex flex-col h-[600px] relative">
                                            <div className="flex items-center gap-3 mb-4 pb-4 border-b border-slate-100">
                                                <div className="p-2 bg-amber-100 rounded-lg text-amber-600"><GraduationCap size={24} /></div>
                                                <div><h1 className="text-xl font-bold text-slate-800">AI æ™ºèƒ½åŠ©æ•™</h1><p className="text-sm text-slate-500">æœ‰ä»»ä½•è¯èªå­¸ç¿’çš„å•é¡Œï¼Œéƒ½å¯ä»¥å•æˆ‘å–”ï¼</p></div>
                                            </div>
                                            <div className="flex-1 overflow-y-auto pr-2 space-y-4 mb-4">
                                                {chatHistory.map((msg, idx) => (
                                                    <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${msg.role === 'user' ? 'bg-slate-700 text-white' : 'bg-amber-100 text-amber-700'}`}>{msg.role === 'user' ? <UserCircle2 size={20} /> : <Bot size={20} />}</div>
                                                        <div className={`p-3 rounded-2xl max-w-[80%] text-sm leading-relaxed ${msg.role === 'user' ? 'bg-slate-700 text-white rounded-tr-none' : 'bg-slate-100 text-slate-800 rounded-tl-none'}`}>{msg.text}</div>
                                                    </div>
                                                ))}
                                                {loadingState.chat && (<div className="flex gap-3"><div className="w-8 h-8 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center"><Bot size={20} /></div><div className="p-3 rounded-2xl bg-slate-100 text-slate-500 text-sm flex items-center gap-2"><RefreshCw size={14} className="animate-spin"/> åŠ©æ•™æ€è€ƒä¸­...</div></div>)}
                                                <div ref={chatEndRef} />
                                            </div>
                                            {generatedText && (
                                                <div className="mb-4">
                                                    <div className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide flex items-center gap-1"><Sparkles size={12}/> é‡å°ç•¶å‰æ–‡æœ¬çš„å¿«æ·æå•</div>
                                                    <div className="flex gap-2 flex-wrap">
                                                        {TUTOR_SUGGESTIONS.map((sug, idx) => (<button key={idx} onClick={() => handleChatSend(sug.prompt)} disabled={loadingState.chat} className="text-xs px-3 py-1.5 bg-white border border-slate-200 hover:border-amber-300 hover:bg-amber-50 text-slate-600 rounded-full transition-colors shadow-sm">{sug.label}</button>))}
                                                    </div>
                                                </div>
                                            )}
                                            <div className="mt-auto flex items-center gap-2 bg-white p-2 rounded-xl border border-slate-200 shadow-sm focus-within:ring-2 focus-within:ring-amber-200 focus-within:border-amber-400 transition-all">
                                                <input type="text" className="flex-1 bg-transparent border-none outline-none text-sm px-2 py-1" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..." value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleChatSend()} />
                                                <button onClick={() => handleChatSend()} disabled={loadingState.chat || !chatInput.trim()} className="p-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 disabled:opacity-50 transition-colors"><Send size={18} /></button>
                                            </div>
                                        </div>
                                    )}

                                    {errorMsg && <div className="mt-4 p-3 bg-red-50 text-red-600 rounded-lg flex items-center gap-2"><AlertCircle size={16}/>{errorMsg}</div>}
                                </div>

                                {/* Results Area */}
                                {generatedText && activeTab !== 'ai_tutor' && (
                                    <div className="xl:col-span-12 flex flex-col gap-6 fade-in">
                                        <div className="flex flex-col xl:flex-row gap-6">
                                            <div className="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                                                <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-slate-50">
                                                    <span className="font-bold text-slate-700 flex items-center gap-2"><BookOpen size={18} className="text-orange-600"/> {isComparing ? 'åŸæ–‡ vs æ”¹å¯«' : 'å­¸ç¿’æ–‡æœ¬'}</span>
                                                    <div className="flex gap-2"><button className="p-2 text-slate-500 hover:bg-white rounded"><Layout size={16} /></button><button className="p-2 text-slate-500 hover:bg-white rounded"><Download size={16} /></button></div>
                                                </div>
                                                <div className="relative">
                                                    {isComparing && originalText ? (
                                                        <div className="grid grid-cols-2 divide-x divide-slate-100 min-h-[200px]">
                                                            <div className="p-6 text-base leading-relaxed text-slate-500 whitespace-pre-wrap font-serif bg-slate-50"><div className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wide">åŸå§‹æ–‡æœ¬</div>{originalText}</div>
                                                            <div className="p-6 text-base leading-relaxed text-slate-800 whitespace-pre-wrap font-serif bg-white"><div className="text-xs font-bold text-green-600 mb-2 uppercase tracking-wide">æ”¹å¯«å¾Œ</div>{generatedText}</div>
                                                        </div>
                                                    ) : (
                                                        <div className="p-6 text-lg leading-relaxed text-slate-800 whitespace-pre-wrap font-serif relative min-h-[200px]"><div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><Sparkles size={80} /></div>{generatedText}</div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="w-full xl:w-80 flex flex-col gap-4">
                                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200"><h3 className="text-sm font-bold text-slate-500 uppercase mb-3 flex items-center gap-2"><BarChart3 size={16}/> AI åŠ©æ•™åˆ†æ</h3><p className="text-sm text-slate-600 leading-relaxed">{generatedMeta?.analysis || "æš«ç„¡åˆ†æ"}</p></div>
                                                {activeTab === 'multimodal' && multimodalData.image && (<div className="bg-white p-2 rounded-2xl shadow-sm border border-slate-200"><img src={multimodalData.image} alt="Scene" className="w-full rounded-xl" /></div>)}
                                                {activeTab === 'multimodal' && multimodalData.audio && (<div className="bg-pink-50 p-4 rounded-2xl border border-pink-100 flex flex-col gap-2"><div className="text-xs font-bold text-pink-700 uppercase">AI èªéŸ³æ’­æ”¾</div><audio controls src={multimodalData.audio} className="w-full h-8" /></div>)}
                                            </div>
                                        </div>
                                        {activeTab === 'qa' && qaData && (
                                            <div className="bg-white rounded-2xl shadow-sm border border-blue-200 overflow-hidden">
                                                <div className="bg-blue-50 px-6 py-4 border-b border-blue-100 font-bold text-blue-800 flex items-center justify-between"><div className="flex items-center gap-2"><HelpCircle size={18} /> {qaType.name}</div><button onClick={() => setShowTeacherMode(!showTeacherMode)} className="text-xs flex items-center gap-1 px-3 py-1.5 rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors font-medium">{showTeacherMode ? <><EyeOff size={14}/> éš±è—ç­”æ¡ˆ (å­¸ç”Ÿæ¨¡å¼)</> : <><Eye size={14}/> é¡¯ç¤ºç­”æ¡ˆ (æ•™å¸«æ¨¡å¼)</>}</button></div>
                                                <div className="p-6 grid gap-6">
                                                    {qaData.map((q, idx) => {
                                                        const userAnswer = userAnswers[q.id];
                                                        const isCorrect = userAnswer === q.correctAnswer;
                                                        const showResult = showTeacherMode || userAnswer;
                                                        return (
                                                            <div key={q.id} className="border-b border-slate-100 last:border-0 pb-6 last:pb-0">
                                                                <div className="font-bold text-slate-800 mb-3 flex gap-2"><span className="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0">{idx + 1}</span>{q.question}</div>
                                                                {q.options && (<div className="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-3 pl-8">{q.options.map((opt, oid) => { let optionClass = "text-sm p-3 rounded-lg border cursor-pointer transition-all "; if (showResult) { if (opt === q.correctAnswer) optionClass += "bg-green-100 border-green-300 text-green-800 font-medium "; else if (opt === userAnswer && opt !== q.correctAnswer) optionClass += "bg-red-50 border-red-200 text-red-600 "; else optionClass += "bg-slate-50 border-slate-100 text-slate-400 opacity-60 "; } else { optionClass += "bg-white border-slate-200 hover:bg-blue-50 hover:border-blue-300 text-slate-700 "; } return (<div key={oid} onClick={() => handleAnswerSelect(q.id, opt)} className={optionClass}><div className="flex justify-between items-center">{opt}{showResult && opt === q.correctAnswer && <CheckCircle2 size={16} className="text-green-600" />}{showResult && opt === userAnswer && opt !== q.correctAnswer && <XCircle size={16} className="text-red-500" />}</div></div>); })}</div>)}
                                                                {showResult && (<div className="pl-8 mt-3"><div className={`text-sm p-3 rounded-lg ${isCorrect || showTeacherMode ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'}`}><span className="font-bold mr-2">è©³è§£ï¼š</span>{q.explanation}</div></div>)}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
{/* === æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°è¦½åˆ— (Page 1) === */}
<div className="lg:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around items-center p-2 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
    {[
        { id: 'generate', icon: PenTool, label: 'ç”Ÿæˆ' },
        { id: 'rewrite', icon: RefreshCw, label: 'æ”¹å¯«' },
        { id: 'qa', icon: MessageCircle, label: 'å•ç­”' },
        { id: 'multimodal', icon: Headphones, label: 'å¤šæ¨¡æ…‹' },
        { id: 'ai_tutor', icon: GraduationCap, label: 'åŠ©æ•™' }
    ].map((item) => (
        <button 
            key={item.id} 
            onClick={() => setActiveTab(item.id)} 
            className={`flex flex-col items-center justify-center w-full py-1 ${activeTab === item.id ? 'text-orange-600' : 'text-slate-400'}`}
        >
            <item.icon size={20} />
            <span className="text-[10px] mt-1 font-medium">{item.label}</span>
        </button>
    ))}
</div>
                    {/* FAB */}
                    <div className="fixed bottom-8 right-8 z-50 flex flex-col items-end gap-3">
                        {fabOpen && (<div className="flex flex-col gap-3 mb-2 fade-in">{[{ id: 'rewrite', label: 'æ”¹å¯«', color: 'bg-green-500', icon: RefreshCw }, { id: 'qa', label: 'å•ç­”', color: 'bg-blue-500', icon: MessageCircle }, { id: 'multimodal', label: 'å¤šæ¨¡æ…‹', color: 'bg-purple-500', icon: Headphones }, { id: 'ai_tutor', label: 'AI åŠ©æ•™', color: 'bg-amber-500', icon: GraduationCap }].map((action) => (<button key={action.id} onClick={() => switchTab(action.id)} className={`flex items-center gap-3 pr-2 pl-4 py-2 rounded-full shadow-lg text-white hover:scale-105 transition-transform ${action.color}`}><span className="text-sm font-medium">{action.label}</span><span className="bg-white/20 p-1.5 rounded-full"><action.icon size={16} /></span></button>))}</div>)}
                        <button onClick={() => setFabOpen(!fabOpen)} className={`p-4 rounded-full shadow-2xl text-white transition-all transform hover:scale-110 ${fabOpen ? 'bg-slate-700 rotate-45' : 'bg-orange-500'}`}>{fabOpen ? <X size={28} /> : <Menu size={28} />}</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChineseLearningApp />);
    </script>
</body>
</html>