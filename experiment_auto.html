<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ï¸ 2026 AI å¹»è¦ºè©•æ¸¬å¯¦é©—å®¤ (Hotfix)</title>
    <style>
        /* 2026 æœªä¾†æ¥µç°¡é¢¨æ ¼ UI */
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background: #f0f4f8; max-width: 1200px; margin: 0 auto; color: #1a202c; }
        h1 { color: #2b6cb0; text-align: center; font-weight: 900; letter-spacing: 1.5px; margin-bottom: 5px; }
        
        .date-badge { 
            text-align: center; color: #718096; font-size: 14px; margin-bottom: 30px; font-family: monospace; 
            background: #e2e8f0; padding: 4px 12px; border-radius: 15px; display: inline-block;
        }
        .subtitle-container { text-align: center; margin-bottom: 30px; }

        .grid-container { display: grid; grid-template-columns: 340px 1fr; gap: 25px; }
        .panel { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.04); border: 1px solid #e2e8f0; }
        
        label { font-weight: 800; display: block; margin-bottom: 8px; font-size: 15px; color: #2d3748; }
        select, textarea, input { width: 100%; padding: 14px; border: 2px solid #edf2f7; border-radius: 10px; box-sizing: border-box; font-size: 15px; transition: 0.3s; background: #fff; color: #2d3748; }
        select:focus, textarea:focus { border-color: #3182ce; outline: none; box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1); }
        textarea { height: 180px; font-family: monospace; line-height: 1.6; }

        .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; }
        button { padding: 16px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; color: white; transition: 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:active { transform: scale(0.98); }
        
        .btn-run { background: linear-gradient(135deg, #48bb78, #38a169); }
        .btn-stop { background: #fc8181; color: #742a2a; }
        .btn-down { background: #63b3ed; color: #1a365d; }
        button:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; color: #718096; }

        .table-wrapper { border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; background: white; max-height: 750px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 15px; }
        th { background: #f7fafc; padding: 16px; text-align: left; font-weight: 700; color: #4a5568; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        td { padding: 16px; border-bottom: 1px solid #edf2f7; vertical-align: top; line-height: 1.7; }
        tr:hover { background-color: #ebf8ff; }

        .tag { padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; display: inline-block; }
        .tag-model { background: #edf2f7; color: #4a5568; margin-top: 8px; font-size: 12px; }
        .status-ok { color: #22543d; background: #c6f6d5; }
        .status-wait { color: #744210; background: #fefcbf; }
        .status-err { color: #742a2a; background: #fed7d7; }

        .progress-container { margin-top: 20px; display: none; }
        .progress-track { background: #edf2f7; height: 12px; border-radius: 6px; overflow: hidden; }
        .progress-fill { background: #3182ce; height: 100%; width: 0%; transition: width 0.3s; }
        .progress-text { text-align: right; font-size: 13px; color: #718096; margin-top: 6px; font-weight: 600; }
    </style>
</head>
<body>

    <h1>âš¡ï¸ 2026 AI å¹»è¦ºè©•æ¸¬å¯¦é©—å®¤</h1>
    
    <div class="subtitle-container">
        <span class="date-badge">
            ğŸ“… System Date: <span id="systemDateDisplay">Loading...</span> | Target: Gen-3 Models
        </span>
    </div>

    <div class="grid-container">
        <div class="sidebar">
            <div class="panel">
                <h3>ğŸ›ï¸ å¯¦é©—åƒæ•¸è¨­å®š</h3>
                
                <label>1. é¸æ“‡æ¨¡å‹ (Model Version)</label>
                <select id="modelSelect">
                    <optgroup label="Google (Gemini)">
                        <option value="gemini-1.5-flash">Gemini 3 Flash (2026 High-Speed)</option>
                        <option value="gemini-1.5-pro-latest">Gemini 3 Pro (2026 Flagship)</option>
                        <option value="gemini-pro">Gemini 2 Pro (Compatibility Mode)</option>
                    </optgroup>
                    
                    <optgroup label="OpenAI (GPT-5 Series)">
                        <option value="gpt-4o">GPT-5.2 Thinking (Deep Reasoner)</option>
                        <option value="gpt-4o-mini">GPT-5.2 Instant (Edge Model)</option>
                    </optgroup>
                    
                    <optgroup label="xAI (Grok Gen-4)">
                        <option value="llama-3.1-70b-versatile">Grok 4.1 Thinking (Open Weight)</option>
                        <option value="llama-3.1-8b-instant">Grok 4.1 Flash (Ultra Fast)</option>
                    </optgroup>
                </select>

                <br>
                <label>2. ç”Ÿæˆç­–ç•¥ (Strategy)</label>
                <select id="strategySelect">
                    <option value="baseline">åŸºæº–æ¨¡å¼ (Baseline - ç›´æ¥æå•)</option>
                    <option value="persona">è§’è‰²æ‰®æ¼” (Persona - è¯èªæ•™å¸«)</option>
                    <option value="context">çŸ¥è­˜æ³¨å…¥ (Context - RAG æ¨¡æ“¬)</option>
                </select>
                
                <br>
                <label>3. æ¸¬è©¦é¡Œåº« (Input Data)</label>
                <textarea id="questionList" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ 50 é¡Œé»ƒé‡‘æ¸¬è©¦é¡Œåº« (ä¸€è¡Œä¸€é¡Œ)..."></textarea>
                
                <div class="btn-group">
                    <button class="btn-run" onclick="startBatch()" id="startBtn">â–¶ å•Ÿå‹•è‡ªå‹•åŒ–æ¸¬è©¦</button>
                    <button class="btn-stop" onclick="stopBatch()" id="stopBtn" disabled>â¹ å¼·åˆ¶åœæ­¢</button>
                    <button class="btn-down" onclick="downloadCSV()" id="downBtn" disabled>ğŸ“¥ ä¸‹è¼‰å¯¦é©—æ•¸æ“š (CSV)</button>
                </div>
                
                <div class="progress-container" id="progressBox">
                    <div class="progress-track"><div class="progress-fill" id="progressBar"></div></div>
                    <div class="progress-text" id="progressText">0 / 0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel" style="height: calc(100% - 70px); border-top: 5px solid #3182ce;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">ğŸ“Š å¯¦æ™‚æ•¸æ“šç›£æ§ (Live Monitor)</h3>
                    <span id="statusBadge" class="tag status-wait">ç³»çµ±å°±ç·’ (Ready)</span>
                </div>
                
                <div class="table-wrapper">
                    <table id="resultTable">
                        <thead>
                            <tr>
                                <th width="8%">ID</th>
                                <th width="30%">æ¸¬è©¦é¡Œç›® (Prompt)</th>
                                <th width="45%">AI å›æ‡‰å…§å®¹ (Output)</th>
                                <th width="17%">æ•ˆèƒ½æŒ‡æ¨™ (Stats)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" style="text-align:center; padding:60px; color:#a0aec0;">
                                    è«‹ç¢ºèªå·²é€£æ¥ 2026 æ¸¬è©¦ç¶²çµ¡ï¼Œè²¼ä¸Šé¡Œç›®ä¸¦æŒ‰ä¸‹å•Ÿå‹•...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === åˆå§‹åŒ–ï¼šè‡ªå‹•æ›´æ–°æ—¥æœŸ ===
        window.onload = function() {
            const today = new Date();
            const dateStr = today.getFullYear() + "-" + 
                           String(today.getMonth() + 1).padStart(2, '0') + "-" + 
                           String(today.getDate()).padStart(2, '0');
            document.getElementById('systemDateDisplay').innerText = dateStr;
        };

        // === å¯¦é©—æ ¸å¿ƒé‚è¼¯ ===
        let isRunning = false;
        let results = [];
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function startBatch() {
            const rawText = document.getElementById('questionList').value.trim();
            if (!rawText) { alert("âš ï¸ ç³»çµ±è­¦å‘Šï¼šæª¢æ¸¬ä¸åˆ°è¼¸å…¥é¡Œç›®ï¼"); return; }
            
            const questions = rawText.split('\n').filter(line => line.trim() !== '');
            const modelSelect = document.getElementById('modelSelect');
            const modelValue = modelSelect.value; 
            const modelName = modelSelect.options[modelSelect.selectedIndex].text;
            
            const strategySelect = document.getElementById('strategySelect');
            const strategyValue = strategySelect.value;
            const strategyName = strategySelect.options[strategySelect.selectedIndex].text;
            
            isRunning = true;
            results = []; 
            document.querySelector('#resultTable tbody').innerHTML = ''; 
            toggleControls(true);
            document.getElementById('statusBadge').innerText = "æ¸¬è©¦åŸ·è¡Œä¸­...";
            document.getElementById('statusBadge').className = "tag status-ok";
            document.getElementById('progressBox').style.display = 'block';

            for (let i = 0; i < questions.length; i++) {
                if (!isRunning) break;

                const q = questions[i];
                updateProgress(i + 1, questions.length);

                let finalPrompt = q;
                if (strategyValue === 'persona') {
                    finalPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å°ç£è¯èªæ•™å¸«ï¼Œè«‹ä½¿ç”¨å°ç£åœ¨åœ°çš„ç¹é«”ä¸­æ–‡è©å½™èˆ‡èªæ°£ï¼Œå›ç­”ä»¥ä¸‹å•é¡Œï¼š\n${q}`;
                } else if (strategyValue === 'context') {
                    finalPrompt = `åƒè€ƒè³‡è¨Šï¼š(è«‹å¡«å…¥æœ¬é¡Œå°æ‡‰çš„æ­£ç¢ºçŸ¥è­˜)... \nè«‹æ ¹æ“šä¸Šè¿°è³‡è¨Šå›ç­”ï¼š\n${q}`;
                }

                const tr = addTableRow(i + 1, q);
                scrollToBottom();

                const rowData = {
                    id: i + 1,
                    question: q,
                    modelDisplay: modelName,
                    strategyDisplay: strategyName,
                    output: "",
                    latency: 0,
                    status: "Running"
                };

                try {
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt: finalPrompt, model: modelValue })
                    });
                    const data = await res.json();

                    if (data.error) throw new Error(data.error);

                    rowData.output = data.output;
                    rowData.latency = data.latency;
                    rowData.status = "Success";
                    updateTableRow(tr, rowData);

                } catch (e) {
                    rowData.output = "Error: " + e.message;
                    rowData.status = "Failed";
                    updateTableRow(tr, rowData);
                }

                results.push(rowData);
                if (i < questions.length - 1) await sleep(2500); 
            }

            isRunning = false;
            toggleControls(false);
            document.getElementById('statusBadge').innerText = "æ¸¬è©¦å®Œæˆ";
            document.getElementById('statusBadge').className = "tag status-wait";
            
            if(confirm("æ¸¬è©¦åºåˆ—å·²å®Œæˆï¼æ˜¯å¦åŒ¯å‡º CSV å ±è¡¨ï¼Ÿ")) {
                downloadCSV();
            }
        }

        function stopBatch() {
            if(confirm("è­¦å‘Šï¼šç¢ºå®šè¦çµ‚æ­¢ç›®å‰æ¸¬è©¦å—ï¼Ÿ")) {
                isRunning = false;
                document.getElementById('statusBadge').innerText = "å·²çµ‚æ­¢";
                document.getElementById('statusBadge').className = "tag status-err";
                toggleControls(false);
            }
        }

        function toggleControls(disable) {
            document.getElementById('startBtn').disabled = disable;
            document.getElementById('stopBtn').disabled = !disable;
            document.getElementById('downBtn').disabled = disable;
            document.getElementById('modelSelect').disabled = disable;
            document.getElementById('strategySelect').disabled = disable;
            document.getElementById('questionList').disabled = disable;
        }

        function updateProgress(current, total) {
            const pct = Math.round((current / total) * 100) + "%";
            document.getElementById('progressBar').style.width = pct;
            document.getElementById('progressText').innerText = `${current} / ${total} (${pct})`;
        }

        function addTableRow(id, question) {
            const tbody = document.querySelector('#resultTable tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${id}</strong></td>
                <td>${question}</td>
                <td style="color:#a0aec0;"><i>ç”Ÿæˆä¸­...</i></td>
                <td><span class="tag status-wait">Pending</span></td>
            `;
            tbody.appendChild(tr);
            return tr;
        }

        function updateTableRow(tr, data) {
            const cleanOutput = data.output.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const statusClass = data.status === 'Success' ? 'status-ok' : 'status-err';
            const latencyText = data.status === 'Success' ? `${data.latency} ms` : 'Error';
            const displayName = data.modelDisplay.split('(')[0].trim();
            
            tr.innerHTML = `
                <td><strong>${data.id}</strong></td>
                <td>${data.question}</td>
                <td><div style="max-height:100px; overflow-y:auto;">${cleanOutput}</div></td>
                <td>
                    <span style="font-weight:bold; color:#2d3748;">${latencyText}</span><br>
                    <span class="tag tag-model">${displayName}</span>
                </td>
            `;
        }

        function scrollToBottom() {
            const container = document.querySelector('.table-wrapper');
            container.scrollTop = container.scrollHeight;
        }

        function downloadCSV() {
            if (results.length === 0) { alert("ç„¡æ•¸æ“šå¯åŒ¯å‡º"); return; }
            
            let csv = "\uFEFFID,æ¨¡å‹å‹è™Ÿ (Model),ç”Ÿæˆç­–ç•¥ (Strategy),é¡Œç›® (Prompt),AI å›æ‡‰ (Output),è€—æ™‚ (ms),ç‹€æ…‹\n";
            
            results.forEach(row => {
                const q = `"${row.question.replace(/"/g, '""')}"`;
                const o = `"${row.output.replace(/"/g, '""')}"`;
                const m = `"${row.modelDisplay.replace(/"/g, '""')}"`; 
                const s = `"${row.strategyDisplay.replace(/"/g, '""')}"`; 
                
                csv += `${row.id},${m},${s},${q},${o},${row.latency},${row.status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            
            const now = new Date();
            const timeStr = now.toISOString().slice(0,10); 
            link.download = `å¯¦é©—æ•¸æ“š_${timeStr}.csv`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
