<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ï¸ ç§‘å±•è‡ªå‹•åŒ–å¯¦é©—å®¤ (SOTA Edition)</title>
    <style>
        /* å°ˆæ¥­ç§‘ç ”é¢¨æ ¼ UI */
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background: #f0f2f5; max-width: 1200px; margin: 0 auto; color: #333; }
        h1 { color: #2c3e50; text-align: center; font-weight: 800; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; font-family: monospace; }
        
        .grid-container { display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
        .panel { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); margin-bottom: 20px; border-top: 4px solid #2c3e50; }
        
        label { font-weight: bold; display: block; margin-bottom: 8px; font-size: 14px; color: #444; }
        select, textarea, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; transition: all 0.2s; background: #fff; }
        select:focus, textarea:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        textarea { height: 150px; font-family: monospace; line-height: 1.5; resize: vertical; }

        /* æŒ‰éˆ•è¨­è¨ˆ */
        .btn-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        button { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: bold; color: white; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:active { transform: translateY(1px); }
        .btn-run { background: linear-gradient(135deg, #27ae60, #2ecc71); box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        .btn-run:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }
        .btn-stop { background: #e74c3c; }
        .btn-down { background: #3498db; }

        /* é€²åº¦æ¢ */
        .progress-box { margin-top: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; height: 8px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: #27ae60; transition: width 0.3s ease; }
        .progress-text { text-align: center; font-size: 12px; color: #666; margin-top: 5px; font-weight: bold; }

        /* çµæœè¡¨æ ¼ */
        .table-wrapper { border: 1px solid #eee; border-radius: 8px; overflow: hidden; background: white; max-height: 650px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: 600; color: #444; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; vertical-align: top; line-height: 1.6; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8f9fa; }
        
        .tag { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; display: inline-block; }
        .tag-time { background: #e3f2fd; color: #1976d2; font-family: monospace; }
        .status-ok { color: #27ae60; background: #e8f8f5; }
        .status-err { color: #c0392b; background: #fdedec; }
        .status-wait { color: #f39c12; background: #fef9e7; }
    </style>
</head>
<body>

    <h1>âš¡ï¸ ç§‘å±•è‡ªå‹•åŒ–å¯¦é©—å®¤ (SOTA Edition)</h1>
    <p class="subtitle">Real-time Benchmarking: Llama 3.1 vs GPT-4o vs Gemini 1.5</p>

    <div class="grid-container">
        <div class="sidebar">
            <div class="panel">
                <h3>ğŸ› ï¸ å¯¦é©—åƒæ•¸ (Parameters)</h3>
                
                <label>1. é¸æ“‡æ¨¡å‹ (Model)</label>
                <select id="modelSelect">
                    <optgroup label="Google (Gemini)">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (Google æœ€æ–°è¼•é‡)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (Google ç›®å‰æœ€å¼·)</option>
                    </optgroup>
                    <optgroup label="OpenAI (GPT-4o)">
                        <option value="gpt-4o-mini">GPT-4o Mini (OpenAI æœ€æ–°è¼•é‡)</option>
                        <option value="gpt-4o">GPT-4o Omni (OpenAI ç›®å‰æœ€å¼·)</option>
                    </optgroup>
                    <optgroup label="Groq (Llama 3.1)">
                        <option value="llama-3.1-8b-instant">Llama 3.1 8B (Meta æœ€æ–°é–‹æº-å¿«)</option>
                        <option value="llama-3.1-70b-versatile">Llama 3.1 70B (Meta æœ€æ–°é–‹æº-å¼·)</option>
                    </optgroup>
                </select>

                <br>
                <label>2. ç”Ÿæˆç­–ç•¥ (Strategy)</label>
                <select id="strategySelect">
                    <option value="baseline">Baseline (Zero-shot)</option>
                    <option value="persona">Persona (Role-playing)</option>
                    <option value="context">Context (RAG Simulation)</option>
                </select>
                
                <br>
                <label>3. æ¸¬è©¦é¡Œåº« (Input Data)</label>
                <textarea id="questionList" placeholder="è«‹è²¼ä¸Šä½ çš„ 50 é¡Œé»ƒé‡‘é¡Œåº«..."></textarea>
                
                <div class="btn-group">
                    <button class="btn-run" onclick="startBatch()" id="startBtn">â–¶ é–‹å§‹è‡ªå‹•æ¸¬è©¦</button>
                    <button class="btn-stop" onclick="stopBatch()" id="stopBtn" disabled>â¹ å¼·åˆ¶åœæ­¢</button>
                    <button class="btn-down" onclick="downloadCSV()" id="downBtn" disabled>ğŸ“¥ ä¸‹è¼‰æ•¸æ“šå ±è¡¨ (CSV)</button>
                </div>
                
                <div id="progressContainer" style="display:none;">
                    <div class="progress-box">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <div class="progress-text" id="progressText">0 / 0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel" style="border-top-color: #3498db; height: calc(100% - 70px);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">ğŸ“Š å³æ™‚æ•¸æ“šæµ (Live Stream)</h3>
                    <span id="statusBadge" class="tag status-wait">å¾…æ©Ÿä¸­</span>
                </div>
                
                <div class="table-wrapper">
                    <table id="resultTable">
                        <thead>
                            <tr>
                                <th width="8%">ID</th>
                                <th width="30%">é¡Œç›® (Input)</th>
                                <th width="45%">AI å›æ‡‰ (Output)</th>
                                <th width="17%">æ•ˆèƒ½æŒ‡æ¨™</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" style="text-align:center; padding:40px; color:#999;">
                                    è«‹åœ¨å·¦å´è²¼ä¸Šé¡Œç›®ä¸¦é»æ“Šã€Œé–‹å§‹è‡ªå‹•æ¸¬è©¦ã€...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let results = [];
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function startBatch() {
            // 1. é©—è­‰è¼¸å…¥
            const rawText = document.getElementById('questionList').value.trim();
            if (!rawText) { alert("è«‹å…ˆè¼¸å…¥é¡Œç›®ï¼"); return; }
            
            const questions = rawText.split('\n').filter(line => line.trim() !== '');
            const model = document.getElementById('modelSelect').value;
            const strategy = document.getElementById('strategySelect').value;
            
            // 2. åˆå§‹åŒ–
            isRunning = true;
            results = []; 
            document.querySelector('#resultTable tbody').innerHTML = ''; 
            toggleControls(true);
            document.getElementById('statusBadge').innerText = "æ¸¬è©¦é€²è¡Œä¸­...";
            document.getElementById('statusBadge').className = "tag status-ok";
            document.getElementById('progressContainer').style.display = 'block';

            // 3. åŸ·è¡Œæ¸¬è©¦è¿´åœˆ
            for (let i = 0; i < questions.length; i++) {
                if (!isRunning) break;

                const q = questions[i];
                updateProgress(i + 1, questions.length);

                // çµ„åˆ Prompt
                let finalPrompt = q;
                if (strategy === 'persona') {
                    finalPrompt = `ä½ æ˜¯ä¸€ä½ç†Ÿæ‚‰å°ç£æ–‡åŒ–çš„å°ˆæ¥­è¯èªæ•™å¸«ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼š\n${q}`;
                } else if (strategy === 'context') {
                    finalPrompt = `åƒè€ƒè³‡è¨Šï¼š(åœ¨æ­¤å¡«å…¥æ­£ç¢ºçŸ¥è­˜)... \nè«‹æ ¹æ“šè³‡è¨Šå›ç­”ï¼š\n${q}`;
                }

                // æ–°å¢ä¸€è¡Œåˆ°è¡¨æ ¼ (Loading ç‹€æ…‹)
                const tr = addTableRow(i + 1, q);
                scrollToBottom();

                // æº–å‚™æ•¸æ“š
                const rowData = {
                    id: i + 1,
                    question: q,
                    model: model,
                    strategy: strategy,
                    output: "",
                    latency: 0,
                    status: "Running"
                };

                try {
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt: finalPrompt, model: model })
                    });
                    const data = await res.json();

                    if (data.error) throw new Error(data.error);

                    rowData.output = data.output;
                    rowData.latency = data.latency;
                    rowData.status = "Success";
                    updateTableRow(tr, rowData);

                } catch (e) {
                    rowData.output = "Error: " + e.message;
                    rowData.status = "Failed";
                    updateTableRow(tr, rowData);
                }

                results.push(rowData);

                // âš ï¸ æ™ºæ…§ç·©è¡ï¼šé¿å…è¢« API é™é€Ÿ (Rate Limit)
                if (i < questions.length - 1) await sleep(2500); 
            }

            // çµæŸ
            isRunning = false;
            toggleControls(false);
            document.getElementById('statusBadge').innerText = "æ¸¬è©¦å®Œæˆ";
            document.getElementById('statusBadge').className = "tag status-wait";
            
            // è‡ªå‹•æç¤ºä¸‹è¼‰
            if(confirm("æ¸¬è©¦å®Œæˆï¼æ˜¯å¦ä¸‹è¼‰ CSV æª”æ¡ˆï¼Ÿ")) {
                downloadCSV();
            }
        }

        function stopBatch() {
            if(confirm("ç¢ºå®šè¦åœæ­¢å—ï¼Ÿ")) {
                isRunning = false;
                document.getElementById('statusBadge').innerText = "å·²åœæ­¢";
                document.getElementById('statusBadge').className = "tag status-err";
                toggleControls(false);
            }
        }

        function toggleControls(disable) {
            document.getElementById('startBtn').disabled = disable;
            document.getElementById('stopBtn').disabled = !disable;
            document.getElementById('downBtn').disabled = disable;
            document.getElementById('modelSelect').disabled = disable;
            document.getElementById('strategySelect').disabled = disable;
            document.getElementById('questionList').disabled = disable;
        }

        function updateProgress(current, total) {
            const pct = Math.round((current / total) * 100) + "%";
            document.getElementById('progressBar').style.width = pct;
            document.getElementById('progressText').innerText = `${current} / ${total} (${pct})`;
        }

        function addTableRow(id, question) {
            const tbody = document.querySelector('#resultTable tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${id}</strong></td>
                <td>${question}</td>
                <td style="color:#999;"><i>æ­£åœ¨æ€è€ƒä¸­...</i></td>
                <td><span class="tag status-wait">Pending</span></td>
            `;
            tbody.appendChild(tr);
            return tr;
        }

        function updateTableRow(tr, data) {
            const cleanOutput = data.output.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            const statusClass = data.status === 'Success' ? 'tag-time' : 'status-err';
            const latencyText = data.status === 'Success' ? `${data.latency} ms` : 'Error';
            
            tr.innerHTML = `
                <td><strong>${data.id}</strong></td>
                <td>${data.question}</td>
                <td><div style="max-height:100px; overflow-y:auto;">${cleanOutput}</div></td>
                <td>
                    <span class="tag ${statusClass}">${latencyText}</span><br>
                    <span style="font-size:10px; color:#999; margin-top:4px; display:block;">${data.model}</span>
                </td>
            `;
        }

        function scrollToBottom() {
            const container = document.querySelector('.table-wrapper');
            container.scrollTop = container.scrollHeight;
        }

        function downloadCSV() {
            if (results.length === 0) { alert("æ²’æœ‰æ•¸æ“šå¯ä¸‹è¼‰"); return; }
            
            let csv = "\uFEFFID,æ¨¡å‹,ç­–ç•¥,é¡Œç›®,AIå›æ‡‰,è€—æ™‚(ms),ç‹€æ…‹\n";
            results.forEach(row => {
                const q = `"${row.question.replace(/"/g, '""')}"`;
                const o = `"${row.output.replace(/"/g, '""')}"`;
                csv += `${row.id},${row.model},${row.strategy},${q},${o},${row.latency},${row.status}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `å¯¦é©—æ•¸æ“š_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
