<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª GPT-5 Hallucination Lab (V7.2 - Academic Edition)</title>
    <style>
        /* V7.2 æ¨£å¼ï¼šå„ªåŒ–æ¨™è¨˜å€ä½ˆå±€ */
        :root { --primary: #2563eb; --danger: #ef4444; --success: #10b981; --bg: #f8fafc; --card: #ffffff; --warn: #f59e0b; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); color: #1e293b; padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        header { text-align: center; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 2em; font-weight: 800; color: #0f172a; }
        .badge { background: #0f172a; color: #f472b6; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; font-family: monospace; display: inline-block; margin-top: 8px; }

        .container { display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        @media (max-width: 1100px) { .container { grid-template-columns: 1fr; } }

        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card h3 { margin-top: 0; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 12px; font-size: 1.1em; }

        label { display: block; font-weight: 600; margin-bottom: 6px; color: #475569; font-size: 0.9em; }
        select, textarea, input[type="range"] { width: 100%; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 13px; background: #fff; box-sizing: border-box; }
        textarea { height: 120px; resize: vertical; font-family: monospace; }
        
        .range-wrap { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .range-val { font-weight: bold; color: var(--primary); min-width: 30px; }

        optgroup { font-weight: bold; color: #0f172a; }

        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; font-size: 14px; }
        .btn-start { background: var(--primary); } .btn-start:hover { background: #1d4ed8; }
        .btn-stop { background: var(--danger); } .btn-stop:hover { background: #dc2626; }
        .btn-csv { background: var(--success); } .btn-csv:hover { background: #059669; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.7; }

        /* è¡¨æ ¼å„ªåŒ– */
        .table-container { height: 700px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed; }
        th { background: #f8fafc; padding: 10px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #e2e8f0; color: #475569; z-index: 10; white-space: nowrap; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; vertical-align: top; line-height: 1.4; word-wrap: break-word; }
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; }
        .tag-ok { background: #dcfce7; color: #166534; }
        .tag-wait { background: #f1f5f9; color: #64748b; }

        /* äººå·¥æ¨™è¨˜å€ä½ˆå±€ (Grid) */
        .eval-container { display: flex; flex-direction: column; gap: 8px; }
        
        /* ä¸Šå±¤ï¼šä¸‰å€‹ä¸‹æ‹‰é¸å–® */
        .eval-selects { display: flex; gap: 5px; }
        .eval-select { 
            padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 11px; background: #f8fafc; 
            flex: 1; cursor: pointer; color: #334155;
        }
        .eval-select:focus { border-color: var(--primary); outline: none; background: white; }

        /* ä¸‹å±¤ï¼šæŒ‰éˆ•ç¾¤ */
        .eval-btns { display: flex; gap: 4px; }
        .eval-btn { padding: 6px; font-size: 11px; border-radius: 4px; border: 1px solid #cbd5e1; background: white; color: #64748b; cursor: pointer; flex: 1; text-align: center; font-weight: 600; } 
        .eval-btn:hover { background: #f1f5f9; }
        .eval-btn.selected { color: white; border-color: transparent; }
        
        /* è©•åˆ†é¡è‰² */
        .eval-btn[data-type="OK"].selected { background: var(--success); }
        .eval-btn[data-type="A"].selected { background: var(--danger); }
        .eval-btn[data-type="B"].selected { background: var(--warn); }
        .eval-btn[data-type="D"].selected { background: #64748b; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ§ª 2026 GPT å¹»è¦ºé‡åŒ–è©•æ¸¬å¯¦é©—å®¤</h1>
    <div class="badge">SYSTEM V7.2 - ACADEMIC METRICS ADDED</div>
</header>

<div class="container">
    <div class="card">
        <h3>ğŸ›ï¸ è®Šå› æ§åˆ¶ (Variables)</h3>
        
        <label>1. æ¨¡å‹ (Model)</label>
        <select id="modelSelect">
            <optgroup label="RQ1: ä¸–ä»£æ¼”åŒ–">
                <option value="gpt-4o">GPT-4o (2024)</option>
                <option value="gpt-5.2">GPT-5.2 (2026)</option>
            </optgroup>
            <optgroup label="RQ2: åƒæ•¸è¦æ¨¡">
                <option value="gpt-4o-mini">GPT-4o Mini</option>
                <option value="gpt-5-nano">GPT-5 Nano</option>
            </optgroup>
            <optgroup label="RQ3: æ¨ç†æ€è€ƒ">
                <option value="o3">o3 (Reasoning)</option>
            </optgroup>
        </select>

        <label>2. æº«åº¦ (Temperature)</label>
        <div class="range-wrap">
            <input type="range" id="tempRange" min="0" max="1" step="0.1" value="0.7" oninput="document.getElementById('tempVal').innerText=this.value">
            <span class="range-val" id="tempVal">0.7</span>
        </div>

        <label>3. ç­–ç•¥ (Strategy)</label>
        <select id="strategySelect">
            <option value="baseline">åŸºæº–æ¨¡å¼ (Baseline)</option>
            <option value="persona">è§’è‰²æ‰®æ¼” (Persona)</option>
            <option value="cot">æ€ç¶­éˆ (CoT)</option>
        </select>

        <label>4. é¡Œåº« (Questions)</label>
        <textarea id="questionList" placeholder="è«‹è²¼ä¸Šé¡Œç›® (ä¸€è¡Œä¸€é¡Œ)..."></textarea>
        
        <div style="background:#e2e8f0; height:6px; border-radius:3px; margin:15px 0;">
            <div id="progressBar" style="height:100%; width:0%; background:#2563eb; transition:0.3s;"></div>
        </div>

        <div class="btn-group">
            <button class="btn-start" onclick="startExp()" id="btnStart">â–¶ åŸ·è¡Œå¯¦é©—</button>
            <button class="btn-stop" onclick="stopExp()" id="btnStop" disabled>â¹ å¼·åˆ¶åœæ­¢</button>
            <button class="btn-csv" onclick="downloadCSV()" id="btnCsv" disabled>ğŸ“¥ ä¸‹è¼‰å…¨æ•¸æ“š (CSV)</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š è©•æ¸¬çµæœ (Results)</h3>
        <div class="table-container">
            <table id="resTable">
                <thead>
                    <tr>
                        <th width="4%">#</th>
                        <th width="20%">é¡Œç›®</th>
                        <th width="30%">AI å›æ‡‰</th>
                        <th width="6%">å­—æ•¸</th>
                        <th width="8%">ç‹€æ…‹</th>
                        <th width="32%">äººå·¥æ¨™è¨˜ (Annotation)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" style="text-align:center; padding:40px; color:#94a3b8;">ç­‰å¾…å¯¦é©—å•Ÿå‹•...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let isRunning = false;
    let resultsLog = [];

    async function startExp() {
        const qRaw = document.getElementById('questionList').value.trim();
        if(!qRaw) { alert("è«‹è¼¸å…¥é¡Œç›®ï¼"); return; }
        
        const questions = qRaw.split('\n').filter(x => x.trim());
        const model = document.getElementById('modelSelect').value;
        const strategy = document.getElementById('strategySelect').value;
        const temp = document.getElementById('tempRange').value;
        
        isRunning = true;
        resultsLog = [];
        updateUI(true);
        document.querySelector('#resTable tbody').innerHTML = '';

        for(let i=0; i<questions.length; i++) {
            if(!isRunning) break;
            
            const q = questions[i];
            updateProgress(i+1, questions.length);

            // Prompt çµ„åˆ
            let finalPrompt = q;
            if(strategy === 'persona') finalPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šç¹é«”ä¸­æ–‡èˆ‡å°ç£æ–‡åŒ–çš„å­¸è¡“å°ˆå®¶ã€‚è«‹å›ç­”ï¼š${q}`;
            if(strategy === 'cot') finalPrompt = `å•é¡Œï¼š${q}\nè«‹é‹ç”¨é€æ­¥æ€è€ƒ (Chain of Thought) çš„æ–¹å¼åˆ†æä¸¦å›ç­”ï¼š`;

            // UI é å…ˆé¡¯ç¤º
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${i+1}</td>
                <td><div style="max-height:60px; overflow:hidden;">${q}</div></td>
                <td style="color:#aaa">Generating...</td>
                <td>-</td>
                <td><span class="tag tag-wait">...</span></td>
                <td>-</td>
            `;
            document.querySelector('#resTable tbody').appendChild(tr);
            scrollToBottom();

            const startT = Date.now();
            let rowData = { 
                id: i+1, model, strategy, temp, q, a: "", len: 0, latency: 0, 
                // æ–°å¢ä¸‰å€‹å­¸è¡“æŒ‡æ¨™
                diff: "", verify: "", conf: "", type: "Unlabeled" 
            };

            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt: finalPrompt, model: model }) 
                });
                const json = await res.json();
                
                rowData.a = json.output;
                rowData.len = json.length || json.output.length;
                rowData.latency = json.latency;

                // æ›´æ–° UIï¼šåŠ å…¥ã€Œé«˜ CP å€¼ä¸‰åƒæ•¸ã€é¸å–®
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td><div style="max-height:80px; overflow-y:auto;">${q}</div></td>
                    <td><div style="max-height:100px; overflow-y:auto; font-size:0.9em;">${json.output}</div></td>
                    <td>${rowData.len}</td>
                    <td><span class="tag tag-ok">${rowData.latency}ms</span></td>
                    <td>
                        <div class="eval-container">
                            <div class="eval-selects">
                                <select class="eval-select" onchange="updateMeta(${i}, 'diff', this.value)" title="é¡Œç›®é›£åº¦">
                                    <option value="" disabled selected>é›£åº¦...</option>
                                    <option value="Easy">Easy (å¸¸è­˜)</option>
                                    <option value="Medium">Medium (å°ˆæ¥­)</option>
                                    <option value="Hard">Hard (é•·å°¾)</option>
                                </select>
                                <select class="eval-select" onchange="updateMeta(${i}, 'verify', this.value)" title="å¯æŸ¥è­‰æ€§">
                                    <option value="" disabled selected>æŸ¥è­‰æ€§...</option>
                                    <option value="Verifiable">æ˜ç¢º (æœ‰æ¨™æº–ç­”æ¡ˆ)</option>
                                    <option value="Ambiguous">æ¨¡ç³Š (ç„¡æ¨™æº–ç­”æ¡ˆ)</option>
                                </select>
                                <select class="eval-select" onchange="updateMeta(${i}, 'conf', this.value)" title="å›ç­”èªæ°£">
                                    <option value="" disabled selected>èªæ°£...</option>
                                    <option value="Certain">è‚¯å®š (çµ•å°)</option>
                                    <option value="Cautious">ä¿å®ˆ (å¯èƒ½)</option>
                                    <option value="Unsure">ä¸ç¢ºå®š (æ¨æ¸¬)</option>
                                </select>
                            </div>
                            <div class="eval-btns" id="btns-${i}">
                                <button class="eval-btn" onclick="setLabel(${i}, 'OK', this)">âœ… æ­£ç¢º</button>
                                <button class="eval-btn" onclick="setLabel(${i}, 'A', this)">ğŸ¤¥ çæ°</button>
                                <button class="eval-btn" onclick="setLabel(${i}, 'B', this)">ğŸ”€ éŒ¯ç½®</button>
                                <button class="eval-btn" onclick="setLabel(${i}, 'D', this)">ğŸ¤ æ‹’ç­”</button>
                            </div>
                        </div>
                    </td>
                `;

            } catch(e) {
                rowData.a = "Error: " + e.message;
                tr.innerHTML = `<td>${i+1}</td><td colspan="4" style="color:red">${e.message}</td><td>Error</td>`;
            }
            
            resultsLog.push(rowData);
            if(i < questions.length-1) await new Promise(r => setTimeout(r, 1000));
        }
        
        isRunning = false;
        updateUI(false);
    }

    // æ›´æ–°æ–°æŒ‡æ¨™
    window.updateMeta = function(index, key, value) {
        if(resultsLog[index]) resultsLog[index][key] = value;
    };

    // æ›´æ–°å¹»è¦ºæ¨™è¨˜
    window.setLabel = function(index, type, btnElement) {
        if(!resultsLog[index]) return;
        resultsLog[index].type = type;
        
        const parent = document.getElementById(`btns-${index}`);
        const btns = parent.querySelectorAll('.eval-btn');
        btns.forEach(b => b.classList.remove('selected'));
        btnElement.classList.add('selected');
    };

    function stopExp() { isRunning = false; }

    function downloadCSV() {
        if(resultsLog.length === 0) return;
        // åŒ¯å‡ºåŒ…å«ã€Œé›£åº¦ã€æŸ¥è­‰æ€§ã€èªæ°£ã€çš„ CSV
        let csv = "\uFEFFID,Model,Strategy,Temp,Question,Answer,Length,Latency,Difficulty,Verifiability,Confidence,Hallucination_Type\n";
        resultsLog.forEach(r => {
            const safeQ = r.q.replace(/"/g, '""');
            const safeA = r.a.replace(/"/g, '""').replace(/\n/g, ' ');
            csv += `${r.id},${r.model},${r.strategy},${r.temp},"${safeQ}","${safeA}",${r.len},${r.latency},${r.diff},${r.verify},${r.conf},${r.type}\n`;
        });
        
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
        link.download = `Exp_V7.2_${ts}.csv`;
        link.click();
    }

    function updateUI(disable) {
        document.getElementById('btnStart').disabled = disable;
        document.getElementById('btnCsv').disabled = disable;
        document.getElementById('btnStop').disabled = !disable;
    }
    function updateProgress(c, t) { document.getElementById('progressBar').style.width = (c/t)*100 + "%"; }
    function scrollToBottom() { const d = document.querySelector('.table-container'); d.scrollTop = d.scrollHeight; }
</script>

</body>
</html>
