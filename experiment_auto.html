<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ï¸ 2026 AI å¯¦é©—å®¤ (Pro UI)</title>
    <style>
        /* === 2026 å°ˆæ¥­å„€éŒ¶æ¿é¢¨æ ¼ === */
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background: #f1f5f9; max-width: 1400px; margin: 0 auto; color: #334155; }
        
        /* æ¨™é¡Œå€ */
        header { text-align: center; margin-bottom: 30px; }
        h1 { color: #0f172a; margin: 0; font-weight: 800; letter-spacing: -1px; }
        .date-badge { background: #e2e8f0; color: #64748b; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-family: monospace; display: inline-block; margin-top: 10px; }

        /* å…©æ¬„ä½ˆå±€ Grid */
        .grid-container { display: grid; grid-template-columns: 400px 1fr; gap: 30px; align-items: start; }
        
        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e2e8f0; }
        .card h3 { margin-top: 0; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 20px; }

        /* å·¦å´æ§åˆ¶é … */
        label { font-weight: 700; display: block; margin-bottom: 8px; color: #475569; }
        select, textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; transition: all 0.2s; background: #f8fafc; color: #334155; box-sizing: border-box; }
        select:focus, textarea:focus { border-color: #3b82f6; outline: none; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        /* âœ¨ é‡é»ä¿®æ”¹ï¼šè¶…å¤§é¡Œåº«è¦–çª— */
        textarea { 
            height: 300px; /* é è¨­é«˜åº¦åŠ é«˜ */
            resize: vertical; /* å…è¨±ä½¿ç”¨è€…æ‰‹å‹•æ‹‰ä¼¸ */
            font-family: monospace; 
            line-height: 1.6;
        }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 15px; }
        button:active { transform: scale(0.98); }
        
        .btn-run { background: #22c55e; color: white; }
        .btn-run:hover { background: #16a34a; }
        
        /* âœ¨ é‡é»ä¿®æ”¹ï¼šå¼·åˆ¶çµ‚æ­¢æŒ‰éˆ•æ›´é¡¯çœ¼ */
        .btn-stop { background: #ef4444; color: white; }
        .btn-stop:hover { background: #dc2626; }
        
        .btn-down { background: #3b82f6; color: white; }
        .btn-down:hover { background: #2563eb; }
        
        button:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.7; }

        /* å³å´è¡¨æ ¼å€ */
        .table-container { height: 750px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 15px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-weight: 600; color: #475569; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        tr:hover { background: #f8fafc; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-yellow { background: #fef9c3; color: #854d0e; }
        .bg-gray { background: #f1f5f9; color: #64748b; }

        /* é€²åº¦æ¢ */
        .progress-wrap { margin-top: 20px; background: #e2e8f0; height: 10px; border-radius: 5px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: #3b82f6; width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; margin-top: 5px; font-size: 13px; color: #64748b; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <h1>âš¡ï¸ 2026 AI å¹»è¦ºè©•æ¸¬å¯¦é©—å®¤</h1>
        <div class="date-badge">System Date: <span id="sysDate">Loading...</span></div>
    </header>

    <div class="grid-container">
        <div class="card">
            <h3>ğŸ›ï¸ å¯¦é©—æ§åˆ¶å°</h3>
            
            <label>1. é¸æ“‡æ¨¡å‹ (Model)</label>
            <select id="modelSelect">
                <optgroup label="Google (æ¨è–¦)">
                    <option value="gemini-1.5-flash">Gemini 3 Flash (Fast & Stable)</option>
                    <option value="gemini-1.5-pro-latest">Gemini 3 Pro (Flagship)</option>
                    <option value="gemini-pro">Gemini 2 Pro (Legacy)</option>
                </optgroup>
                <optgroup label="OpenAI">
                    <option value="gpt-4o-mini">GPT-5.2 Instant</option>
                    <option value="gpt-4o">GPT-5.2 Thinking</option>
                </optgroup>
                <optgroup label="Groq">
                    <option value="llama-3.1-8b-instant">Grok 4.1 Flash</option>
                    <option value="llama-3.1-70b-versatile">Grok 4.1 Thinking</option>
                </optgroup>
            </select>

            <br><br>
            <label>2. å¯¦é©—ç­–ç•¥ (Strategy)</label>
            <select id="strategySelect">
                <option value="baseline">åŸºæº–æ¨¡å¼ (Baseline)</option>
                <option value="persona">è§’è‰²æ‰®æ¼” (Persona)</option>
                <option value="context">çŸ¥è­˜æ³¨å…¥ (Context)</option>
            </select>

            <br><br>
            <label>3. é¡Œç›®è¼¸å…¥ (å¯æ‹–æ›³æ”¾å¤§ â†˜)</label>
            <textarea id="questionList" placeholder="è«‹è²¼ä¸Šé¡Œç›®ï¼Œä¸€è¡Œä¸€é¡Œ..."></textarea>
            
            <div class="progress-wrap" id="progressWrap">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText"></div>

            <div class="btn-group">
                <button class="btn-run" onclick="startBatch()" id="startBtn">â–¶ å•Ÿå‹•</button>
                <button class="btn-stop" onclick="stopBatch()" id="stopBtn" disabled>â¹ å¼·åˆ¶åœæ­¢</button>
            </div>
            <div class="btn-group">
                <button class="btn-down" onclick="downloadCSV()" id="downBtn" disabled>ğŸ“¥ ä¸‹è¼‰ CSV</button>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; border:none;">ğŸ“Š å¯¦æ™‚æ•¸æ“šç›£æ§</h3>
                <span id="statusTag" class="badge bg-gray">Ready</span>
            </div>
            
            <div class="table-container">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th width="8%">#</th>
                            <th width="35%">é¡Œç›®</th>
                            <th width="40%">å›æ‡‰</th>
                            <th width="17%">ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="4" style="text-align:center; padding:50px; color:#94a3b8;">ç­‰å¾…å•Ÿå‹•...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // è‡ªå‹•é¡¯ç¤ºæ—¥æœŸ
        document.getElementById('sysDate').innerText = new Date().toISOString().slice(0,10);

        let isRunning = false;
        let results = [];
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function startBatch() {
            // é©—è­‰
            const raw = document.getElementById('questionList').value.trim();
            if(!raw) { alert("è«‹è¼¸å…¥é¡Œç›®ï¼"); return; }
            
            const questions = raw.split('\n').filter(x => x.trim());
            const model = document.getElementById('modelSelect').value;
            const modelName = document.getElementById('modelSelect').options[document.getElementById('modelSelect').selectedIndex].text;
            const strategy = document.getElementById('strategySelect').value;

            // åˆå§‹åŒ– UI
            isRunning = true;
            results = [];
            document.querySelector('#resultTable tbody').innerHTML = '';
            toggleControls(true);
            document.getElementById('statusTag').innerText = "Running...";
            document.getElementById('statusTag').className = "badge bg-green";
            document.getElementById('progressWrap').style.display = 'block';

            // åŸ·è¡Œè¿´åœˆ
            for (let i = 0; i < questions.length; i++) {
                // âœ¨ å¼·åˆ¶çµ‚æ­¢æª¢æŸ¥é» 1
                if (!isRunning) {
                    console.log("Stopped by user.");
                    break;
                }

                const q = questions[i];
                updateProgress(i + 1, questions.length);

                // Prompt çµ„åˆ
                let prompt = q;
                if(strategy === 'persona') prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­å°ç£è¯èªæ•™å¸«ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼š${q}`;
                if(strategy === 'context') prompt = `åƒè€ƒè³‡è¨Šï¼š(è«‹è‡ªè¡Œå¡«å…¥)...\nå›ç­”ï¼š${q}`;

                // æ–°å¢è¡¨æ ¼è¡Œ (Loading)
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td>${q}</td><td style="color:#94a3b8"><i>ç”Ÿæˆä¸­...</i></td><td><span class="badge bg-yellow">Pending</span></td>`;
                document.querySelector('#resultTable tbody').appendChild(tr);
                scrollToBottom();

                // æº–å‚™æ•¸æ“š
                let rowData = { id: i+1, q, output: "", latency: 0, status: "Pending", modelDisplay: modelName };

                try {
                    // API å‘¼å«
                    const startT = Date.now();
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt, model })
                    });
                    const data = await res.json();
                    
                    if (data.error) throw new Error(data.error);

                    rowData.output = data.output;
                    rowData.latency = Date.now() - startT;
                    rowData.status = "Success";
                    
                    // æ›´æ–° UI
                    const cleanOut = data.output.replace(/</g, "&lt;");
                    tr.innerHTML = `<td>${i+1}</td><td>${q}</td><td><div style="max-height:100px; overflow-y:auto;">${cleanOut}</div></td><td><span class="badge bg-green">${rowData.latency}ms</span></td>`;

                } catch (e) {
                    rowData.output = "Error: " + e.message;
                    rowData.status = "Failed";
                    tr.innerHTML = `<td>${i+1}</td><td>${q}</td><td style="color:red">${e.message}</td><td><span class="badge bg-red">Failed</span></td>`;
                }

                results.push(rowData);

                // âœ¨ å¼·åˆ¶çµ‚æ­¢æª¢æŸ¥é» 2 (åœ¨ä¼‘æ¯å‰æª¢æŸ¥ï¼Œé¿å…ä¸å¿…è¦çš„ç­‰å¾…)
                if (!isRunning) break;

                // ä¼‘æ¯
                if (i < questions.length - 1) await sleep(2000);
            }

            // çµæŸç‹€æ…‹
            isRunning = false;
            toggleControls(false);
            const finalMsg = results.length === questions.length ? "Completed" : "Stopped";
            document.getElementById('statusTag').innerText = finalMsg;
            document.getElementById('statusTag').className = finalMsg === "Completed" ? "badge bg-green" : "badge bg-red";
            
            if(finalMsg === "Completed" && confirm("æ¸¬è©¦å®Œæˆï¼Œä¸‹è¼‰ CSVï¼Ÿ")) downloadCSV();
        }

        function stopBatch() {
            if(confirm("ç¢ºå®šè¦å¼·åˆ¶åœæ­¢å—ï¼Ÿç›®å‰çš„é€²åº¦æœƒè¢«ä¿ç•™ã€‚")) {
                isRunning = false; // é€™æœƒè§¸ç™¼è¿´åœˆå…§çš„ break
                document.getElementById('statusTag').innerText = "Stopping...";
            }
        }

        function toggleControls(disable) {
            document.getElementById('startBtn').disabled = disable;
            document.getElementById('stopBtn').disabled = !disable;
            document.getElementById('downBtn').disabled = disable;
            document.getElementById('modelSelect').disabled = disable;
            document.getElementById('questionList').disabled = disable;
        }

        function updateProgress(cur, total) {
            const pct = Math.round((cur/total)*100) + "%";
            document.getElementById('progressBar').style.width = pct;
            document.getElementById('progressText').innerText = `${cur} / ${total}`;
        }

        function scrollToBottom() {
            const div = document.querySelector('.table-container');
            div.scrollTop = div.scrollHeight;
        }

        function downloadCSV() {
            if(!results.length) { alert("ç„¡æ•¸æ“š"); return; }
            let csv = "\uFEFFID,Model,Question,Output,Latency,Status\n";
            results.forEach(r => {
                csv += `${r.id},"${r.modelDisplay}","${r.q.replace(/"/g, '""')}","${r.output.replace(/"/g, '""')}",${r.latency},${r.status}\n`;
            });
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Results_${new Date().toISOString().slice(0,16).replace(/[:T]/g,'-')}.csv`;
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
