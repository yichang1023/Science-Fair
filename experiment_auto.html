<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>âš¡ï¸ ç§‘å±•è‡ªå‹•åŒ–æ¸¬è©¦æ©Ÿ (Batch Runner)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f0f2f5; max-width: 1000px; margin: 0 auto; }
        h1 { color: #2c3e50; text-align: center; }
        .panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 150px; font-family: monospace; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; flex: 1; font-weight: bold; color: white; }
        .btn-run { background: #27ae60; }
        .btn-run:disabled { background: #95a5a6; cursor: not-allowed; }
        .btn-stop { background: #c0392b; }
        .btn-down { background: #2980b9; }

        /* é€²åº¦æ¢ */
        .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; margin: 20px 0; display: none; }
        .progress-bar { width: 0%; height: 20px; background-color: #27ae60; border-radius: 10px; transition: width 0.3s; text-align: center; color: white; font-size: 12px; line-height: 20px; }

        /* çµæœè¡¨æ ¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        th { background-color: #f2f2f2; position: sticky; top: 0; }
        .status-ok { color: green; }
        .status-err { color: red; }
    </style>
</head>
<body>

    <h1>âš¡ï¸ ç§‘å±•è‡ªå‹•åŒ–æ‰¹æ¬¡æ¸¬è©¦æ©Ÿ</h1>
    <p style="text-align:center; color:#666;">è‡ªå‹•éšŠåˆ—åŸ·è¡Œç³»çµ± (Auto-Queue System)</p>

    <div class="panel">
        <h3>1. å¯¦é©—è¨­å®š</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label>é¸æ“‡æ¨¡å‹ (Model)</label>
                <select id="modelSelect">
                    <optgroup label="Google">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (å¿«é€Ÿ)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (ç²¾ç¢º)</option>
                    </optgroup>
                    <optgroup label="OpenAI">
                        <option value="gpt-4o-mini">GPT-4o Mini</option>
                        <option value="gpt-4o">GPT-4o</option>
                    </optgroup>
                    <optgroup label="Groq">
                        <option value="llama3-8b-8192">Llama 3 8B</option>
                        <option value="llama3-70b-8192">Llama 3 70B</option>
                    </optgroup>
                </select>
            </div>
            <div>
                <label>é¸æ“‡ç­–ç•¥ (Strategy)</label>
                <select id="strategySelect">
                    <option value="baseline">Baseline (ç›´æ¥å•)</option>
                    <option value="persona">Persona (è§’è‰²è¨­å®š)</option>
                    <option value="context">Context (çŸ¥è­˜æ³¨å…¥)</option>
                </select>
            </div>
        </div>
    </div>

    <div class="panel">
        <label>2. è²¼ä¸Šé¡Œç›®æ¸…å–® (ä¸€è¡Œä¸€é¡Œ)</label>
        <textarea id="questionList" placeholder="ä¾‹å¦‚ï¼š
å°ç£æœ€é«˜çš„å±±æ˜¯å“ªä¸€åº§ï¼Ÿ
å°åŒ—æ·é‹ä»€éº¼æ™‚å€™ä¸èƒ½åƒæ±è¥¿ï¼Ÿ
è«‹ä»‹ç´¹çç å¥¶èŒ¶çš„æ­·å²ã€‚"></textarea>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">âš ï¸ å»ºè­°æ¯æ¬¡æ¸¬è©¦ 20-50 é¡Œï¼Œé¿å…ç€è¦½å™¨å¡é “ã€‚</div>
    </div>

    <div class="panel">
        <h3>3. åŸ·è¡Œæ§åˆ¶</h3>
        <div class="progress-container" id="progressBox">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="btn-group">
            <button class="btn-run" onclick="startBatch()" id="startBtn">â–¶ é–‹å§‹è‡ªå‹•æ¸¬è©¦</button>
            <button class="btn-stop" onclick="stopBatch()" id="stopBtn" disabled>â¹ å¼·åˆ¶åœæ­¢</button>
            <button class="btn-down" onclick="downloadCSV()" id="downBtn" disabled>ğŸ“¥ ä¸‹è¼‰ CSV å ±è¡¨</button>
        </div>
    </div>

    <div class="panel">
        <h3>4. å³æ™‚æ•¸æ“šç›£æ§</h3>
        <div style="max-height: 400px; overflow-y: auto;">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="30%">é¡Œç›®</th>
                        <th width="40%">AI å›æ‡‰</th>
                        <th width="10%">è€—æ™‚</th>
                        <th width="15%">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        let isRunning = false;
        let results = []; // å„²å­˜æ‰€æœ‰æ•¸æ“š

        // å»¶é²å‡½å¼ (é¿å…æ‰“å¤ªå¿«è¢«é–)
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function startBatch() {
            // 1. æº–å‚™è³‡æ–™
            const rawText = document.getElementById('questionList').value.trim();
            if (!rawText) { alert("è«‹å…ˆè¼¸å…¥é¡Œç›®ï¼"); return; }
            
            const questions = rawText.split('\n').filter(line => line.trim() !== '');
            const model = document.getElementById('modelSelect').value;
            const strategy = document.getElementById('strategySelect').value;
            
            // 2. åˆå§‹åŒ– UI
            isRunning = true;
            results = []; // æ¸…ç©ºèˆŠè³‡æ–™
            document.querySelector('#resultTable tbody').innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼
            updateUIState(true);
            
            const total = questions.length;
            const progressBar = document.getElementById('progressBar');
            document.getElementById('progressBox').style.display = 'block';

            // 3. é–‹å§‹è¿´åœˆ (Loop)
            for (let i = 0; i < total; i++) {
                if (!isRunning) break; // å…è¨±ä¸­é€”åœæ­¢

                const q = questions[i];
                updateProgress(i + 1, total);

                // çµ„åˆ Prompt
                let finalPrompt = q;
                if (strategy === 'persona') {
                    finalPrompt = `ä½ æ˜¯ä¸€ä½å°ç£è¯èªæ•™å¸«ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼š\n${q}`;
                } else if (strategy === 'context') {
                    finalPrompt = `åƒè€ƒè³‡è¨Šï¼š(è«‹åœ¨æ­¤å¡«å…¥å›ºå®šçŸ¥è­˜)... \nå›ç­”ï¼š\n${q}`;
                }

                // --- å‘¼å« API ---
                const rowData = {
                    id: i + 1,
                    question: q,
                    model: model,
                    strategy: strategy,
                    output: "",
                    latency: 0,
                    status: "Pending"
                };

                try {
                    const res = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prompt: finalPrompt, model: model })
                    });
                    const data = await res.json();

                    if (data.error) throw new Error(data.error);

                    rowData.output = data.output;
                    rowData.latency = data.latency;
                    rowData.status = "Success";

                } catch (e) {
                    rowData.output = "Error: " + e.message;
                    rowData.status = "Failed";
                }

                // å„²å­˜ä¸¦é¡¯ç¤º
                results.push(rowData);
                addTableRow(rowData);

                // --- é—œéµï¼šä¼‘æ¯ 2 ç§’ ---
                // å…è²»ç‰ˆ API é€šå¸¸é™åˆ¶ä¸€åˆ†é˜ 15-60 æ¬¡ï¼Œä¼‘æ¯ 2000ms æ¯”è¼ƒå®‰å…¨
                await sleep(2000); 
            }

            isRunning = false;
            updateUIState(false);
            alert("æ¸¬è©¦å®Œæˆï¼è«‹é»æ“Šä¸‹è¼‰ CSVã€‚");
        }

        function stopBatch() {
            isRunning = false;
            alert("å·²åœæ­¢ï¼Œç›®å‰çš„æ•¸æ“šä»å¯ä¸‹è¼‰ã€‚");
            updateUIState(false);
        }

        function updateProgress(current, total) {
            const pct = Math.round((current / total) * 100) + "%";
            const bar = document.getElementById('progressBar');
            bar.style.width = pct;
            bar.innerText = `${current} / ${total} (${pct})`;
        }

        function addTableRow(data) {
            const tbody = document.querySelector('#resultTable tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${data.id}</td>
                <td>${data.question}</td>
                <td><div style="max-height:100px; overflow-y:auto;">${data.output}</div></td>
                <td>${data.latency} ms</td>
                <td class="${data.status === 'Success' ? 'status-ok' : 'status-err'}">${data.status}</td>
            `;
            tbody.appendChild(tr);
        }

        function updateUIState(running) {
            document.getElementById('startBtn').disabled = running;
            document.getElementById('stopBtn').disabled = !running;
            document.getElementById('downBtn').disabled = running;
        }

        // ä¸‹è¼‰ CSV (Excel å¯è®€æ ¼å¼)
        function downloadCSV() {
            if (results.length === 0) { alert("æ²’æœ‰æ•¸æ“šå¯ä¸‹è¼‰"); return; }

            // åŠ å…¥ BOM è®“ Excel æ­£ç¢ºè­˜åˆ¥ UTF-8 ä¸­æ–‡
            let csvContent = "\uFEFF"; 
            
            // è¡¨é ­
            csvContent += "ID,æ¨¡å‹,ç­–ç•¥,é¡Œç›®,AIå›æ‡‰,è€—æ™‚(ms),ç‹€æ…‹\n";

            // å…§å®¹
            results.forEach(row => {
                // è™•ç† CSV ç‰¹æ®Šå­—å…ƒ (æ›è¡Œã€é€—è™Ÿéƒ½è¦ç”¨å¼•è™ŸåŒ…èµ·ä¾†)
                const cleanOutput = `"${row.output.replace(/"/g, '""')}"`;
                const cleanQ = `"${row.question.replace(/"/g, '""')}"`;
                
                csvContent += `${row.id},${row.model},${row.strategy},${cleanQ},${cleanOutput},${row.latency},${row.status}\n`;
            });

            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `å¯¦é©—æ•¸æ“š_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
