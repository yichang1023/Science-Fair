<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ§ª GPT-5 Hallucination Research Lab (V6.0)</title>
    <style>
        /* åŸºç¤è¨­å®š */
        :root { --primary: #2563eb; --danger: #ef4444; --success: #10b981; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); color: #1e293b; padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        /* æ¨™é¡Œå€ */
        header { text-align: center; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0; margin-bottom: 30px; }
        h1 { margin: 0; font-size: 2em; font-weight: 800; color: #0f172a; }
        .badge { background: #0f172a; color: #facc15; padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; font-family: monospace; display: inline-block; margin-top: 8px; }

        /* ä½ˆå±€ Grid */
        .container { display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
        @media (max-width: 800px) { .container { grid-template-columns: 1fr; } }

        /* å¡ç‰‡æ¨£å¼ */
        .card { background: var(--card); padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card h3 { margin-top: 0; color: #334155; border-bottom: 2px solid #f1f5f9; padding-bottom: 12px; font-size: 1.1em; }

        /* è¡¨å–®å…ƒä»¶ */
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #475569; font-size: 0.9em; }
        select, textarea { width: 100%; padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #fff; transition: 0.2s; box-sizing: border-box; }
        select:focus, textarea:focus { border-color: var(--primary); outline: none; }
        textarea { height: 200px; resize: vertical; font-family: monospace; }
        
        /* é¸å–®ç¾¤çµ„æ¨£å¼ */
        optgroup { font-weight: bold; font-style: normal; color: #0f172a; }

        /* æŒ‰éˆ•ç¾¤ */
        .btn-group { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
        button { padding: 14px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; color: white; transition: 0.2s; font-size: 14px; }
        .btn-start { background: var(--primary); } .btn-start:hover { background: #1d4ed8; }
        .btn-stop { background: var(--danger); } .btn-stop:hover { background: #dc2626; }
        .btn-csv { background: var(--success); } .btn-csv:hover { background: #059669; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.7; }

        /* é€²åº¦æ¢ */
        .progress-box { margin: 15px 0; }
        .progress-bg { background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        .progress-text { text-align: right; font-size: 12px; color: #64748b; margin-top: 4px; }

        /* çµæœè¡¨æ ¼ */
        .table-container { height: 600px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #e2e8f0; color: #475569; z-index: 10; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: top; line-height: 1.5; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .tag { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .tag-ok { background: #dcfce7; color: #166534; }
        .tag-err { background: #fee2e2; color: #991b1b; }
        .tag-wait { background: #f1f5f9; color: #64748b; }

    </style>
</head>
<body>

<header>
    <h1>ğŸ§ª 2026 GPT å¹»è¦ºé‡åŒ–è©•æ¸¬å¯¦é©—å®¤</h1>
    <div class="badge">SYSTEM V6.0 - OPENAI RESEARCH EDITION</div>
</header>

<div class="container">
    <div class="card">
        <h3>ğŸ›ï¸ å¯¦é©—è®Šå› è¨­å®š (Variables)</h3>
        
        <label>1. æ¨¡å‹è®Šå›  (Independent Variable: Model)</label>
        <select id="modelSelect">
            <optgroup label="RQ1: ä¸–ä»£æ¼”åŒ– (Gen Gap)">
                <option value="gpt-4o">GPT-4o (2024 Baseline)</option>
                <option value="gpt-5.2">GPT-5.2 (2026 Flagship)</option>
            </optgroup>
            
            <optgroup label="RQ2: åƒæ•¸é‡ç´š (Parameter Scale)">
                <option value="gpt-4o-mini">GPT-4o Mini (Small)</option>
                <option value="gpt-5-nano">GPT-5 Nano (Tiny/Edge)</option>
            </optgroup>

            <optgroup label="RQ3: æ¨ç†æ€è€ƒ (Reasoning)">
                <option value="o1">o1 (Deep Research)</option>
                <option value="o3">o3 (Advanced Reasoning)</option>
            </optgroup>
        </select>

        <label>2. æç¤ºç­–ç•¥ (Prompt Strategy)</label>
        <select id="strategySelect">
            <option value="baseline">åŸºæº–æ¨¡å¼ (Zero-shot Baseline)</option>
            <option value="persona">è§’è‰²æ‰®æ¼” (Persona: å°ç£å°ˆå®¶)</option>
            <option value="cot">æ€ç¶­éˆ (Chain of Thought)</option>
        </select>

        <label>3. æ¸¬è©¦é¡Œåº« (Questions)</label>
        <textarea id="questionList" placeholder="åœ¨æ­¤è²¼ä¸Šé¡Œç›® (ä¸€è¡Œä¸€é¡Œ)..."></textarea>
        
        <div class="progress-box">
            <div class="progress-bg"><div class="progress-bar" id="progressBar"></div></div>
            <div class="progress-text" id="progressText">Ready (0/0)</div>
        </div>

        <div class="btn-group">
            <button class="btn-start" onclick="startExp()" id="btnStart">â–¶ åŸ·è¡Œå¯¦é©— (Start)</button>
            <button class="btn-stop" onclick="stopExp()" id="btnStop" disabled>â¹ å¼·åˆ¶åœæ­¢ (Stop)</button>
            <button class="btn-csv" onclick="downloadCSV()" id="btnCsv" disabled>ğŸ“¥ ä¸‹è¼‰æ•¸æ“š (Export CSV)</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“Š å¯¦æ™‚æ•¸æ“šç›£æ§ (Real-time Data)</h3>
        <div class="table-container">
            <table id="resTable">
                <thead>
                    <tr>
                        <th width="5%">#</th>
                        <th width="25%">é¡Œç›® (Prompt)</th>
                        <th width="45%">AI å›æ‡‰ (Output)</th>
                        <th width="10%">å­—æ•¸</th>
                        <th width="15%">ç‹€æ…‹</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="5" style="text-align:center; padding:40px; color:#94a3b8;">è«‹è¼¸å…¥é¡Œç›®ä¸¦é–‹å§‹å¯¦é©—...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let isRunning = false;
    let resultsLog = [];

    async function startExp() {
        const qInput = document.getElementById('questionList').value.trim();
        if(!qInput) { alert("è«‹å…ˆè¼¸å…¥æ¸¬è©¦é¡Œç›®ï¼"); return; }
        
        const questions = qInput.split('\n').filter(line => line.trim() !== '');
        const model = document.getElementById('modelSelect').value;
        const strategy = document.getElementById('strategySelect').value;
        
        // åˆå§‹åŒ–ç‹€æ…‹
        isRunning = true;
        resultsLog = [];
        updateUI(true);
        document.querySelector('#resTable tbody').innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼

        for(let i=0; i < questions.length; i++) {
            if(!isRunning) break;

            const q = questions[i];
            updateProgress(i+1, questions.length);

            // 1. æ ¹æ“šç­–ç•¥çµ„è£ Prompt
            let finalPrompt = q;
            if(strategy === 'persona') finalPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šç¹é«”ä¸­æ–‡èˆ‡å°ç£æ–‡åŒ–çš„å­¸è¡“å°ˆå®¶ã€‚è«‹å›ç­”ä»¥ä¸‹å•é¡Œï¼š${q}`;
            if(strategy === 'cot') finalPrompt = `å•é¡Œï¼š${q}\nè«‹é‹ç”¨é€æ­¥æ€è€ƒ (Chain of Thought) çš„æ–¹å¼åˆ†æä¸¦å›ç­”ï¼š`;

            // 2. UI é¡¯ç¤ºã€Œè™•ç†ä¸­ã€
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i+1}</td><td>${q}</td><td style="color:#64748b">è™•ç†ä¸­ (Generating)...</td><td>-</td><td><span class="tag tag-wait">...</span></td>`;
            document.querySelector('#resTable tbody').appendChild(tr);
            scrollToBottom();

            // 3. å‘¼å«å¾Œç«¯ API
            const startTime = Date.now();
            let record = { id: i+1, model, strategy, question: q, answer: "", length: 0, latency: 0, status: "Fail" };

            try {
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: finalPrompt, model: model })
                });

                const data = await response.json();

                if(data.error) throw new Error(data.error);

                // æˆåŠŸå–å¾—æ•¸æ“š
                record.answer = data.output;
                record.length = data.length;
                record.latency = data.latency;
                record.status = "Success";

                // æ›´æ–° UI
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td>${q}</td>
                    <td><div style="max-height:100px; overflow-y:auto; font-size:0.9em;">${data.output}</div></td>
                    <td>${data.length}</td>
                    <td><span class="tag tag-ok">${data.latency}ms</span></td>
                `;

            } catch (err) {
                console.error(err);
                record.answer = `[Error] ${err.message}`;
                tr.innerHTML = `
                    <td>${i+1}</td>
                    <td>${q}</td>
                    <td style="color:var(--danger)">${err.message}</td>
                    <td>0</td>
                    <td><span class="tag tag-err">ERR</span></td>
                `;
            }

            resultsLog.push(record);
            
            // 4. é€Ÿç‡é™åˆ¶ä¿è­· (Rate Limit Protection)
            // é¿å… API å‘¼å«å¤ªå¿«è¢«å°é–ï¼Œæ¯é¡Œä¸­é–“ä¼‘æ¯ 1.5 ç§’
            if(i < questions.length - 1) await new Promise(r => setTimeout(r, 1500));
        }

        isRunning = false;
        updateUI(false);
        if(confirm(`å¯¦é©—çµæŸï¼å…±å®Œæˆ ${resultsLog.length} ç­†æ•¸æ“šã€‚\næ˜¯å¦ç«‹å³ä¸‹è¼‰ CSV æª”æ¡ˆï¼Ÿ`)) {
            downloadCSV();
        }
    }

    function stopExp() { isRunning = false; }

    function downloadCSV() {
        if(resultsLog.length === 0) return;

        // å»ºç«‹ç¬¦åˆæœŸåˆŠåˆ†æéœ€æ±‚çš„ CSV è¡¨é ­
        // ç‰¹åˆ¥é ç•™ "Hallucination_Type" æ¬„ä½ä¾›äººå·¥æ¨™è¨˜
        let csvContent = "\uFEFFID,Model,Strategy,Question,Answer,Length_Chars,Latency_ms,Hallucination_Type(A/B/D)\n";

        resultsLog.forEach(row => {
            // è™•ç† CSV æ ¼å¼ (æ›è¡Œç¬¦è™Ÿèˆ‡å¼•è™Ÿè½‰ç¾©)
            const safeQ = row.question.replace(/"/g, '""');
            const safeA = row.answer.replace(/"/g, '""').replace(/\n/g, ' '); // å°‡æ›è¡Œè½‰ç‚ºç©ºç™½ï¼Œä¿æŒè¡¨æ ¼æ•´é½Š
            
            csvContent += `${row.id},${row.model},${row.strategy},"${safeQ}","${safeA}",${row.length},${row.latency},\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
        link.download = `Exp_${document.getElementById('modelSelect').value}_${timestamp}.csv`;
        link.click();
    }

    function updateUI(isBusy) {
        document.getElementById('btnStart').disabled = isBusy;
        document.getElementById('btnCsv').disabled = isBusy;
        document.getElementById('btnStop').disabled = !isBusy;
    }

    function updateProgress(current, total) {
        const percent = (current / total) * 100;
        document.getElementById('progressBar').style.width = percent + "%";
        document.getElementById('progressText').innerText = `Progress: ${current} / ${total}`;
    }

    function scrollToBottom() {
        const container = document.querySelector('.table-container');
        container.scrollTop = container.scrollHeight;
    }
</script>

</body>
</html>
