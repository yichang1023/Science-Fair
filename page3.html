<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯èª AI ç™¾å¯¶ç®± (Gemini Hybrid Ultimate)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #F8FAFC; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        /* Ken Burns Effect for Dynamic Visuals */
        @keyframes ken-burns {
            0% { transform: scale(1.0); }
            100% { transform: scale(1.1); }
        }
        .animate-ken-burns { animation: ken-burns 20s ease-out infinite alternate; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        import { 
            Menu, BookOpen, PenTool, MessageCircle, Bot, Headphones, 
            Settings, LogIn, Globe, ChevronRight, Home, Zap, 
            RefreshCw, FileText, Download, X, User, GraduationCap,
            Code, Sparkles, Copy, Layers, PlayCircle, Star, Share2,
            ArrowRight, Mic, Volume2, Image as ImageIcon, Send, Sliders,
            CheckCircle2, AlertCircle, Lightbulb, Search, Loader2, Key, Rocket, Gem,
            PauseCircle, Book, Eye, Camera
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- 1. Constants & Data ---
        const THEMES = [
            { id: 1, name: 'æ—¥å¸¸ç”Ÿæ´»', icon: 'â˜€ï¸', scenarios: ['æ‰“æ‹›å‘¼', 'æ™‚é–“', 'å¤©æ°£', 'è²·æ±è¥¿', 'çœ‹é†«ç”Ÿ', 'ç†é«®', 'æ‰¾æœ‹å‹'] },
            { id: 2, name: 'é£²é£Ÿæ–‡åŒ–', icon: 'ğŸœ', scenarios: ['é»é¤', 'æ¨è–¦ç¾é£Ÿ', 'åƒç«é‹', 'åŒ…é¤ƒå­', 'é£Ÿæä»‹ç´¹', 'èœå–®è©¢å•', 'ç”¨é¤ç¦®å„€'] },
            { id: 3, name: 'äº¤é€šå‡ºè¡Œ', icon: 'ğŸšŒ', scenarios: ['å•è·¯', 'æ­å…¬è»Š', 'è²·ç¥¨', 'è¨‚æˆ¿', 'éæµ·é—œ', 'ç§Ÿè»Š', 'é²åˆ°é“æ­‰'] },
            { id: 4, name: 'è³¼ç‰©æ¶ˆè²»', icon: 'ğŸ›ï¸', scenarios: ['è©¢åƒ¹', 'æŠ˜æ‰£', 'é€€è²¨', 'ç·šä¸Šè³¼ç‰©', 'é›»å­æ”¯ä»˜', 'è©¦ç©¿è¡£æœ', 'è´ˆç¦®'] },
            { id: 5, name: 'å·¥ä½œè·å ´', icon: 'ğŸ’¼', scenarios: ['é¢è©¦', 'è‡ªæˆ‘ä»‹ç´¹', 'é–‹æœƒ', 'ææ¡ˆ', 'é›»è©±', 'å ±å‘Š', 'è«‹å‡'] },
            { id: 6, name: 'é†«ç™‚ä¿å¥', icon: 'ğŸ¥', scenarios: ['æ›è™Ÿ', 'å•è¨º', 'æ‹¿è—¥', 'èº«é«”ç‹€æ³', 'é‹å‹•å»ºè­°', 'é é˜²ä¿å¥', 'å¿ƒç†è«®è©¢'] },
            { id: 7, name: 'ä¼‘é–’å¨›æ¨‚', icon: 'ğŸ‰', scenarios: ['çœ‹é›»å½±', 'å”±æ­Œ', 'æ—…éŠ', 'æ‰“çƒ', 'ç©éŠæˆ²', 'èˆˆè¶£ä»‹ç´¹', 'é€±æœ«è¨ˆç•«'] },
            { id: 8, name: 'ç¯€æ…¶æ´»å‹•', icon: 'ğŸ®', scenarios: ['æ˜¥ç¯€', 'ä¸­ç§‹', 'ç«¯åˆ', 'è–èª•', 'ç”Ÿæ—¥', 'å©šç¦®', 'è·¨å¹´'] },
            { id: 9, name: 'ç¤¾äº¤äº’å‹•', icon: 'ğŸ’¬', scenarios: ['èŠå¤©', 'é‚€ç´„', 'é€ç¦®', 'è®šç¾', 'æ‹’çµ•', 'é“æ­‰', 'æ„Ÿè¬'] },
            { id: 10, name: 'å…¶ä»–è‡ªè¨‚', icon: 'â•', scenarios: ['è‡ªè¨‚æƒ…å¢ƒ A', 'è‡ªè¨‚æƒ…å¢ƒ B'] },
        ];

        const MM_SCENARIOS = [
            { id: 'night_market', icon: 'ğŸœ', title: 'å¤œå¸‚æ®ºåƒ¹', keyword: 'night market food stall taiwan', prompt: 'åœ¨å°ç£å¤œå¸‚è·Ÿè€é—†æ®ºåƒ¹', desc: 'å­¸ç¿’å¦‚ä½•åœ¨ç†±é¬§çš„å¤œå¸‚ä¸­è©¢åƒ¹èˆ‡è­°åƒ¹' },
            { id: 'mrt', icon: 'ğŸš‡', title: 'æ·é‹å•è·¯', keyword: 'taipei mrt station', prompt: 'åœ¨æ·é‹ç«™è©¢å•å¦‚ä½•è½‰ä¹˜', desc: 'æŒæ¡æ·é‹ç«™å…§çš„è©¢å•èˆ‡æ–¹å‘æŒ‡å¼•' },
            { id: 'hospital', icon: 'ğŸ¥', title: 'é†«é™¢æ›è™Ÿ', keyword: 'hospital reception counter', prompt: 'åœ¨é†«é™¢æ«ƒæª¯æ›è™Ÿçœ‹è¨º', desc: 'æ›è™Ÿæµç¨‹èˆ‡ç—‡ç‹€æè¿°çš„åŸºç¤å°è©±' },
            { id: 'office', icon: 'ğŸ’¼', title: 'æœƒè­°ææ¡ˆ', keyword: 'business meeting presentation', prompt: 'åœ¨è¾¦å…¬å®¤æœƒè­°ä¸­é€²è¡Œææ¡ˆ', desc: 'æ­£å¼å•†å‹™å ´åˆçš„ææ¡ˆæŠ€å·§èˆ‡ç”¨èª' },
            { id: 'immigration', icon: 'ğŸ›‚', title: 'è¾¦å±…ç•™è­‰', keyword: 'immigration office counter', prompt: 'åœ¨ç§»æ°‘ç½²è¾¦ç†å±…ç•™è­‰', desc: 'è¡Œæ”¿æ©Ÿé—œè¾¦ç†è­‰ä»¶çš„å¸¸ç”¨è©å½™' },
            { id: 'bank', icon: 'ğŸ¦', title: 'éŠ€è¡Œé–‹æˆ¶', keyword: 'bank teller counter', prompt: 'åœ¨éŠ€è¡Œæ«ƒæª¯è¾¦ç†é–‹æˆ¶', desc: 'é‡‘èæœå‹™ç›¸é—œçš„ç²¾ç¢ºç”¨èª' },
            { id: 'convenience', icon: 'ğŸ“¦', title: 'è¶…å•†åŒ…è£¹', keyword: 'convenience store taiwan', prompt: 'åœ¨ä¾¿åˆ©å•†åº—è©¢å•åŒ…è£¹', desc: 'è™•ç†åŒ…è£¹å–ä»¶èˆ‡å¯„ä»¶çš„æ—¥å¸¸å°è©±' },
            { id: 'school', icon: 'ğŸ«', title: 'æ ¡åœ’è¡Œæ”¿', keyword: 'university administration office', prompt: 'åœ¨æ ¡åœ’è¡Œæ”¿è™•è©¢å•å­¸è²»ç¹³äº¤', desc: 'æ ¡åœ’ç”Ÿæ´»è¡Œæ”¿äº‹å‹™çš„æºé€š' },
        ];

        const LEVELS = ['A1', 'A2', 'B1', 'B2', 'C1', 'C6'];

        const PATTERNS = [
            { id: 'narrative', name: 'æƒ…å¢ƒæ•˜è¿°', desc: 'å®¢è§€æè¿°äººäº‹ç‰©', prompt_rule: 'å®¢è§€æè¿°ç’°å¢ƒã€å‹•ä½œæˆ–äº‹ä»¶æµç¨‹ã€‚ä½¿ç”¨ç¬¬ä¸‰äººç¨±æˆ–ä¸­æ€§è¦–è§’ã€‚' },
            { id: 'experience', name: 'ç¶“é©—åˆ†äº«', desc: 'ä¸»è§€æ„Ÿå—èˆ‡å›æ†¶', prompt_rule: 'ä¸»è§€æè¿°å€‹äººç¶“æ­·èˆ‡æ„Ÿå—ã€‚ä½¿ç”¨ç¬¬ä¸€äººç¨±ã€Œæˆ‘...ã€ï¼ŒåŒ…å«æƒ…ç·’èˆ‡å¿ƒç†æ´»å‹•ã€‚' },
            { id: 'advice', name: 'å¯¦ç”¨å»ºè­°', desc: 'æŒ‡å¼•èˆ‡è§£æ±ºæ–¹æ¡ˆ', prompt_rule: 'æä¾›æŒ‡å¼•ã€æ­¥é©Ÿæˆ–å»ºè­°ã€‚å¤šç”¨ç¥ˆä½¿å¥æˆ–å»ºè­°èªæ°£ã€‚' },
            { id: 'analysis', name: 'æ·±åº¦åˆ†æ', desc: 'é‚è¼¯æ¨æ¼”èˆ‡æ¢è¨', prompt_rule: 'æ¢è¨åŸå› ã€å½±éŸ¿ã€åˆ©å¼Šæ¯”è¼ƒã€‚é‚è¼¯æ€§å¼·ï¼Œå¤šç”¨é€£æ¥è©ã€‚' },
        ];

        const ASSISTANTS = [
            { 
                id: 'wang', name: 'ç‹è€å¸«', style: 'åš´æ ¼ç³¾éŒ¯ã€é‡è¦–èªæ³•', avatar: 'ğŸ‘¨â€ğŸ«', color: 'bg-blue-100 text-blue-700',
                greeting: 'åŒå­¸å¥½ã€‚æˆ‘æ˜¯ç‹è€å¸«ï¼Œæˆ‘æœƒåš´æ ¼æª¢æŸ¥ä½ çš„èªæ³•çµæ§‹èˆ‡ç”¨è©ç²¾ç¢ºåº¦ã€‚è«‹é–‹å§‹ç·´ç¿’ã€‚', 
                prompt_persona: 'ä½ æ˜¯ä¸€ä½åš´æ ¼çš„è³‡æ·±è¯èªæ•™å¸«ã€Œç‹è€å¸«ã€ã€‚ä½ çš„æ•™å­¸é¢¨æ ¼åš´è‚…ã€ç›´æ¥ï¼Œéå¸¸é‡è¦–èªæ³•æ­£ç¢ºæ€§èˆ‡è©å½™ç²¾æº–åº¦ã€‚ç•¶å­¸ç”Ÿèªªè©±æ™‚ï¼Œä½ æœƒå„ªå…ˆæŒ‡å‡ºéŒ¯èª¤ä¸¦æä¾›ä¿®æ­£ç‰ˆæœ¬ï¼Œè¼ƒå°‘é–’èŠã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ã€‚' 
            },
            { 
                id: 'lin', name: 'æ—è€å¸«', style: 'è¦ªåˆ‡é¼“å‹µã€é‡è¦–æºé€š', avatar: 'ğŸ‘©â€ğŸ«', color: 'bg-orange-100 text-orange-700',
                greeting: 'å—¨ï¼æˆ‘æ˜¯æ—è€å¸« ğŸ‘‹ åˆ¥æ€•èªªéŒ¯ï¼Œèªè¨€å°±æ˜¯ç”¨ä¾†æºé€šçš„ï¼æˆ‘å€‘è¼•é¬†èŠèŠå¤©å§ï¼Ÿ', 
                prompt_persona: 'ä½ æ˜¯ä¸€ä½è¦ªåˆ‡ç†±æƒ…çš„è¯èªæ•™å¸«ã€Œæ—è€å¸«ã€ã€‚ä½ çš„æ•™å­¸é¢¨æ ¼æº«æŸ”ã€å……æ»¿é¼“å‹µï¼Œé‡è¦–æºé€šçš„æµæš¢åº¦èˆ‡è‡ªä¿¡ã€‚å³ä½¿å­¸ç”Ÿæœ‰å°éŒ¯èª¤ï¼Œåªè¦ä¸å½±éŸ¿ç†è§£ï¼Œä½ æœƒå…ˆç¨±è®šå†å§”å©‰å»ºè­°ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œå¤šç”¨è¡¨æƒ…ç¬¦è™Ÿã€‚' 
            },
        ];

        // --- 2. Mock Engines (Trial Mode - Restored & Enhanced) ---
        const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
        
        // 2.0 Mock Database (Restored for Text Generation)
        const MOCK_DB = {
            'common': {
                connectors: ['ä¸åƒ…...è€Œä¸”...', 'é›–ç„¶...ä½†æ˜¯...', 'é™¤é...å¦å‰‡...', 'ä¸€æ–¹é¢...å¦ä¸€æ–¹é¢...', 'ä¹‹æ‰€ä»¥...æ˜¯å› ç‚º...']
            },
            'æ—¥å¸¸ç”Ÿæ´»': {
                verbs: { easy: ['è²·', 'å»', 'çœ‹', 'åš'], hard: ['è™•ç†', 'ç¶“ç‡Ÿ', 'ç¶­ç¹«', 'æ¢è¨'] },
                nouns: { easy: ['æ±è¥¿', 'æœ‹å‹', 'æ™‚é–“', 'è¡£æœ'], hard: ['äººéš›é—œä¿‚', 'ç”Ÿæ´»å“è³ª', 'æ°›åœ', 'åƒ¹å€¼è§€'] },
                adjs: { easy: ['å¥½', 'è²´', 'å¿™', 'é–‹å¿ƒ'], hard: ['å……å¯¦', 'ç¹ç‘£', 'çè²´', 'å’Œè«§'] },
                idioms: ['æŸ´ç±³æ²¹é¹½', 'ç¿’ä»¥ç‚ºå¸¸', 'æ—¥ç†è¬æ©Ÿ', 'äº•äº•æœ‰æ¢']
            },
            'é£²é£Ÿæ–‡åŒ–': {
                verbs: { easy: ['åƒ', 'å–', 'ç…®', 'é»'], hard: ['å“åš', 'çƒ¹é£ª', 'è¬›ç©¶', 'å‚³æ‰¿'] },
                nouns: { easy: ['èœ', 'æ°´', 'é£¯', 'å‘³é“'], hard: ['é¢¨å‘³', 'é£²é£Ÿç¿’æ…£', 'é¥—å®´', 'é£Ÿæ'] },
                adjs: { easy: ['å¥½åƒ', 'è¾£', 'ç”œ', 'é¦™'], hard: ['é®®ç¾', 'é“åœ°', 'ç²¾ç·»', 'å‚æ¶ä¸‰å°º'] },
                idioms: ['å¤§å¿«æœµé ¤', 'è‰²é¦™å‘³ä¿±å…¨', 'é£ŸæŒ‡å¤§å‹•', 'ç´°åš¼æ…¢åš¥']
            },
            'äº¤é€šå‡ºè¡Œ': {
                verbs: { easy: ['å', 'é–‹', 'èµ°', 'ç­‰'], hard: ['æ­ä¹˜', 'è¦åŠƒ', 'ç©¿æ¢­', 'æŠµé”'] },
                nouns: { easy: ['è»Š', 'è·¯', 'ç¥¨', 'æ·é‹'], hard: ['äº¤é€šæ¨ç´', 'è·¯æ³', 'æ—…ç¨‹', 'é‹è¼¸'] },
                adjs: { easy: ['å¿«', 'æ…¢', 'é ', 'æ–¹ä¾¿'], hard: ['æ“æ“ ', 'ä¾¿æ·', 'é †æš¢', 'é¡›ç°¸'] },
                idioms: ['è»Šæ°´é¦¬é¾', 'å››é€šå…«é”', 'å¡è»Šä¹‹è‹¦', 'é¢¨å¡µåƒ•åƒ•']
            },
            'è³¼ç‰©æ¶ˆè²»': {
                verbs: { easy: ['è²·', 'è³£', 'ä»˜', 'æ›'], hard: ['æ¡è³¼', 'æ¯”åƒ¹', 'é€€æ›', 'æ¶ˆè²»'] },
                nouns: { easy: ['éŒ¢', 'å¡', 'åº—', 'è¢‹å­'], hard: ['é ç®—', 'å„ªæƒ ', 'å“è³ª', 'å”®å¾Œæœå‹™'] },
                adjs: { easy: ['ä¾¿å®œ', 'è²´', 'æ–°', 'èˆŠ'], hard: ['å¯¦æƒ ', 'æ˜‚è²´', 'æ–°ç©', 'é™³èˆŠ'] },
                idioms: ['è²¨æ¯”ä¸‰å®¶', 'ç‰©ç¾åƒ¹å»‰', 'æ–¤æ–¤è¨ˆè¼ƒ', 'ç³ç‘¯æ»¿ç›®']
            },
            'default': {
                verbs: { easy: ['ç”¨', 'æ‰¾', 'è½', 'èªª'], hard: ['ä½¿ç”¨', 'å°‹æ±‚', 'è†è½', 'è¡¨é”'] },
                nouns: { easy: ['äº‹', 'äºº', 'éŒ¢', 'åœ°æ–¹'], hard: ['æƒ…æ³', 'å°è±¡', 'æˆæœ¬', 'ç’°å¢ƒ'] },
                adjs: { easy: ['å¤š', 'å°‘', 'å¤§', 'å°'], hard: ['è¤‡é›œ', 'ç¨€ç¼º', 'å»£æ³›', 'å¾®å°'] },
                idioms: ['ä¸å¯æˆ–ç¼º', 'è¼•è€Œæ˜“èˆ‰', 'èˆ‰è¶³è¼•é‡', 'æ¯æ¯ç›¸é—œ']
            }
        };

        // 2.1 Text Generation Logic (Restored)
        const generateMockContent = (themeName, scenario, level, pattern) => {
            const db = MOCK_DB[themeName] || MOCK_DB['default'];
            const common = MOCK_DB['common'];
            
            const isEasy = ['A1', 'A2'].includes(level);
            const isHard = ['C1', 'C6'].includes(level);

            const v = isEasy ? getRandom(db.verbs.easy) : getRandom(db.verbs.hard);
            const n = isEasy ? getRandom(db.nouns.easy) : getRandom(db.nouns.hard);
            const adj = isEasy ? getRandom(db.adjs.easy) : getRandom(db.adjs.hard);
            const idiom = getRandom(db.idioms);
            const conn = getRandom(common.connectors);

            let content = [];
            let keyVocab = [];

            if (pattern === 'narrative') {
                if (isEasy) {
                    content = [
                        { type: "æ¨™æº–ç¯„ä¾‹", text: `é€™è£¡æœ‰${n}ï¼Œæˆ‘è¦ºå¾—å¾ˆ${adj}ã€‚`, pinyin: `ZhÃ¨lÇ yÇ’u ${n}...`, grammar_point: "å­˜åœ¨å¥ (æœ‰...)" },
                        { type: "å£èªè®ŠåŒ–", text: `ä½ çœ‹ï¼é€™è£¡çš„${n}å¥½${adj}å–”ï¼`, pinyin: "NÇ kÃ n...", grammar_point: "èªæ°£è© (å–”)" },
                        { type: "æ“´å……æ‡‰ç”¨", text: `å› ç‚º${adj}ï¼Œæ‰€ä»¥å¾ˆå¤šäººä¾†${v}ã€‚`, pinyin: "YÄ«nwÃ¨i...", grammar_point: "å› ç‚º...æ‰€ä»¥..." }
                    ];
                    keyVocab = [n, adj, "è¦ºå¾—"];
                } else {
                    content = [
                        { type: "æ¨™æº–ç¯„ä¾‹", text: `ç’°é¡§å››å‘¨ï¼Œé€™è£¡çš„${n}å‘ˆç¾å‡ºä¸€ç¨®${adj}çš„æ°›åœï¼Œä»¤äºº${idiom}ã€‚`, pinyin: "HuÃ¡ngÃ¹ sÃ¬zhÅu...", grammar_point: "æå¯«è£œèª / æˆèª" },
                        { type: "å£èªè®ŠåŒ–", text: `èªªçœŸçš„ï¼Œé€™å ´æ™¯ç°¡ç›´å°±æ˜¯${idiom}ï¼Œé‚£ç¨®${adj}çš„æ„Ÿè¦ºå¤ªå¼·çƒˆäº†ã€‚`, pinyin: "ShuÅ zhÄ“n de...", grammar_point: "å¼·èª¿èªæ°£" },
                        { type: "æ“´å……æ‡‰ç”¨", text: `éš¨è‘—æ™‚é–“æ¨ç§»ï¼Œ${scenario}å·²ä¸åƒ…æ˜¯${v}ï¼Œæ›´æ˜¯ä¸€ç¨®æ–‡åŒ–çš„è±¡å¾µã€‚`, pinyin: "SuÃ­zhe...", grammar_point: "éš¨è‘—... (With...)" }
                    ];
                    keyVocab = [idiom, "æ°›åœ", "è±¡å¾µ"];
                }
            } else if (pattern === 'experience') {
                if (isEasy) {
                    content = [
                        { type: "æ¨™æº–ç¯„ä¾‹", text: `æˆ‘æ˜¨å¤©å»${v}${n}ï¼Œæˆ‘å¾ˆé–‹å¿ƒã€‚`, pinyin: "WÇ’ zuÃ³tiÄn...", grammar_point: "éå»å¼ (Time)" },
                        { type: "å£èªè®ŠåŒ–", text: `æˆ‘è·Ÿä½ èªªï¼Œ${scenario}çœŸçš„è¶…${adj}çš„å•¦ï¼`, pinyin: "WÇ’ gÄ“n nÇ shuÅ...", grammar_point: "å£èªé–‹é ­ (æˆ‘è·Ÿä½ èªª)" },
                        { type: "æ“´å……æ‡‰ç”¨", text: `æˆ‘æƒ³è¦å†${v}ä¸€æ¬¡ï¼Œå› ç‚ºå¾ˆ${adj}ã€‚`, pinyin: "WÇ’ xiÇng yÃ o...", grammar_point: "æƒ³è¦ (Want)" }
                    ];
                    keyVocab = ["æ˜¨å¤©", "é–‹å¿ƒ", "æƒ³è¦"];
                } else {
                    content = [
                        { type: "æ¨™æº–ç¯„ä¾‹", text: `å›æƒ³èµ·é‚£æ¬¡${scenario}çš„ç¶“æ­·ï¼Œ${n}çš„${adj}è‡³ä»Šä»è®“æˆ‘é›£ä»¥å¿˜æ‡·ã€‚`, pinyin: "HuÃ­xiÇng...", grammar_point: "å›æƒ³... (Recall)" },
                        { type: "å£èªè®ŠåŒ–", text: `å¦ç™½èªªï¼Œå¦‚æœä¸æ›¾è¦ªè‡ª${v}ï¼ŒçœŸçš„å¾ˆé›£é«”æœƒé‚£ç¨®${idiom}çš„æ„Ÿè¦ºã€‚`, pinyin: "TÇnbÃ¡i shuÅ...", grammar_point: "å‡è¨­èªæ°£" },
                        { type: "æ“´å……æ‡‰ç”¨", text: `${conn.split('...')[0]}æ˜¯ç‚ºäº†${n}ï¼Œ${conn.split('...')[1]}æ˜¯ç‚ºäº†å°‹æ‰¾è‡ªæˆ‘ã€‚`, pinyin: "BÃ¹jÇn...", grammar_point: "ä¸¦åˆ—è¤‡å¥" }
                    ];
                    keyVocab = ["ç¶“æ­·", "é«”æœƒ", idiom];
                }
            } else if (pattern === 'advice') {
                if (isEasy) {
                    content = [
                        { type: "æ¨™æº–ç¯„ä¾‹", text: `è«‹ä½ å¤š${v}ï¼Œé€™å°${n}å¾ˆå¥½ã€‚`, pinyin: "QÇng nÇ...", grammar_point: "å°...å¾ˆå¥½ (Good for)" },
                        { type: "å£èªè®ŠåŒ–", text: `ä½ è¦è¨˜å¾—${v}å–”ï¼Œä¸ç„¶æœƒä¸${adj}ã€‚`, pinyin: "NÇ yÃ o jÃ¬dÃ©...", grammar_point: "ä¸ç„¶ (Otherwise)" },
                        { type: "æ“´å……æ‡‰ç”¨", text: `ä½ å¯ä»¥å…ˆ${v}ï¼Œå†å»çœ‹${n}ã€‚`, pinyin: "NÇ kÄ›yÇ...", grammar_point: "å…ˆ...å†... (First... then)" }
                    ];
                    keyVocab = ["è¨˜å¾—", "ä¸ç„¶", "å…ˆ...å†"];
                } else {
                    content = [
                        { type: "æ¨™æº–ç¯„ä¾‹", text: `å»ºè­°æ‚¨åœ¨${scenario}æ™‚ï¼Œå‹™å¿…è€ƒé‡${n}çš„${adj}æ€§ï¼Œä»¥å…${idiom}ã€‚`, pinyin: "JiÃ nyÃ¬ nÃ­n...", grammar_point: "ä»¥å… (Lest)" },
                        { type: "å£èªè®ŠåŒ–", text: `è½æˆ‘ä¸€å¥å‹¸ï¼Œ${scenario}çš„é—œéµåœ¨æ–¼${v}ï¼Œåƒè¬åˆ¥å¿½ç•¥ç´°ç¯€ã€‚`, pinyin: "TÄ«ng wÇ’...", grammar_point: "é—œéµåœ¨æ–¼" },
                        { type: "æ“´å……æ‡‰ç”¨", text: `å”¯æœ‰é€éæŒçºŒçš„${v}ï¼Œæˆ‘å€‘æ‰èƒ½åœ¨${scenario}ä¸­ç²å¾—çœŸæ­£çš„${adj}ã€‚`, pinyin: "WÃ©iyÇ’u...", grammar_point: "å”¯æœ‰...æ‰..." }
                    ];
                    keyVocab = ["å‹™å¿…", "ä»¥å…", "é—œéµ"];
                }
            } else { // Analysis
                content = [
                    { type: "æ¨™æº–ç¯„ä¾‹", text: `é—œæ–¼${scenario}ï¼Œä¸»è¦çš„å•é¡Œåœ¨æ–¼${n}å¤ª${adj}ã€‚`, pinyin: "GuÄnyÃº...", grammar_point: "åœ¨æ–¼ (Lies in)" },
                    { type: "å£èªè®ŠåŒ–", text: `å…¶å¯¦${scenario}ä¹Ÿæ²’é‚£éº¼è¤‡é›œï¼Œå°±æ˜¯${n}çš„å•é¡Œè€Œå·²å˜›ã€‚`, pinyin: "QÃ­shÃ­...", grammar_point: "è€Œå·² (Just/Only)" },
                    { type: "æ“´å……æ‡‰ç”¨", text: `${conn.split('...')[0]}æˆ‘å€‘è¦${v}ï¼Œ${conn.split('...')[1]}ä¹Ÿè¦é¡§åŠ${n}ã€‚`, pinyin: "...", grammar_point: "é€£æ¥è©é‹ç”¨" }
                ];
                keyVocab = ["å•é¡Œ", "è¤‡é›œ", "é¡§åŠ"];
            }

            return { content, stats: { estimated_level: level, key_vocabulary: keyVocab } };
        };
        
        // 2.2 QA Mock DB
        const MOCK_QA_DB = {
            default: {
                answer: "é€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„å•é¡Œã€‚åœ¨è¯èªæ–‡åŒ–ä¸­ï¼Œæˆ‘å€‘é€šå¸¸æœƒæ ¹æ“šå°è±¡çš„é•·å¹¼å°Šå‘ä¾†æ±ºå®šæªè¾­ã€‚",
                culture: "è¯äººç¤¾æœƒéå¸¸é‡è¦–ã€Œç¦®è²Œã€èˆ‡ã€Œé¢å­ã€ï¼Œåœ¨ä¸ç¢ºå®šçš„æƒ…æ³ä¸‹ï¼Œå¤šç”¨ã€Œè«‹å•ã€ã€ã€Œä¸å¥½æ„æ€ã€æº–æ²’éŒ¯ã€‚",
                vocab: [{word: "ç¦®è²Œ", pinyin: "lÇ mÃ o"}, {word: "å°Šé‡", pinyin: "zÅ«n zhÃ²ng"}]
            },
            'é£²é£Ÿ': {
                answer: "åœ¨ç”¨é¤æƒ…å¢ƒä¸­ï¼Œå¦‚æœæ˜¯é•·è¼©è«‹å®¢ï¼Œé€šå¸¸æœƒç”±é•·è¼©å…ˆå‹•ç­·å­ã€‚",
                culture: "åœ“æ¡Œåƒé£¯æ™‚ï¼Œè½‰ç›¤æ‡‰é †æ™‚é‡è½‰å‹•ã€‚å¤¾èœæ™‚ä¸è¦åœ¨ç›¤å­è£¡ç¿»æŒ‘ï¼Œé€™è¢«è¦–ç‚ºä¸ç¦®è²Œçš„è¡Œç‚ºã€‚",
                vocab: [{word: "åœ“æ¡Œ", pinyin: "yuÃ¡n zhuÅ"}, {word: "å…¬ç­·æ¯åŒ™", pinyin: "gÅng kuÃ i mÇ” chÃ­"}]
            }
        };

        // 2.3 Assistant Mock Responses
        const MOCK_CHAT_DB = {
            'wang': [
                "é€™ä½åŒå­¸ï¼Œä½ çš„å¥å­çµæ§‹æœ‰é»é¬†æ•£ã€‚å»ºè­°åŠ ä¸Šä¸»è©æœƒæ›´å®Œæ•´ã€‚",
                "æ³¨æ„ï¼Œã€Œå°±ã€å’Œã€Œæ‰ã€çš„ç”¨æ³•ä¸åŒï¼Œé€™è£¡æ‡‰è©²ç”¨ã€Œæ‰ã€ã€‚",
                "ä½ çš„è©å½™é‡é‚„å¯ä»¥ï¼Œä½†æ˜¯èªæ³•æº–ç¢ºåº¦éœ€è¦åŠ å¼·ã€‚è«‹é‡è©¦ä¸€æ¬¡ã€‚"
            ],
            'lin': [
                "å“‡ï¼ä½ èªªå¾—å¾ˆæ£’è€¶ï¼ğŸ‘ æ„æ€éå¸¸æ¸…æ¥šï¼",
                "æ²’éŒ¯æ²’éŒ¯ï¼Œå°±æ˜¯é€™æ¨£ç”¨ï¼ä½ çš„é€²æ­¥å¾ˆå¿«å–”ï¼âœ¨",
                "åˆ¥æ“”å¿ƒèªæ³•ï¼Œæˆ‘è½å¾—æ‡‚ä½ çš„æ„æ€ï¼å¦‚æœæƒ³æ›´é“åœ°ä¸€é»ï¼Œå¯ä»¥è©¦è©¦çœ‹é€™æ¨£èªª..."
            ]
        };

        // 2.4 Multimodal Mock Script
        const generateMockMMScript = (scenarioTitle, level) => {
            const isEasy = ['A1', 'A2'].includes(level);
            
            // Mock content tailored to the new scenarios
            const scriptData = {
                'å¤œå¸‚æ®ºåƒ¹': {
                    easy: [
                        { speaker: "æˆ‘", text: "è€é—†ï¼Œé€™å€‹å¤šå°‘éŒ¢ï¼Ÿ" },
                        { speaker: "è€é—†", text: "ä¸‰ç™¾å¡Šã€‚" },
                        { speaker: "æˆ‘", text: "å¤ªè²´äº†ï¼Œå…©ç™¾äº”å¯ä»¥å—ï¼Ÿ" },
                        { speaker: "è€é—†", text: "å¥½å•¦ï¼Œç®—ä½ ä¾¿å®œä¸€é»ã€‚" }
                    ],
                    hard: [
                        { speaker: "é¡§å®¢", text: "è€é—†ï¼Œé€™ä»¶å•†å“çš„å®šåƒ¹ä¼¼ä¹ç•¥é«˜æ–¼å¸‚å ´è¡Œæƒ…ã€‚" },
                        { speaker: "åº—å®¶", text: "é€™å¯æ˜¯æ‰‹å·¥è£½ä½œçš„ï¼Œå“è³ªçµ•å°æœ‰ä¿è­‰ï¼Œä¸€åˆ†éŒ¢ä¸€åˆ†è²¨å•Šã€‚" },
                        { speaker: "é¡§å®¢", text: "æˆ‘ç†è§£æ‚¨çš„æˆæœ¬è€ƒé‡ï¼Œä½†è‹¥èƒ½çµ¦å€‹æŠ˜æ‰£ï¼Œæˆ‘æœƒè€ƒæ…®å¤šå¸¶å¹¾ä»¶ã€‚" },
                        { speaker: "åº—å®¶", text: "çœ‹æ‚¨é€™éº¼æœ‰èª æ„ï¼Œé‚£å°±çµ¦æ‚¨å€‹å‹æƒ…åƒ¹å§ã€‚" }
                    ],
                    visual_tags: ["æ‹›ç‰Œ (Signboard)", "äººæ½® (Crowd)", "ç¾é‡‘ (Cash)"],
                    culture_note: "åœ¨å°ç£å¤œå¸‚æ®ºåƒ¹æ˜¯ä¸€ç¨®æ¨‚è¶£ï¼Œä½†è¦æ³¨æ„ç¦®è²Œï¼Œä¸è¦ç åƒ¹å¤ªéé›¢è­œã€‚"
                },
                'é†«é™¢æ›è™Ÿ': {
                    easy: [
                        { speaker: "æˆ‘", text: "ä½ å¥½ï¼Œæˆ‘è¦æ›è™Ÿã€‚" },
                        { speaker: "è­·ç†å¸«", text: "è«‹å•å“ªè£¡ä¸èˆ’æœï¼Ÿ" },
                        { speaker: "æˆ‘", text: "æˆ‘é ­ç—›ï¼Œé‚„æœ‰ç™¼ç‡’ã€‚" },
                        { speaker: "è­·ç†å¸«", text: "å¥½çš„ï¼Œè«‹å¡«å¯«é€™å¼µè¡¨ã€‚" }
                    ],
                    hard: [
                        { speaker: "ç—…æ‚£", text: "æ‚¨å¥½ï¼Œæˆ‘éœ€è¦æ›å…§ç§‘é–€è¨ºï¼Œé€™å¹¾å¤©æŒçºŒå‡ºç¾åé ­ç—›çš„ç—‡ç‹€ã€‚" },
                        { speaker: "æ«ƒæª¯", text: "è«‹å•æ‚¨æ˜¯å¦æœ‰æŒ‡å®šé†«å¸«ï¼Ÿæˆ–æ˜¯ç”±æˆ‘å€‘ç‚ºæ‚¨å®‰æ’å€¼ç­é†«å¸«ï¼Ÿ" },
                        { speaker: "ç—…æ‚£", text: "è«‹å¹«æˆ‘å®‰æ’æœ€å¿«èƒ½çœ‹è¨ºçš„é†«å¸«å³å¯ï¼Œå¦å¤–æˆ‘æœ‰è—¥ç‰©éæ•å²ã€‚" },
                        { speaker: "æ«ƒæª¯", text: "äº†è§£ï¼Œè«‹å‡ºç¤ºå¥ä¿å¡ï¼Œä¸¦ç¨å€™ç‚ºæ‚¨æ¸¬é‡é«”æº«èˆ‡è¡€å£“ã€‚" }
                    ],
                    visual_tags: ["å¥ä¿å¡ (Health Card)", "å£ç½© (Mask)", "æ›è™Ÿå–® (Form)"],
                    culture_note: "å°ç£çš„å¥ä¿åˆ¶åº¦éå¸¸æ–¹ä¾¿ï¼Œå°±é†«æ™‚å‹™å¿…æ”œå¸¶å¥ä¿å¡ (NHI Card)ã€‚"
                },
                'default': {
                    easy: [
                        { speaker: "A", text: `è«‹å•${scenarioTitle}æ€éº¼åšï¼Ÿ` },
                        { speaker: "B", text: `ä½ å¯ä»¥å…ˆå»æ«ƒæª¯å•å•çœ‹ã€‚` },
                        { speaker: "A", text: `å¥½çš„ï¼Œè¬è¬ä½ çš„å¹«å¿™ã€‚` },
                        { speaker: "B", text: `ä¸å®¢æ°£ï¼Œç¥ä½ é †åˆ©ã€‚` }
                    ],
                    hard: [
                        { speaker: "A", text: `é—œæ–¼${scenarioTitle}çš„æµç¨‹ï¼Œä¼¼ä¹æ¯”æƒ³åƒä¸­ç¹ç‘£ã€‚` },
                        { speaker: "B", text: `ç¢ºå¯¦ï¼Œå»ºè­°æ‚¨å…ˆå‚™å¦¥ç›¸é—œæ–‡ä»¶ï¼Œä»¥æå‡è¾¦ç†æ•ˆç‡ã€‚` },
                        { speaker: "A", text: `é€™å»ºè­°éå¸¸ä¸­è‚¯ï¼Œæˆ‘æœƒç‰¹åˆ¥ç•™æ„çš„ã€‚` },
                        { speaker: "B", text: `è‹¥æœ‰ä»»ä½•ç–‘æ…®ï¼Œéš¨æ™‚å¯ä»¥å‘ç›¸é—œäººå“¡è«®è©¢ã€‚` }
                    ],
                    visual_tags: ["æ«ƒæª¯ (Counter)", "æ–‡ä»¶ (Document)", "æœå‹™äººå“¡ (Staff)"],
                    culture_note: `åœ¨${scenarioTitle}æ™‚ï¼Œä¿æŒè€å¿ƒèˆ‡ç¦®è²Œæ˜¯æºé€šé †æš¢çš„é—œéµã€‚`
                }
            };

            const data = scriptData[scenarioTitle] || scriptData['default'];
            return {
                script: isEasy ? data.easy : data.hard,
                visual_tags: data.visual_tags,
                culture_note: data.culture_note
            };
        };

        // --- 3. API & Logic Helpers ---

        const getLevelDesc = (level) => {
            const map = {
                'A1': 'å¥é•·ï¼šçŸ­å¥ (5-10å­—) | è©å½™ï¼šè¶…é«˜é »è© | èªæ³•ï¼šSVO', 'A2': 'å¥é•·ï¼šç”Ÿæ´»å¸¸ç”¨å¥ | è©å½™ï¼šå…·é«”åè©',
                'B1': 'å¥é•·ï¼šä¸­é•·å¥ | è©å½™ï¼šæŠ½è±¡åè©', 'B2': 'å¥é•·ï¼šæ®µè½çµæ§‹ | èªæ³•ï¼šè¤‡å¥',
                'C1': 'å¥é•·ï¼šçµæ§‹è¤‡é›œ | èªæ³•ï¼šå€’è£/ä¿®è¾­', 'C6': 'å¥é•·ï¼šæ¯èªæ°´æº– | èªæ³•ï¼šæ–‡åŒ–éš±å–»'
            };
            return map[level] || map['B1'];
        };

        const callGeminiAPI = async (apiKey, prompt, systemInstruction = "", jsonMode = false) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { temperature: 0.7, maxOutputTokens: 2000, ...(jsonMode && { responseMimeType: "application/json" }) }
            };
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("No content generated");
            return jsonMode ? JSON.parse(text) : text;
        };

        // --- 4. Components ---

        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, size = 'md' }) => {
            const base = "font-medium transition-all duration-200 flex items-center justify-center gap-2 shadow-sm active:scale-95 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100";
            const sizes = { sm: "px-3 py-1.5 text-sm", md: "px-4 py-2", lg: "px-6 py-3 text-lg" };
            const variants = {
                primary: "bg-[#006699] text-white hover:bg-[#005580]",
                secondary: "bg-[#FFB347] text-gray-900 hover:bg-[#ffa524]",
                outline: "border border-[#006699] text-[#006699] hover:bg-blue-50",
                ghost: "text-gray-600 hover:bg-gray-100",
                dark: "bg-gray-800 text-gray-200 hover:bg-gray-900",
                trial: "bg-emerald-600 text-white hover:bg-emerald-700"
            };
            return <button onClick={onClick} disabled={disabled} className={`${base} ${sizes[size]} ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Card = ({ children, title, icon: Icon, className = '', headerAction, noPadding = false }) => (
            
            <div className={`bg-white rounded-xl shadow-md border border-gray-100 flex flex-col ${className}`}>
                {(title || Icon) && (
                    <div className="bg-gray-50 px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            {Icon && <span className="text-[#FFB347]"><Icon size={20}/></span>}
                            <h3 className="font-bold text-gray-800">{title}</h3>
                        </div>
                        {headerAction}
                    </div>
                )}
                <div className={`${noPadding ? '' : 'p-4'} flex-1 overflow-auto`}>{children}</div>
            </div>
        );

        // --- 5. Mode Selection Modal ---
        const ModeSelectionModal = ({ isOpen, onClose, onSelectMode, currentKey }) => {
            const [step, setStep] = useState(currentKey ? 'api' : 'select');
            const [inputKey, setInputKey] = useState(currentKey || '');
            const [showPassword, setShowPassword] = useState(false);

            useEffect(() => { 
                if (isOpen && currentKey) setStep('api'); 
                else if (isOpen) setStep('select');
                setInputKey(currentKey || '');
            }, [isOpen, currentKey]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
                        <div className="bg-[#006699] px-6 py-4 flex justify-between items-center text-white">
                            <h3 className="text-xl font-bold flex items-center gap-2"><Settings size={20}/> å¹³å°è¨­å®š</h3>
                            <button onClick={onClose} className="hover:bg-white/20 p-1 rounded-full"><X size={20}/></button>
                        </div>
                        <div className="p-6">
                            {step === 'select' ? (
                                <div className="space-y-4">
                                    <p className="text-gray-600 text-center mb-6">è«‹é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„æ¨¡å¼ï¼š</p>
                                    <button onClick={() => onSelectMode('trial', '')} className="w-full p-4 rounded-xl border-2 border-emerald-100 hover:border-emerald-500 bg-emerald-50/50 hover:bg-emerald-50 transition-all group flex items-center gap-4 text-left">
                                        <div className="w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform"><Rocket size={24}/></div>
                                        <div><div className="font-bold text-gray-800 text-lg">é«”é©—ç‰ˆ (Trial)</div><div className="text-xs text-gray-500">å… Key â€¢ é«˜æ“¬çœŸæ¨¡æ“¬å¼•æ“ â€¢ å¿«é€Ÿé«”é©—</div></div>
                                    </button>
                                    <button onClick={() => setStep('api')} className="w-full p-4 rounded-xl border-2 border-blue-100 hover:border-[#006699] bg-blue-50/50 hover:bg-blue-50 transition-all group flex items-center gap-4 text-left">
                                        <div className="w-12 h-12 rounded-full bg-blue-100 text-[#006699] flex items-center justify-center group-hover:scale-110 transition-transform"><Gem size={24}/></div>
                                        <div><div className="font-bold text-gray-800 text-lg">æ­£å¼ç‰ˆ (Full)</div><div className="text-xs text-gray-500">éœ€ Key â€¢ Gemini 2.5 Flash çœŸå¯¦ AI</div></div>
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="flex items-center gap-2 text-[#006699] mb-2 cursor-pointer hover:underline" onClick={() => setStep('select')}><ArrowRight size={14} className="rotate-180"/> è¿”å›é¸æ“‡</div>
                                    <p className="text-sm text-gray-500">è«‹è¼¸å…¥ Google Gemini API Keyã€‚Key åƒ…å„²å­˜æ–¼æœ¬åœ°ç€è¦½å™¨ã€‚</p>
                                    <div className="relative">
                                        <input type={showPassword ? "text" : "password"} value={inputKey} onChange={(e) => setInputKey(e.target.value)} placeholder="AIzaSy..." className="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#006699] font-mono text-sm"/>
                                        <button onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-400 hover:text-gray-600">{showPassword ? <ArrowRight size={16} className="rotate-180"/> : <ArrowRight size={16}/>}</button>
                                    </div>
                                    <div className="mt-2 text-xs text-gray-400 flex justify-between"><a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline hover:text-[#006699]">å–å¾— API Key</a></div>
                                    <Button onClick={() => onSelectMode('full', inputKey)} className="w-full mt-4">ç¢ºèªä¸¦å•Ÿç”¨ AI</Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 6. Main App Component ---
        function HuaYuAIApp() {
            // App State
            const [appMode, setAppMode] = useState('trial'); 
            const [apiKey, setApiKey] = useState('');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('generate');
            const [selectedTheme, setSelectedTheme] = useState(THEMES[0]);
            const [selectedScenario, setSelectedScenario] = useState(THEMES[0].scenarios[0]);
            
            // Feature State
            const [genLevel, setGenLevel] = useState('B1');
            const [genPattern, setGenPattern] = useState('narrative');
            const [genResult, setGenResult] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);

            const [rewriteInput, setRewriteInput] = useState('');
            const [rewriteMode, setRewriteMode] = useState('formal');
            const [rewriteResult, setRewriteResult] = useState(null);
            const [isRewriting, setIsRewriting] = useState(false);

            // QA State
            const [qaMessages, setQaMessages] = useState([]);
            const [qaInput, setQaInput] = useState('');
            const [isQAing, setIsQAing] = useState(false);
            
            // Assistant State
            const [selectedAssistant, setSelectedAssistant] = useState(ASSISTANTS[0]);
            const [chatMessages, setChatMessages] = useState([]);
            const [chatInput, setChatInput] = useState('');
            const [isChatting, setIsChatting] = useState(false);

            // Multimodal State
            const [mmScenario, setMmScenario] = useState(MM_SCENARIOS[0]);
            const [mmData, setMmData] = useState(null);
            const [isMmGen, setIsMmGen] = useState(false);

            // Common
            const [playingId, setPlayingId] = useState(null);
            const [showPromptDebug, setShowPromptDebug] = useState(false);
            const [lastPrompt, setLastPrompt] = useState({ system: "", user: "" });

            // Init
            useEffect(() => {
                const storedKey = localStorage.getItem('hua_yu_api_key');
                const storedMode = localStorage.getItem('hua_yu_app_mode');
                if (storedKey) { setApiKey(storedKey); setAppMode('full'); }
                else if (storedMode === 'trial') { setAppMode('trial'); }
                else { setTimeout(() => setIsSettingsOpen(true), 500); }
            }, []);

            const handleModeSelect = (mode, key) => {
                setAppMode(mode);
                localStorage.setItem('hua_yu_app_mode', mode);
                if (mode === 'full' && key) { setApiKey(key); localStorage.setItem('hua_yu_api_key', key); }
                setIsSettingsOpen(false);
            };

            // Reset Contexts
            useEffect(() => {
                setQaMessages([{ role: 'ai', type: 'text', text: `ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„è¯èªå•ç­”åŠ©æ‰‹ã€‚é‡å°ã€${selectedTheme.name} - ${selectedScenario}ã€‘ï¼Œæœ‰ä»€éº¼æƒ³å•çš„å—ï¼Ÿ` }]);
            }, [selectedTheme, selectedScenario]);

            useEffect(() => {
                setChatMessages([{ role: 'ai', text: selectedAssistant.greeting }]);
            }, [selectedAssistant]);

            // --- Handlers ---

            const handleGenerate = async () => {
                setIsGenerating(true); setGenResult(null);
                try {
                    if (appMode === 'trial') {
                        // Simulate latency
                        await new Promise(r => setTimeout(r, 800));
                        // Call restored Mock Engine
                        const res = generateMockContent(selectedTheme.name, selectedScenario, genLevel, genPattern);
                        setGenResult(res);
                        setRewriteInput(res.content[0].text);
                    } else {
                        // Real API Logic
                        const patternObj = PATTERNS.find(p => p.id === genPattern);
                        const levelDesc = getLevelDesc(genLevel);
                        const sys = `è³‡æ·±è¯èªæ•™å¸«ã€‚è¼¸å‡ºJSON: { "content": [{ "type": "...", "text": "...", "pinyin": "...", "grammar_point": "..." }], "stats": { "estimated_level": "...", "key_vocabulary": [] } }`;
                        const usr = `ä¸»é¡Œ:${selectedTheme.name}, æƒ…å¢ƒ:${selectedScenario}, ç­‰ç´š:${genLevel}, å¥å‹:${patternObj.name}`;
                        const apiRes = await callGeminiAPI(apiKey, usr, sys, true);
                        setGenResult(apiRes);
                        if(apiRes.content?.[0]) setRewriteInput(apiRes.content[0].text);
                    }
                } catch(e) { console.error(e); } finally { setIsGenerating(false); }
            };

            const handleRewrite = async () => { 
                if(!rewriteInput.trim()) return;
                setIsRewriting(true); setRewriteResult(null);
                try {
                    await new Promise(r => setTimeout(r, 1000));
                    if(appMode === 'full') {
                        const sys = `è¯èªç·¨è¼¯ã€‚è¼¸å‡ºJSON: { "text": "...", "analysis": [{"type": "vocab", "text": "..."}], "tone": "..." }`;
                        const res = await callGeminiAPI(apiKey, `æ”¹å¯«ä»»å‹™:${rewriteMode}, æ–‡æœ¬:${rewriteInput}`, sys, true);
                        setRewriteResult(res);
                    } else {
                        setRewriteResult({ text: `(æ¨¡æ“¬æ”¹å¯«) ${rewriteInput}`, analysis: [{type: 'grammar', text: 'æ¨¡æ“¬åˆ†æ...'}], tone: 'æ¨¡æ“¬èªæ°£' });
                    }
                } catch(e) {} finally { setIsRewriting(false); }
            };

            const handleQASend = async (text = qaInput) => {
                if (!text.trim()) return;
                const newMsgs = [...qaMessages, { role: 'user', type: 'text', text }];
                setQaMessages(newMsgs);
                setQaInput('');
                setIsQAing(true);

                try {
                    await new Promise(r => setTimeout(r, 1000));
                    if (appMode === 'trial') {
                        let mockRes = MOCK_QA_DB['default'];
                        for (const key in MOCK_QA_DB) {
                            if (selectedTheme.name.includes(key) || text.includes(key)) mockRes = MOCK_QA_DB[key];
                        }
                        setQaMessages(prev => [...prev, { role: 'ai', type: 'rich', data: mockRes }]);
                    } else {
                        const sys = `è¯èªæ–‡åŒ–å°å¸«ã€‚è¼¸å‡ºJSON: { "answer": "...", "culture_note": "...", "vocabulary": [{ "word": "...", "pinyin": "..." }] }`;
                        const usr = `æƒ…å¢ƒï¼š${selectedTheme.name}-${selectedScenario}ã€‚å•é¡Œï¼š${text}`;
                        const res = await callGeminiAPI(apiKey, usr, sys, true);
                        setQaMessages(prev => [...prev, { role: 'ai', type: 'rich', data: res }]);
                    }
                } catch (e) {
                    setQaMessages(prev => [...prev, { role: 'ai', type: 'text', text: "æŠ±æ­‰ï¼Œç„¡æ³•è™•ç†è«‹æ±‚ã€‚" }]);
                } finally { setIsQAing(false); }
            };

            const handleChatSend = async () => {
                if (!chatInput.trim()) return;
                const newMsgs = [...chatMessages, { role: 'user', text: chatInput }];
                setChatMessages(newMsgs);
                setChatInput('');
                setIsChatting(true);

                try {
                    await new Promise(r => setTimeout(r, 800));
                    if (appMode === 'trial') {
                        const responses = MOCK_CHAT_DB[selectedAssistant.id];
                        const randomRes = getRandom(responses);
                        setChatMessages(prev => [...prev, { role: 'ai', text: randomRes }]);
                    } else {
                        const sys = `${selectedAssistant.prompt_persona} è«‹ä¿æŒç°¡çŸ­ã€‚`;
                        const historyPrompt = newMsgs.map(m => `${m.role==='user'?'å­¸ç”Ÿ':'è€å¸«'}: ${m.text}`).join('\n') + "\nè€å¸«:";
                        const res = await callGeminiAPI(apiKey, historyPrompt, sys, false);
                        setChatMessages(prev => [...prev, { role: 'ai', text: res }]);
                    }
                } catch (e) {
                    setChatMessages(prev => [...prev, { role: 'ai', text: "(é€£ç·šéŒ¯èª¤)" }]);
                } finally { setIsChatting(false); }
            };

            const handleMmGenerate = async () => {
                setIsMmGen(true); setMmData(null);
                try {
                    await new Promise(r => setTimeout(r, 1500));
                    if (appMode === 'trial') {
                        const res = generateMockMMScript(mmScenario.title, genLevel);
                        setMmData(res);
                    } else {
                        const sys = `ç·¨åŠ‡ã€‚è¼¸å‡ºJSON: { "script": [ { "speaker": "A", "text": "..." } ], "visual_tags": [], "culture_note": "..." }`;
                        const usr = `æƒ…å¢ƒã€Œ${mmScenario.title}ã€ã€‚ç­‰ç´š${genLevel}ã€‚`;
                        const res = await callGeminiAPI(apiKey, usr, sys, true);
                        setMmData(res);
                    }
                } catch(e) { alert("ç”Ÿæˆå¤±æ•—"); } finally { setIsMmGen(false); }
            };

            // --- Render Logic ---
            return (
                <div className="min-h-screen flex flex-col font-sans">
                    <ModeSelectionModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} onSelectMode={handleModeSelect} currentKey={apiKey} />

                    {/* Navbar */}
                    <header className="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setActiveTab('generate')}>
                                <div className="w-9 h-9 bg-[#FFB347] rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-sm">è¯</div>
                                <div className="flex flex-col">
                                    <span className="text-lg font-bold tracking-tight text-[#006699] leading-tight">è¯èªAIç™¾å¯¶ç®±

{/* å›é¦–é æŒ‰éˆ• (Reactå¯«æ³•) */}
<a href="index.html" className="flex items-center gap-2 mr-4 text-slate-600 hover:text-orange-500 font-bold no-underline">
    <span className="text-xl">ğŸ </span>
    <span className="hidden md:inline">å›é¦–é </span>
</a>
</span>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] text-gray-400 font-medium tracking-wider">v6.3 Full Restoration</span>
                                        {appMode === 'trial' ? <span className="text-[10px] bg-emerald-100 text-emerald-700 px-1.5 rounded flex items-center gap-1"><Rocket size={10}/> é«”é©—ç‰ˆ</span> : <span className="text-[10px] bg-blue-100 text-blue-700 px-1.5 rounded flex items-center gap-1"><Gem size={10}/> æ­£å¼ç‰ˆ</span>}
                                    </div>
                                </div>
                            </div>
                            <nav className="hidden md:flex items-center gap-1">
                                {[{ id: 'generate', label: 'æ–‡æœ¬ç”Ÿæˆ', icon: PenTool }, { id: 'rewrite', label: 'æ–‡æœ¬æ”¹å¯«', icon: RefreshCw }, { id: 'qa', label: 'å•ç­”å»¶ä¼¸', icon: MessageCircle }, { id: 'assistant', label: 'AIåŠ©æ•™', icon: Bot }, { id: 'multimodal', label: 'å¤šæ¨¡æ…‹', icon: Headphones }].map((item) => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className={`px-3 py-2 rounded-md flex items-center gap-2 text-sm font-medium transition-all ${activeTab === item.id ? 'bg-[#006699] text-white shadow-md scale-105' : 'text-gray-600 hover:bg-gray-100'}`}><item.icon size={16}/> {item.label}</button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setIsSettingsOpen(true)} className={`flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${appMode === 'full' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-emerald-50 text-emerald-600 border-emerald-200'}`}><Settings size={14}/> {appMode === 'full' ? 'æ­£å¼ç‰ˆè¨­å®š' : 'åˆ‡æ›æ¨¡å¼'}</button>
                            </div>
                        </div>
                    </header>

                    {/* Main Workspace */}
                    <main className="max-w-7xl mx-auto px-4 py-6 flex-1 w-full grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-0 pb-24">
                        {/* Sidebar */}
                        <div className="lg:col-span-3 flex flex-col gap-4 animate-fade-in">
                            {activeTab === 'multimodal' ? (
                                <Card title="é¸æ“‡æƒ…å¢ƒ (Visual Context)" icon={Eye} className="h-full">
                                    <div className="grid grid-cols-2 gap-2">
                                        {MM_SCENARIOS.map(s => (
                                            <button 
                                                key={s.id} 
                                                onClick={() => { setMmScenario(s); setMmData(null); }} 
                                                className={`p-2 rounded-lg text-left flex flex-col items-center justify-center gap-1 transition-all ${mmScenario.id === s.id ? 'bg-[#FFF4E6] border-2 border-[#FFB347] shadow-sm' : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'}`}
                                            >
                                                <span className="text-2xl">{s.icon}</span>
                                                <span className="text-xs font-bold text-gray-700">{s.title}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <div className="mt-4 p-3 bg-blue-50 rounded-lg text-xs text-gray-600">
                                        <div className="font-bold text-[#006699] mb-1">æƒ…å¢ƒèªªæ˜ï¼š</div>
                                        {mmScenario.desc}
                                    </div>
                                </Card>
                            ) : activeTab === 'generate' || activeTab === 'qa' ? (
                                <>
                                    <Card title="é¸æ“‡ä¸»é¡Œ" icon={BookOpen} className="min-h-[500px] md:h-full">
                                        <div className="grid gap-1">
                                            {THEMES.map(t => <button key={t.id} onClick={() => setSelectedTheme(t)} className={`px-3 py-2 rounded-lg text-left flex items-center gap-2 ${selectedTheme.id === t.id ? 'bg-[#FFF4E6] text-[#b37400] font-bold border-l-4 border-[#FFB347]' : 'hover:bg-gray-50'}`}><span>{t.icon}</span><span>{t.name}</span></button>)}
                                        </div>
                                    </Card>
                                    <Card className="flex-1">
                                        <div className="mb-2 text-xs font-bold text-gray-400">ç›®å‰ä¸»é¡Œï¼š{selectedTheme.name}</div>
                                        <div className="grid gap-1">{selectedTheme.scenarios.map((s, i) => <button key={i} onClick={() => setSelectedScenario(s)} className={`px-3 py-2 rounded text-left text-sm ${selectedScenario === s ? 'bg-[#006699] text-white' : 'hover:bg-gray-50'}`}>{s}</button>)}</div>
                                    </Card>
                                </>
                            ) : activeTab === 'rewrite' ? (
                                <Card title="æ”¹å¯«æ­·å²" icon={RefreshCw} className="min-h-[500px] md:h-full"><div className="text-sm text-gray-500 text-center py-4">æ”¹å¯«ç´€éŒ„å°‡é¡¯ç¤ºæ–¼æ­¤</div></Card>
                            ) : (
                                <Card title="é¸æ“‡åŠ©æ•™" icon={Bot} className="h-full">
                                    <div className="space-y-3">
                                        {ASSISTANTS.map(ast => (
                                            <button key={ast.id} onClick={() => setSelectedAssistant(ast)} className={`w-full p-3 rounded-xl border-2 text-left transition-all ${selectedAssistant.id === ast.id ? `border-current ${ast.color.split(' ')[0]}` : 'border-gray-100 hover:border-gray-200'}`}>
                                                <div className="text-2xl mb-1">{ast.avatar}</div>
                                                <div className="font-bold text-gray-800">{ast.name}</div>
                                                <div className="text-xs text-gray-500">{ast.style}</div>
                                            </button>
                                        ))}
                                    </div>
                                </Card>
                            )}
                        </div>

                        {/* Content Area */}
                        <div className="lg:col-span-9 flex flex-col gap-6 animate-fade-in" style={{animationDelay: '0.1s'}}>
                            
                            {/* --- 1. Generate View --- */}
                            {activeTab === 'generate' && (
                                <Card className="min-h-[500px] md:h-full">
                                    <div className="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                                        <div><h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Zap className="text-[#FFB347]" size={20}/> æ™ºèƒ½æ–‡æœ¬ç”Ÿæˆ</h2><div className="text-sm text-gray-500 mt-1 flex items-center gap-1">{selectedTheme.name} <ChevronRight size={12}/> {selectedScenario}</div></div>
                                        <div className="flex gap-1 bg-gray-100 p-1 rounded-lg">{LEVELS.map(l => <button key={l} onClick={() => setGenLevel(l)} className={`px-3 py-1 rounded text-sm font-bold ${genLevel === l ? 'bg-white text-[#006699] shadow-sm' : 'text-gray-400'}`}>{l}</button>)}</div>
                                    </div>
                                    <div className="grid grid-cols-4 gap-3 mb-6">{PATTERNS.map(p => <div key={p.id} onClick={() => setGenPattern(p.id)} className={`p-3 rounded-lg border cursor-pointer ${genPattern === p.id ? 'border-[#FFB347] bg-[#FFF9F2]' : 'border-gray-100'}`}><div className="font-bold text-sm">{p.name}</div><div className="text-xs text-gray-500">{p.desc}</div></div>)}</div>
                                    <div className="flex justify-end gap-3 mb-4"><Button variant="ghost" onClick={() => setGenResult(null)}>æ¸…é™¤</Button><Button onClick={handleGenerate} disabled={isGenerating} className="w-48" variant={appMode === 'trial' ? 'trial' : 'primary'}>{isGenerating ? <><Loader2 className="animate-spin mr-2" size={16}/> ç”Ÿæˆä¸­...</> : appMode === 'trial' ? 'ğŸš€ é«”é©—ç‰ˆç”Ÿæˆ' : 'âœ¨ AI æ™ºèƒ½ç”Ÿæˆ'}</Button></div>
                                    <div className="bg-gray-50 rounded-xl p-6 flex-1 overflow-auto border border-gray-200 min-h-[300px]">
                                        {genResult ? <div className="space-y-4 animate-fade-in">{genResult.content.map((item, idx) => <div key={idx} className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 hover:border-[#FFB347] group"><div className="flex justify-between mb-2"><span className="text-[10px] bg-orange-50 text-[#b37400] px-2 py-0.5 rounded font-bold">{item.type}</span><div className="flex gap-2 opacity-60 hover:opacity-100 transition-opacity"><button className="text-gray-400 hover:text-[#006699]" onClick={() => {setRewriteInput(item.text); setActiveTab('rewrite');}}><RefreshCw size={14}/></button></div></div><div className="text-lg font-medium text-gray-800 mb-1">{item.text}</div><div className="text-sm text-gray-400 font-mono mb-2">{item.pinyin}</div><div className="inline-flex items-center gap-1 text-xs text-[#006699] bg-blue-50 px-2 py-1 rounded"><Zap size={10}/> {item.grammar_point}</div></div>)}</div> : <div className="h-full flex flex-col items-center justify-center text-gray-400"><Bot size={48} className="mb-2 opacity-20"/><p>è«‹é¸æ“‡è¨­å®šä¸¦é–‹å§‹ç”Ÿæˆ ({appMode === 'trial' ? 'Deep Mock Engine' : 'Gemini Engine'})</p></div>}
                                    </div>
                                </Card>
                            )}

                            {/* --- 2. Rewrite View --- */}
                            {activeTab === 'rewrite' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                                    <Card title="åŸå§‹æ–‡æœ¬è¼¸å…¥" icon={FileText} className="min-h-[500px] md:h-full">
                                        <div className="flex flex-col h-full gap-4"><textarea className="w-full flex-1 p-4 bg-gray-50 rounded-lg border-none resize-none focus:ring-2 focus:ring-[#006699]" placeholder="è¼¸å…¥æ–‡å­—..." value={rewriteInput} onChange={e => setRewriteInput(e.target.value)}/><Button onClick={handleRewrite} disabled={isRewriting} variant={appMode==='trial'?'trial':'primary'}>{isRewriting ? 'è™•ç†ä¸­...' : 'é–‹å§‹æ”¹å¯«'}</Button></div>
                                    </Card>
                                    <Card title="AI æ”¹å¯«åˆ†æ" icon={Sparkles} className="h-full border-[#FFB347]/30">
                                        <div className="h-full relative">{rewriteResult ? <div className="bg-[#FFF9F2] p-5 rounded-xl border border-[#FFB347]/20 shadow-sm animate-fade-in"><div className="font-bold text-[#b37400] mb-2 flex items-center gap-1"><Star size={12} fill="currentColor"/> æ”¹å¯«çµæœ ({rewriteResult.tone})</div><div className="text-xl font-bold text-gray-800 leading-relaxed">{rewriteResult.text}</div></div> : <div className="h-full flex flex-col items-center justify-center text-gray-300"><ArrowRight size={48} className="mb-4 opacity-20"/><p>ç­‰å¾…è¼¸å…¥...</p></div>}</div>
                                    </Card>
                                </div>
                            )}

                            {/* --- 3. QA View --- */}
                            {activeTab === 'qa' && (
                                <Card title={`å•ç­”åŠ©æ‰‹ï¼š${selectedTheme.name}`} icon={MessageCircle} className="min-h-[500px] md:h-full" noPadding>
                                    <div className="flex-1 p-4 overflow-y-auto space-y-6">
                                        {qaMessages.map((msg, i) => (
                                            <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                {msg.role === 'ai' && <div className="w-8 h-8 rounded-full bg-[#FFB347] flex items-center justify-center text-white mr-2 mt-1 shadow-sm"><Bot size={16}/></div>}
                                                <div className={`max-w-[85%] ${msg.role === 'user' ? 'ml-auto' : ''}`}>
                                                    {msg.type === 'text' ? <div className={`p-4 rounded-2xl shadow-sm text-sm ${msg.role === 'user' ? 'bg-[#006699] text-white rounded-br-none' : 'bg-white text-gray-700 border border-gray-200 rounded-bl-none'}`}>{msg.text}</div> : 
                                                    <div className="bg-white rounded-2xl rounded-bl-none border border-gray-200 shadow-md overflow-hidden animate-fade-in"><div className="bg-[#FFF9F2] p-4 border-b border-[#FFB347]/10"><h4 className="font-bold text-gray-800 mb-2 flex items-center gap-2"><CheckCircle2 size={16} className="text-green-500"/> å›ç­”</h4><p className="text-gray-700 text-sm leading-relaxed">{msg.data.answer}</p></div><div className="p-4 grid gap-4"><div><h5 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex items-center gap-1"><Globe size={12}/> æ–‡åŒ–å°è£œå¸–</h5><div className="bg-gray-50 p-3 rounded-lg text-sm text-gray-600 border border-gray-100">{msg.data.culture_note}</div></div></div></div>}
                                                </div>
                                            </div>
                                        ))}
                                        {isQAing && <div className="flex justify-start"><div className="bg-gray-100 p-3 rounded-2xl text-gray-400 text-sm animate-pulse">Thinking...</div></div>}
                                    </div>
                                    <div className="p-4 bg-white border-t border-gray-100 flex gap-2"><input type="text" value={qaInput} onChange={(e) => setQaInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleQASend()} placeholder="è¼¸å…¥å•é¡Œ..." className="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-[#006699] focus:ring-1 focus:ring-[#006699] shadow-inner"/><Button onClick={() => handleQASend()} disabled={isQAing} className="rounded-full w-10 h-10 p-0 shadow-lg"><Send size={18}/></Button></div>
                                </Card>
                            )}

                            {/* --- 4. Assistant View --- */}
                            {activeTab === 'assistant' && (
                                <Card className={`h-full border-t-4 ${selectedAssistant.id==='wang' ? 'border-blue-500' : 'border-orange-500'}`} noPadding>
                                    <div className="bg-white p-4 border-b border-gray-100 flex items-center gap-3">
                                        <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl border-2 border-white shadow-sm ${selectedAssistant.color}`}>{selectedAssistant.avatar}</div>
                                        <div><div className="font-bold text-gray-800">{selectedAssistant.name}</div><div className="text-xs text-gray-500">{selectedAssistant.style}</div></div>
                                    </div>
                                    <div className="flex-1 p-6 overflow-y-auto space-y-6 bg-[#f8f9fa]">
                                        {chatMessages.map((msg, i) => (
                                            <div key={i} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                                {msg.role === 'ai' && <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm">{selectedAssistant.avatar}</div>}
                                                <div className={`max-w-[70%] p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === 'user' ? 'bg-gray-800 text-white' : 'bg-white text-gray-700 border border-gray-200'}`}>{msg.text}</div>
                                            </div>
                                        ))}
                                        {isChatting && <div className="flex gap-3"><div className="w-8 h-8 rounded-full bg-gray-200"/><div className="bg-gray-100 p-3 rounded-2xl text-xs text-gray-400">Typing...</div></div>}
                                    </div>
                                    <div className="p-4 bg-white border-t border-gray-200 relative"><input type="text" value={chatInput} onChange={(e) => setChatInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleChatSend()} placeholder={`å‚³é€è¨Šæ¯çµ¦${selectedAssistant.name}...`} className="w-full bg-gray-100 rounded-xl px-4 py-3 pr-12 focus:outline-none focus:bg-white focus:ring-2 focus:ring-[#006699] transition-all"/><button onClick={handleChatSend} disabled={isChatting} className="absolute right-6 top-6 p-1.5 text-gray-400 hover:text-[#006699]"><Send size={20}/></button></div>
                                </Card>
                            )}

                            {/* --- 5. Multimodal View --- */}
                            {activeTab === 'multimodal' && (
                                <div className="grid grid-cols-12 gap-6 h-full">
                                    <div className="col-span-8 flex flex-col gap-6">
                                        <Card className="flex-1 bg-black text-white relative flex items-center justify-center overflow-hidden group border-0 shadow-xl">
                                            <img key={mmScenario.id} src={`https://source.unsplash.com/800x600/?${mmScenario.keyword},taiwan`} alt="Context" className="absolute inset-0 w-full h-full object-cover opacity-70 animate-ken-burns transition-opacity duration-1000"/>
                                            <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"/>
                                            <div className="z-20 text-center px-8 relative">
                                                <div className="inline-block p-4 rounded-full bg-white/10 backdrop-blur-md mb-4 border border-white/20 text-4xl shadow-lg animate-fade-in">{mmScenario.icon}</div>
                                                <h2 className="text-4xl font-bold mb-2 text-white drop-shadow-md tracking-wide">{mmScenario.title}</h2>
                                                <p className="text-gray-200 text-lg mb-8 font-light">{mmScenario.prompt}</p>
                                                {!mmData ? <Button onClick={handleMmGenerate} disabled={isMmGen} className="mx-auto bg-[#FFB347] hover:bg-[#ff9f1a] text-gray-900 border-0 shadow-[0_0_20px_rgba(255,179,71,0.5)] transition-all hover:scale-105 px-8 py-3 text-lg font-bold">{isMmGen ? <><Loader2 className="animate-spin mr-2"/> åˆ†ææƒ…å¢ƒä¸­...</> : <><Camera className="mr-2" size={20}/> æ‹æ”æƒ…å¢ƒ & ç”Ÿæˆæ•™æ</>}</Button> : <div className="animate-fade-in flex gap-3 justify-center"><Button onClick={() => setMmData(null)} className="bg-white/20 hover:bg-white/30 text-white border-white/50 backdrop-blur-md">é‡æ–°æ‹æ”</Button></div>}
                                            </div>
                                        </Card>
                                        <Card title={mmData ? "AI ç”Ÿæˆå­¸ç¿’å…§å®¹ (Generated Content)" : "ç­‰å¾…ç”Ÿæˆ..."} icon={FileText} className="h-1/2 overflow-hidden">
                                            {mmData ? (
                                                <div className="h-full flex flex-col animate-fade-in">
                                                    <div className="flex gap-2 mb-4 overflow-x-auto p-1">{mmData.visual_tags?.map((tag, i) => <span key={i} className="text-xs bg-blue-50 text-[#006699] px-2 py-1 rounded-full border border-blue-100 flex items-center gap-1 whitespace-nowrap"><Eye size={10}/> {tag}</span>)}</div>
                                                    <div className="flex-1 overflow-y-auto space-y-4 pr-2">{mmData.script.map((line, i) => <div key={i} className="flex gap-4 p-3 rounded-lg hover:bg-gray-50 transition-colors"><div className={`font-bold w-12 shrink-0 text-right ${line.speaker.includes('æˆ‘') || line.speaker==='A' ? 'text-[#006699]' : 'text-[#FFB347]'}`}>{line.speaker}</div><div className="text-gray-700 text-lg leading-relaxed">{line.text}</div></div>)}</div>
                                                    {mmData.culture_note && <div className="mt-4 p-3 bg-[#FFF4E6] rounded-lg border border-[#FFB347]/30 text-sm text-[#b37400] flex gap-2"><Lightbulb size={16} className="shrink-0 mt-0.5"/><div>{mmData.culture_note}</div></div>}
                                                </div>
                                            ) : <div className="h-full flex flex-col items-center justify-center text-gray-300"><ImageIcon size={48} className="mb-4 opacity-20"/><p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼ŒAI å°‡ç‚ºæ‚¨ç”Ÿæˆæƒ…å¢ƒå°è©±</p></div>}
                                        </Card>
                                    </div>
                                    <div className="col-span-4 flex flex-col gap-4">
                                        <Card title="é›£åº¦è¨­å®š" icon={Settings}>
                                            <div className="flex gap-2 flex-wrap">{LEVELS.map(l => <button key={l} onClick={() => setGenLevel(l)} className={`flex-1 py-1.5 px-2 rounded text-sm font-bold border transition-all ${genLevel === l ? 'bg-[#006699] text-white border-[#006699]' : 'bg-white text-gray-500 border-gray-200 hover:border-gray-400'}`}>{l}</button>)}</div>
                                        </Card>
                                        <Card title="æƒ…å¢ƒè¨­ç½®" icon={Sliders} className="flex-1">
                                            <div className="space-y-4">
                                                <div><label className="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">é¡¯ç¤ºæ¨¡å¼</label><div className="flex bg-gray-100 p-1 rounded-lg"><button className="flex-1 py-1.5 rounded-md text-xs font-bold bg-white text-gray-800 shadow-sm">åœ–æ–‡ä¸¦èŒ‚</button><button className="flex-1 py-1.5 rounded-md text-xs font-bold text-gray-500 hover:text-gray-700">ç´”è½åŠ›</button></div></div>
                                                <div className="pt-4 border-t border-gray-100"><label className="text-xs font-bold text-gray-500 mb-2 block uppercase tracking-wider">èªé€Ÿ</label><input type="range" min="0.5" max="1.5" step="0.1" defaultValue="1" className="w-full accent-[#006699] h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"/><div className="flex justify-between text-[10px] text-gray-400 mt-1"><span>0.5x</span><span>Normal</span><span>1.5x</span></div></div>
                                                <div className="pt-4 border-t border-gray-100 space-y-2"><Button variant="outline" className="w-full justify-start" disabled={!mmData}><Volume2 size={16} className="mr-2"/> æ’­æ”¾å®Œæ•´å°è©±</Button><Button variant="outline" className="w-full justify-start" disabled={!mmData}><Mic size={16} className="mr-2"/> è·Ÿè®€ç·´ç¿’ (éŒ„éŸ³)</Button></div>
                                            </div>
                                        </Card>
                                    </div>
                                </div>
                            )}

                        </div>
                    </main>


{/* === æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°è¦½åˆ— (Page 3) === */}
<div className="lg:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 flex justify-around items-center p-2 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
    {[
        { id: 'generate', label: 'ç”Ÿæˆ', icon: PenTool },
        { id: 'rewrite', label: 'æ”¹å¯«', icon: RefreshCw },
        { id: 'qa', label: 'å•ç­”', icon: MessageCircle },
        { id: 'assistant', label: 'åŠ©æ•™', icon: Bot },
        { id: 'multimodal', label: 'å¤šæ¨¡æ…‹', icon: Headphones }
    ].map((item) => (
        <button 
            key={item.id} 
            onClick={() => setActiveTab(item.id)} 
            className={`flex flex-col items-center justify-center w-full py-1 ${activeTab === item.id ? 'text-[#006699]' : 'text-gray-400'}`}
        >
            <item.icon size={20} />
            <span className="text-[10px] mt-1 font-medium">{item.label}</span>
        </button>
    ))}
</div>



                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<HuaYuAIApp />);
    </script>
</body>
</html>